File Inclusion lÃ  gÃ¬?
Nhiá»u ngÃ´n ngá»¯ backend nhÆ° PHP, JavaScript (Node.js), Java cho phÃ©p dÃ¹ng tham sá»‘ HTTP (GET/POST parameter) Ä‘á»ƒ chá»‰ Ä‘á»‹nh ná»™i dung hiá»ƒn thá»‹ trÃªn web.

Má»¥c Ä‘Ã­ch:
  Táº¡o trang web Ä‘á»™ng (dynamic pages).
  GiÃºp giáº£m kÃ­ch thÆ°á»›c code.
  TÃ¡i sá»­ dá»¥ng code, dá»… báº£o trÃ¬ hÆ¡n.

VÃ­ dá»¥ trong PHP:
  <?php
    $page = $_GET['page'];
    include($page . ".php");
  ?>
    á» Ä‘Ã¢y, tham sá»‘ page sáº½ quyáº¿t Ä‘á»‹nh file nÃ o Ä‘Æ°á»£c include.

VÃ­ dá»¥:
  http://example.com/index.php?page=../../../../etc/passwd
    â†’ Hacker cÃ³ thá»ƒ Ä‘á»c file /etc/passwd trÃªn mÃ¡y chá»§.

KhÃ¡i niá»‡m chung
  File Inclusion: Khi á»©ng dá»¥ng web cho phÃ©p táº£i file Ä‘á»™ng dá»±a trÃªn tham sá»‘ HTTP (GET/POST).
  Náº¿u khÃ´ng kiá»ƒm soÃ¡t, hacker cÃ³ thá»ƒ chá»‰ Ä‘á»‹nh file tÃ¹y Ã½ â†’ Local File Inclusion (LFI) hoáº·c Remote File Inclusion (RFI)


Nguy cÆ¡ tá»« LFI
  LFI cÃ³ thá»ƒ dáº«n tá»›i rÃ² rá»‰ mÃ£ nguá»“n, lá»™ dá»¯ liá»‡u nháº¡y cáº£m, vÃ  tháº­m chÃ­ thá»±c thi mÃ£ tá»« xa trong má»™t sá»‘ Ä‘iá»u kiá»‡n nháº¥t Ä‘á»‹nh.
  RÃ² rá»‰ mÃ£ nguá»“n cho phÃ©p káº» táº¥n cÃ´ng phÃ¢n tÃ­ch code Ä‘á»ƒ tÃ¬m ra cÃ¡c lá»— há»•ng khÃ¡c, cÃ³ thá»ƒ lÃ  nhá»¯ng lá»— há»•ng chÆ°a tá»«ng Ä‘Æ°á»£c biáº¿t Ä‘áº¿n.
  RÃ² rá»‰ dá»¯ liá»‡u nháº¡y cáº£m cÃ³ thá»ƒ giÃºp káº» táº¥n cÃ´ng liá»‡t kÃª thÃ´ng tin vá» server tá»« xa, hoáº·c lá»™ ra thÃ´ng tin Ä‘Äƒng nháº­p vÃ  khÃ³a Ä‘á»ƒ truy cáº­p trá»±c tiáº¿p vÃ o server.
  Trong nhá»¯ng Ä‘iá»u kiá»‡n Ä‘áº·c biá»‡t, LFI cÃ³ thá»ƒ bá»‹ lá»£i dá»¥ng Ä‘á»ƒ thá»±c thi mÃ£ trÃªn server, tá»« Ä‘Ã³ chiáº¿m quyá»n kiá»ƒm soÃ¡t toÃ n bá»™ há»‡ thá»‘ng backend vÃ  cáº£ cÃ¡c server liÃªn káº¿t vá»›i nÃ³.


VÃ­ dá»¥ code dá»… dÃ­nh LFI

PHP:
  if (isset($_GET['language'])) {
      include($_GET['language']);
  }
  â†’ Truyá»n giÃ¡ trá»‹ tÃ¹y Ã½ vÃ o language sáº½ load file Ä‘Ã³.
  â†’ CÃ¡c hÃ m nguy hiá»ƒm: include(), require(), file_get_contents(), â€¦

NodeJS:
  fs.readFile(path.join(__dirname, req.query.language), ...);
  â†’ Tham sá»‘ language Ä‘i tháº³ng vÃ o hÃ m Ä‘á»c file.

Java (JSP):
  <jsp:include file="<%= request.getParameter('language') %>" />
hoáº·c
  <c:import url= "<%= request.getParameter('language') %>"/>


.NET:
  Response.WriteFile(HttpContext.Request.Query["language"]);
  @Html.Partial(HttpContext.Request.Query["language"]);
  <!--#include file="<% HttpContext.Request.Query['language'] %>"-->

Read vs Execute
| NgÃ´n ngá»¯   | HÃ m/Function                   | Read Content   | Execute  | Remote URL  |
| ---------- | ------------------------------ | ------------   | -------  | ----------  |
| **PHP**    | `include()` / `include_once()` | âœ…            | âœ…       | âœ…          |
|            | `require()` / `require_once()` | âœ…            | âœ…       | âŒ          |
|            | `file_get_contents()`          | âœ…            | âŒ       | âœ…          |
|            | `fopen()` / `file()`           | âœ…            | âŒ       | âŒ          |
| **NodeJS** | `fs.readFile()`                | âœ…            | âŒ       | âŒ          |
|            | `fs.sendFile()`                | âœ…            | âŒ       | âŒ          |
|            | `res.render()`                 | âœ…            | âœ…       | âŒ          |
| **Java**   | `include`                      | âœ…            | âŒ       | âŒ          |
|            | `import`                       | âœ…            | âœ…       | âœ…          |
| **.NET**   | `@Html.Partial()`              | âœ…            | âŒ       | âŒ          |
|            | `@Html.RemotePartial()`        | âœ…            | âŒ       | âœ…          |
|            | `Response.WriteFile()`         | âœ…            | âŒ       | âŒ          |
|            | `include`                      | âœ…            | âœ…       | âœ…          |


ğŸ—ï¸ Nháº­n xÃ©t
  Read only: chá»‰ Ä‘á»c ná»™i dung file â†’ lá»™ source code, config.
  Execute: thá»±c thi luÃ´n file â†’ nguy cÆ¡ RCE.
  Remote URL: náº¿u hÃ m há»— trá»£, cÃ³ thá»ƒ bá»‹ Remote File Inclusion (RFI) (load file tá»« ngoÃ i Internet).

ğŸ‘‰ CÃ¡c hÃ m nguy hiá»ƒm nháº¥t:
  PHP: include, include_once, require, require_once.
  Java: import.
  .NET: include.



Second-Order Attacks (Táº¥n cÃ´ng LFI báº­c hai)
  Äá»‹nh nghÄ©a: LFI giÃ¡n tiáº¿p, dá»¯ liá»‡u Ä‘á»™c háº¡i lÆ°u vÃ o DB rá»“i Ä‘Æ°á»£c dÃ¹ng láº¡i Ä‘á»ƒ load file.
  
  VÃ­ dá»¥:
  /profile/$username/avatar.png
  username = ../../../etc/passwd
  â†’ táº£i nháº§m /etc/passwd thay vÃ¬ avatar.
  
  CÆ¡ cháº¿:
  Poison DB (Ä‘Äƒng kÃ½ username payload).
  App dÃ¹ng láº¡i dá»¯ liá»‡u Ä‘Ã³ Ä‘á»ƒ load file.
  LÃ½ do nguy hiá»ƒm: Dev thÆ°á»ng lá»c input trá»±c tiáº¿p nhÆ°ng tin tÆ°á»Ÿng dá»¯ liá»‡u trong DB.

    [User input] ---> [DB lÆ°u payload] ---> [Chá»©c nÄƒng khÃ¡c load file] ---> [LFI]



Äá»‘i vá»›i cÃ¡ch ngÄƒn cháº·n 
$language = str_replace('../', '', $_GET['language']);
  -> bypass báº±ng cÃ¡ch nÃ y  ....//

CÆ¡ cháº¿ Appended Extension
 Giáº£ sá»­ code: include($_GET['file'] . ".php");
  Má»™t sá»‘ web app tá»± Ä‘á»™ng ná»‘i thÃªm Ä‘uÃ´i file (vÃ­ dá»¥: .php) vÃ o tham sá»‘ user nháº­p.
  Má»¥c Ä‘Ã­ch: Ä‘áº£m báº£o chá»‰ include file .php.
    VÃ­ dá»¥:
    ?language=english   â†’   english.php
  
  Háº¡n cháº¿: ngÄƒn attacker load file khÃ¡c Ä‘uÃ´i .php.
  NhÆ°ng: váº«n cÃ³ thá»ƒ há»¯u Ã­ch (Ä‘á»c source code .php).
    CÃ¡c ká»¹ thuáº­t bypass cÅ© (PHP < 5.3/5.4).
        PHP cÅ© cÃ³ giá»›i háº¡n chuá»—i 4096 kÃ½ tá»±. Chuá»—i dÃ i hÆ¡n â†’ bá»‹ cáº¯t bá»›t.
        Input : non_existing_directory/../../../etc/passwd/././././...[4090 kÃ½ tá»±]....../test.php
            naruto3co@htb[/htb]$ echo -n "non_existing_directory/../../../etc/passwd/" && for i in {1..2048}; do echo -n "./"; done
            non_existing_directory/../../../etc/passwd/./././<SNIP>././././
          Pháº§n thá»«a /test.php sáº½ bá»‹ cáº¯t bá» 
    CÃ¡c ká»¹ thuáº­t bypass cÅ© (PHP < 5.5).
      DÃ¹ng %00 cháº·n pháº§n .php.
      Payload: /etc/passwd%00 â†’ thÃ nh /etc/passwd.
  TrÃªn PHP má»›i: khÃ´ng bypass Ä‘Æ°á»£c.























