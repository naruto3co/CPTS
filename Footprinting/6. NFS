NFS ( network file system )

  - c√≥ c√πng m·ª•c ƒë√≠ch v·ªõi SMB.
  - M·ª•c ƒë√≠ch c·ªßa n√≥ l√† truy c·∫≠p v√†o c√°c h·ªá th·ªëng t·ªáp qua m·∫°ng nh∆∞ th·ªÉ ch√∫ng l√† ·ªï ƒëƒ©a c·ª•c b·ªô. Tuy nhi√™n, NFS s·ª≠ d·ª•ng m·ªôt giao th·ª©c ho√†n to√†n kh√°c.
  - NFS th∆∞·ªùng ƒë∆∞·ª£c d√πng gi·ªØa c√°c h·ªá th·ªëng Linux v√† Unix. ƒêi·ªÅu n√†y c√≥ nghƒ©a l√† c√°c m√°y kh√°ch NFS kh√¥ng th·ªÉ giao ti·∫øp tr·ª±c ti·∫øp v·ªõi c√°c m√°y ch·ªß SMB.
  - NFS l√† m·ªôt ti√™u chu·∫©n Internet ƒëi·ªÅu ch·ªânh c√°c th·ªß t·ª•c trong h·ªá th·ªëng t·ªáp ph√¢n t√°n.
  - Trong khi NFS phi√™n b·∫£n 3.0 (NFSv3), v·ªën ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng trong nhi·ªÅu nƒÉm, x√°c th·ª±c m√°y t√≠nh kh√°ch (client computer), th√¨ ƒëi·ªÅu n√†y thay ƒë·ªïi ·ªü NFSv4. ·ªû ƒë√¢y, c≈©ng gi·ªëng nh∆∞ giao th·ª©c SMB c·ªßa Windows, ng∆∞·ªùi d√πng (user) ph·∫£i ƒë∆∞·ª£c x√°c th·ª±c.
  
  L∆∞u √Ω : 
    NFSv3 vs NFSv4
      NFSv3: ch·ªâ x√°c th·ª±c m√°y t√≠nh client ‚Üí nghƒ©a l√† n·∫øu m·ªôt m√°y ƒë∆∞·ª£c tin t∆∞·ªüng, th√¨ coi t·∫•t c·∫£ user tr√™n m√°y ƒë√≥ ƒë·ªÅu ƒë∆∞·ª£c ph√©p.
      NFSv4: n√¢ng cao b·∫£o m·∫≠t ‚Üí gi·ªëng SMB c·ªßa Windows, y√™u c·∫ßu x√°c th·ª±c t·ª´ng user thay v√¨ ch·ªâ x√°c th·ª±c m√°y.
    
    ·ª®ng d·ª•ng th·ª±c t·∫ø
      Trong doanh nghi·ªáp, NFS ƒë∆∞·ª£c d√πng ƒë·ªÉ chia s·∫ª th∆∞ m·ª•c gi·ªØa nhi·ªÅu server Linux/Unix.
      Nh∆∞ng n·∫øu b·∫°n c√≥ h·ªá th·ªëng h·ªón h·ª£p Windows ‚Üî Linux, th∆∞·ªùng ph·∫£i c√†i th√™m ph·∫ßn m·ªÅm h·ªó tr·ª£ ho·∫∑c d√πng Samba (chuy·ªÉn ƒë·ªïi SMB).
  
  NFSv2: ƒë∆°n gi·∫£n, c·ªï ƒëi·ªÉn, UDP.
  NFSv3: file l·ªõn h∆°n, b√°o l·ªói t·ªët, nh∆∞ng v·∫´n stateless.
  NFSv4: hi·ªán ƒë·∫°i, b·∫£o m·∫≠t (Kerberos), stateful, ch·ªâ c·∫ßn 1 c·ªïng (2049).
  NFSv4.1: m·ªü r·ªông cho cluster, h·ªó tr·ª£ song song (pNFS) v√† multipath.
  
  
  - NFS ƒë∆∞·ª£c x√¢y d·ª±ng d·ª±a tr√™n Open Network Computing Remote Procedure Call (ONC-RPC / SUN-RPC),
  - giao th·ª©c n√†y l·ªô ra tr√™n c√°c c·ªïng TCP v√† UDP 111 v√† s·ª≠ d·ª•ng External Data Representation (XDR) ƒë·ªÉ trao ƒë·ªïi d·ªØ li·ªáu m·ªôt c√°ch ƒë·ªôc l·∫≠p h·ªá th·ªëng
  - Giao th·ª©c NFS kh√¥ng c√≥ c∆° ch·∫ø x√°c th·ª±c (authentication) hay ph√¢n quy·ªÅn (authorization).
  - Vi·ªác x√°c th·ª±c ho√†n to√†n ph·ª• thu·ªôc v√†o c√°c t√πy ch·ªçn c·ªßa giao th·ª©c RPC
    - ƒê√¢y l√† l√Ω do v√¨ sao NFS ch·ªâ n√™n ƒë∆∞·ª£c d√πng v·ªõi ph∆∞∆°ng th·ª©c x√°c th·ª±c n√†y trong c√°c m·∫°ng tin c·∫≠y (trusted networks).
  - NFS truy·ªÅn th·ªëng x√°c th·ª±c d·ª±a tr√™n UID/GID, nh∆∞ng ƒë√¢y l√† c∆° ch·∫ø y·∫øu v√† d·ªÖ b·ªã l·ª£i d·ª•ng n·∫øu client-server kh√¥ng ƒë·ªìng b·ªô ho·∫∑c b·ªã gi·∫£ m·∫°o. V√¨ v·∫≠y ch·ªâ n√™n √°p d·ª•ng trong m√¥i tr∆∞·ªùng tin c·∫≠y.

Default Configuration

- The /etc/exports file contains a table of physical filesystems on an NFS server accessible by the clients. 


| T√πy ch·ªçn             | M√¥ t·∫£ (d·ªãch)                                                                                                                                                     |
| -------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **rw**               | Cho ph√©p ƒë·ªçc v√† ghi.                                                                                                                                             |
| **ro**               | Ch·ªâ cho ph√©p ƒë·ªçc (read only).                                                                                                                                    |
| **sync**             | Truy·ªÅn d·ªØ li·ªáu ƒë·ªìng b·ªô (m·ªói thay ƒë·ªïi ƒë∆∞·ª£c ghi ngay l·∫≠p t·ª©c v√†o ƒëƒ©a). An to√†n h∆°n nh∆∞ng **ch·∫≠m h∆°n**.                                                             |
| **async**            | Truy·ªÅn d·ªØ li·ªáu b·∫•t ƒë·ªìng b·ªô (ghi v√†o b·ªô nh·ªõ ƒë·ªám tr∆∞·ªõc, sau ƒë√≥ m·ªõi ghi ra ƒëƒ©a). **Nhanh h∆°n** nh∆∞ng c√≥ r·ªßi ro m·∫•t d·ªØ li·ªáu n·∫øu h·ªá th·ªëng crash.                      |
| **secure**           | Ch·ªâ cho ph√©p d√πng c√°c c·ªïng **‚â§ 1024** (c√°c c·ªïng ‚Äúƒë·∫∑c quy·ªÅn‚Äù tr√™n Unix).                                                                                          |
| **insecure**         | Cho ph√©p d√πng c√°c c·ªïng **> 1024**.                                                                                                                               |
| **no_subtree_check** | V√¥ hi·ªáu h√≥a vi·ªác ki·ªÉm tra c√¢y th∆∞ m·ª•c con (subtree check). ƒêi·ªÅu n√†y gi√∫p c·∫£i thi·ªán hi·ªáu nƒÉng khi mount m·ªôt subdirectory, nh∆∞ng c√≥ th·ªÉ gi·∫£m b·∫£o m·∫≠t.              |
| **root_squash**      | Chuy·ªÉn quy·ªÅn root (UID/GID 0) tr√™n client th√†nh **anonymous UID/GID** tr√™n server. T·ª©c l√† root t·ª´ client **kh√¥ng c√≥ quy·ªÅn root tr√™n server**, ƒë·ªÉ tr√°nh l·∫°m d·ª•ng. |



sync vs async
  sync: an to√†n ‚Üí d·ªØ li·ªáu ch·∫Øc ch·∫Øn ƒë∆∞·ª£c ghi ra disk ngay l·∫≠p t·ª©c.
  async: nhanh h∆°n nh∆∞ng nguy hi·ªÉm n·∫øu m·∫•t ƒëi·ªán ho·∫∑c crash.
  ‚Üí Trong m√¥i tr∆∞·ªùng production, th∆∞·ªùng khuy·∫øn ngh·ªã sync ƒë·ªÉ tr√°nh m·∫•t d·ªØ li·ªáu.

secure vs insecure
  secure: ch·ªâ cho ph√©p k·∫øt n·ªëi t·ª´ c·ªïng th·∫•p h∆°n 1024 ‚Üí gi·∫£m nguy c∆° b·ªã gi·∫£ m·∫°o (v√¨ ch·ªâ root m·ªõi m·ªü ƒë∆∞·ª£c port <1024).
  insecure: √≠t an to√†n h∆°n, nh∆∞ng c√≥ th·ªÉ c·∫ßn trong m·ªôt s·ªë m√¥i tr∆∞·ªùng ƒë·∫∑c bi·ªát.

root_squash (r·∫•t quan tr·ªçng trong b·∫£o m·∫≠t NFS)
  N·∫øu kh√¥ng b·∫≠t root_squash, root tr√™n client c√≥ th·ªÉ c√≥ to√†n quy·ªÅn root tr√™n server qua NFS ‚Üí c·ª±c k·ª≥ nguy hi·ªÉm.
  Do ƒë√≥, trong h·∫ßu h·∫øt tr∆∞·ªùng h·ª£p, ng∆∞·ªùi ta lu√¥n b·∫≠t root_squash ƒë·ªÉ ch·∫∑n vi·ªác n√†y.

ExportFS
  root@nfs:~# echo '/mnt/nfs  10.129.14.0/24(sync,no_subtree_check)' >> /etc/exports
  root@nfs:~# systemctl restart nfs-kernel-server 
  root@nfs:~# exportfs
  
  /mnt/nfs      	10.129.14.0/24

  Ch√∫ng t√¥i ƒë√£ chia s·∫ª th∆∞ m·ª•c /mnt/nfs v·ªõi m·∫°ng con 10.129.14.0/24 v·ªõi thi·∫øt l·∫≠p ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü tr√™n. ƒêi·ªÅu n√†y c√≥ nghƒ©a l√† t·∫•t c·∫£ c√°c m√°y ch·ªß tr√™n m·∫°ng s·∫Ω c√≥ th·ªÉ g·∫Øn k·∫øt chia s·∫ª NFS n√†y v√† ki·ªÉm tra n·ªôi dung c·ªßa th∆∞ m·ª•c n√†y.


C√°c thi·∫øt l·∫≠p nguy hi·ªÉm
  Ngay c·∫£ v·ªõi NFS, m·ªôt s·ªë thi·∫øt l·∫≠p c≈©ng c√≥ th·ªÉ nguy hi·ªÉm cho c√¥ng ty v√† h·∫° t·∫ßng. D∆∞·ªõi ƒë√¢y l√† m·ªôt s·ªë t√πy ch·ªçn:

  | T√πy ch·ªçn           | M√¥ t·∫£                                                                                                                       |
  | ------------------ | --------------------------------------------------------------------------------------------------------------------------- |
  | **rw**             | Cho ph√©p ƒë·ªçc v√† ghi.                                                                                                        |
  | **insecure**       | Cho ph√©p s·ª≠ d·ª•ng c√°c c·ªïng l·ªõn h∆°n 1024.                                                                                     |
  | **nohide**         | N·∫øu m·ªôt h·ªá th·ªëng t·ªáp kh√°c ƒë∆∞·ª£c mount b√™n d∆∞·ªõi m·ªôt th∆∞ m·ª•c ƒë√£ export, th∆∞ m·ª•c n√†y c≈©ng s·∫Ω ƒë∆∞·ª£c export th√¥ng qua entry ri√™ng. |
  | **no_root_squash** | M·ªçi file do root t·∫°o ra s·∫Ω gi·ªØ nguy√™n UID/GID = 0 (t·ª©c root t·ª´ client v·∫´n l√† root tr√™n server).                             |


  üëâ T√≥m g·ªçn:
    rw ‚Üí ai c≈©ng ghi ƒë∆∞·ª£c.
    insecure ‚Üí b·ªè c∆° ch·∫ø ch·ªâ root m·ªõi ƒë∆∞·ª£c d√πng port <1024.
    nohide ‚Üí l·ªô th√™m filesystem con.
    no_root_squash ‚Üí root client th√†nh root server ‚Üí nguy hi·ªÉm nh·∫•t.


Footprinting the Service
  naruto3co@htb[/htb]$ sudo nmap 10.129.14.128 -p111,2049 -sV -sC

  naruto3co@htb[/htb]$ sudo nmap --script nfs* 10.129.14.128 -sV -p111,2049

Show Available NFS Shares
  naruto3co@htb[/htb]$ showmount -e 10.129.14.128
  
  Export list for 10.129.14.128:
  /mnt/nfs 10.129.14.0/24

Mounting NFS Share
  naruto3co@htb[/htb]$ mkdir target-NFS
  naruto3co@htb[/htb]$ sudo mount -t nfs 10.129.14.128:/ ./target-NFS/ -o nolock
  naruto3co@htb[/htb]$ cd target-NFS
  naruto3co@htb[/htb]$ tree .
  
  .
  ‚îî‚îÄ‚îÄ mnt
      ‚îî‚îÄ‚îÄ nfs
          ‚îú‚îÄ‚îÄ id_rsa
          ‚îú‚îÄ‚îÄ id_rsa.pub
          ‚îî‚îÄ‚îÄ nfs.share
  
  2 directories, 3 files


List Contents with Usernames & Group Names
    naruto3co@htb[/htb]$ ls -l mnt/nfs/
    total 16
    -rw-r--r-- 1 cry0l1t3 cry0l1t3 1872 Sep 25 00:55 cry0l1t3.priv
    -rw-r--r-- 1 cry0l1t3 cry0l1t3  348 Sep 25 00:55 cry0l1t3.pub
    -rw-r--r-- 1 root     root     1872 Sep 19 17:27 id_rsa
    -rw-r--r-- 1 root     root      348 Sep 19 17:28 id_rsa.pub
    -rw-r--r-- 1 root     root        0 Sep 19 17:22 nfs.share


List Contents with UIDs & GUIDs

    naruto3co@htb[/htb]$ ls -n mnt/nfs/
    total 16
    -rw-r--r-- 1 1000 1000 1872 Sep 25 00:55 cry0l1t3.priv
    -rw-r--r-- 1 1000 1000  348 Sep 25 00:55 cry0l1t3.pub
    -rw-r--r-- 1    0 1000 1221 Sep 19 18:21 backup.sh
    -rw-r--r-- 1    0    0 1872 Sep 19 17:27 id_rsa
    -rw-r--r-- 1    0    0  348 Sep 19 17:28 id_rsa.pub
    -rw-r--r-- 1    0    0    0 Sep 19 17:22 nfs.share

ƒêi·ªÅu quan tr·ªçng c·∫ßn l∆∞u √Ω l√† n·∫øu t√πy ch·ªçn root_squash ƒë∆∞·ª£c ƒë·∫∑t, ch√∫ng ta kh√¥ng th·ªÉ ch·ªânh s·ª≠a t·ªáp backup.sh ngay c·∫£ khi d√πng quy·ªÅn root.
Ch√∫ng ta c≈©ng c√≥ th·ªÉ s·ª≠ d·ª•ng NFS ƒë·ªÉ n√¢ng c·∫•p th√™m. V√≠ d·ª•: n·∫øu ch√∫ng ta c√≥ quy·ªÅn truy c·∫≠p v√†o h·ªá th·ªëng qua SSH v√† mu·ªën ƒë·ªçc c√°c t·ªáp t·ª´ m·ªôt th∆∞ m·ª•c kh√°c m√† m·ªôt ng∆∞·ªùi d√πng c·ª• th·ªÉ c√≥ th·ªÉ ƒë·ªçc, ch√∫ng ta c·∫ßn t·∫£i m·ªôt shell l√™n chia s·∫ª NFS c√≥ SUID c·ªßa ng∆∞·ªùi d√πng ƒë√≥, sau ƒë√≥ ch·∫°y shell th√¥ng qua ng∆∞·ªùi d√πng SSH.
Sau khi th·ª±c hi·ªán t·∫•t c·∫£ c√°c b∆∞·ªõc c·∫ßn thi·∫øt v√† c√≥ ƒë∆∞·ª£c th√¥ng tin c·∫ßn thi·∫øt, ch√∫ng ta c√≥ th·ªÉ ng·∫Øt k·∫øt n·ªëi chia s·∫ª NFS.
                (B·∫Øt ƒë·∫ßu)
                  |
                  v
                [G·∫Øn (mount) share NFS l√™n m√°y attacker/SSH]
                  |
                  |  V√≠ d·ª•:
                  |   mkdir /tmp/target-NFS
                  |   sudo mount -t nfs 10.129.14.128:/export/path /tmp/target-NFS -o nolock
                  v
                [Ki·ªÉm tra file trong share]
                  |
                  |  Th·∫•y file: backup.sh (ch·ªß s·ªü h·ªØu: userX)
                  v
                [Ki·ªÉm tra thi·∫øt l·∫≠p root_squash tr√™n server]
                  |
                  |  - N·∫øu root_squash = enabled
                  |      -> root tr√™n client b·ªã "squash" v·ªÅ anonymous
                  |      => ngay c·∫£ root tr√™n client C≈®NG KH√îNG th·ªÉ ch·ªânh s·ª≠a backup.sh
                  |  - N·∫øu root_squash = disabled (no_root_squash)
                  |      => root tr√™n client c√≥ th·ªÉ ghi / thay ƒë·ªïi file tr√™n share
                  v
                +-----------------------------+
                | Nh√°nh A: root_squash = ON   |
                +-----------------------------+
                  | 
                  |  K·∫øt qu·∫£: Kh√¥ng th·ªÉ ch·ªânh s·ª≠a backup.sh d√π l√† root
                  |  ‚Üí c·∫ßn t√¨m vector kh√°c (v√≠ d·ª•: export kh√°c c√≥ quy·ªÅn ghi, misconfig)
                  v
                [K·∫øt th√∫c nh√°nh A]
                  ^
                  |
                +------------------------------+
                | Nh√°nh B: root_squash = OFF   |
                +------------------------------+
                  |
                  |  N·∫øu share cho ph√©p ghi b·ªüi attacker:
                  |   1) Upload 1 file th·ª±c thi nh·ªè (shell) l√™n share
                  |      (v√≠ d·ª•: scp mysuid -> /tmp/target-NFS/mysuid)
                  |   2) Thi·∫øt owner/permission ƒë·ªÉ ƒë·∫∑t bit SUID cho user m·ª•c ti√™u
                  |      (y√™u c·∫ßu kh·∫£ nƒÉng set owner ho·∫∑c gi·ªØ nguy√™n quy·ªÅn root)
                  |      VD: sudo chown target_user:target_group mysuid
                  |          sudo chmod u+s mysuid
                  |
                  v
                [Ch·∫°y ch∆∞∆°ng tr√¨nh SUID ƒë√£ upload qua SSH b·∫±ng user kh√°c]
                  |
                  |  - SSH v√†o h·ªá th·ªëng v·ªõi ssh_user (ng∆∞·ªùi c√≥ th·ªÉ ch·∫°y binary SUID)
                  |  - Ch·∫°y: /path/to/mysuid  ‚Üí ti·∫øn tr√¨nh ch·∫°y v·ªõi quy·ªÅn target_user
                  |
                  v
                [TƒÉng quy·ªÅn / ƒë·ªçc file b·ªã b·∫£o v·ªá]
                  |
                  |  - ƒê·ªçc c√°c file ch·ªâ target_user m·ªõi ƒë·ªçc ƒë∆∞·ª£c (v√≠ d·ª•: n·ªôi dung backup.sh)
                  v
                [D·ªçn d·∫πp (Cleanup)]
                  |
                  |  - X√≥a file ƒë√£ upload kh·ªèi NFS share:
                  |      rm /tmp/target-NFS/mysuid
                  |  - Unmount NFS tr√™n client:
                  |      sudo umount /tmp/target-NFS
                  |  - (T√πy ch·ªçn) x√≥a log / kh√¥i ph·ª•c n·∫øu ƒëang l√†m lab
                  v
                (K·∫øt th√∫c)










