IMAP

IMAP (Internet Message Access Protocol) cho phÃ©p truy cáº­p vÃ  quáº£n lÃ½ email trá»±c tiáº¿p trÃªn mÃ¡y chá»§.
IMAP cho phÃ©p lÃ m viá»‡c trá»±c tiáº¿p trÃªn email á»Ÿ mÃ¡y chá»§ (giá»‘ng nhÆ° truy cáº­p tá»« xa), trong khi POP3 chá»‰ táº£i vÃ  lÆ°u cá»¥c bá»™, khÃ´ng Ä‘á»“ng bá»™ thay Ä‘á»•i giá»¯a cÃ¡c thiáº¿t bá»‹.
Há»— trá»£ cáº¥u trÃºc thÆ° má»¥c vÃ  nhiá»u há»™p thÆ° trong cÃ¹ng má»™t phiÃªn lÃ m viá»‡c.
Cho phÃ©p xem, sáº¯p xáº¿p, vÃ  Ä‘á»“ng bá»™ email tá»« nhiá»u thiáº¿t bá»‹ khÃ¡c nhau mÃ  khÃ´ng máº¥t dá»¯ liá»‡u.
POP3 chá»‰ há»— trá»£ cÃ¡c chá»©c nÄƒng cÆ¡ báº£n nhÆ° liá»‡t kÃª, táº£i, vÃ  xÃ³a email, khÃ´ng cÃ³ kháº£ nÄƒng quáº£n lÃ½ trá»±c tuyáº¿n nhÆ° IMAP.

Client truy cáº­p há»™p thÆ° trá»±c tuyáº¿n vÃ  cÃ³ thá»ƒ táº¡o báº£n sao cá»¥c bá»™ cá»§a email.
Nhá» Ä‘Ã³, nhiá»u client khÃ¡c nhau váº«n cÃ³ thá»ƒ hiá»ƒn thá»‹ cÃ¹ng má»™t tráº¡ng thÃ¡i há»™p thÆ° thá»‘ng nháº¥t.
Email váº«n náº±m trÃªn mÃ¡y chá»§ cho Ä‘áº¿n khi ngÆ°á»i dÃ¹ng xÃ³a chÃºng.
IMAP lÃ  giao thá»©c dáº¡ng vÄƒn báº£n (text-based) vÃ  há»— trá»£ nhiá»u chá»©c nÄƒng má»Ÿ rá»™ng nhÆ° duyá»‡t email trá»±c tiáº¿p trÃªn server.
Nhiá»u ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ truy cáº­p cÃ¹ng lÃºc vÃ o cÃ¹ng má»™t mÃ¡y chá»§ email.
KhÃ´ng cÃ³ káº¿t ná»‘i máº¡ng, ngÆ°á»i dÃ¹ng khÃ´ng thá»ƒ quáº£n lÃ½ email.
Tuy nhiÃªn, má»™t sá»‘ client cÃ³ cháº¿ Ä‘á»™ offline, cho phÃ©p lÃ m viá»‡c vá»›i báº£n sao táº¡m thá»i; khi cÃ³ máº¡ng láº¡i, cÃ¡c thay Ä‘á»•i Ä‘Æ°á»£c Ä‘á»“ng bá»™ lÃªn server.

Client káº¿t ná»‘i Ä‘áº¿n server qua cá»•ng 143 (máº·c Ä‘á»‹nh cá»§a IMAP).
Giao tiáº¿p sá»­ dá»¥ng cÃ¡c lá»‡nh dáº¡ng vÄƒn báº£n (text-based) theo Ä‘á»‹nh dáº¡ng ASCII.
Nhiá»u lá»‡nh cÃ³ thá»ƒ gá»­i liÃªn tiáº¿p mÃ  khÃ´ng cáº§n chá» pháº£n há»“i ngay tá»« server.
Pháº£n há»“i cá»§a server sau Ä‘Ã³ sáº½ Ä‘Æ°á»£c ghÃ©p ná»‘i Ä‘Ãºng vá»›i tá»«ng lá»‡nh nhá» mÃ£ Ä‘á»‹nh danh (identifier) Ä‘i kÃ¨m.
Sau khi káº¿t ná»‘i Ä‘Æ°á»£c thiáº¿t láº­p, ngÆ°á»i dÃ¹ng pháº£i xÃ¡c thá»±c báº±ng tÃªn Ä‘Äƒng nháº­p vÃ  máº­t kháº©u.
Chá»‰ sau khi xÃ¡c thá»±c thÃ nh cÃ´ng, client má»›i cÃ³ thá»ƒ truy cáº­p vÃ o há»™p thÆ° (mailbox) mong muá»‘n.

Máº·c Ä‘á»‹nh, IMAP khÃ´ng mÃ£ hÃ³a dá»¯ liá»‡u, nÃªn toÃ n bá»™ lá»‡nh, email, tÃªn ngÆ°á»i dÃ¹ng vÃ  máº­t kháº©u Ä‘á»u Ä‘Æ°á»£c truyá»n dÆ°á»›i dáº¡ng vÄƒn báº£n thuáº§n (plain text).
Äiá»u nÃ y khiáº¿n giao tiáº¿p dá»… bá»‹ nghe lÃ©n hoáº·c Ä‘Ã¡nh cáº¯p thÃ´ng tin náº¿u khÃ´ng cÃ³ biá»‡n phÃ¡p báº£o máº­t bá»• sung.
VÃ¬ lÃ½ do an toÃ n, Ä‘a sá»‘ mÃ¡y chá»§ email yÃªu cáº§u sá»­ dá»¥ng phiÃªn IMAP Ä‘Æ°á»£c mÃ£ hÃ³a.
SSL/TLS lÃ  giao thá»©c mÃ£ hÃ³a phá»• biáº¿n nháº¥t Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ báº£o vá»‡ quÃ¡ trÃ¬nh truyá»n táº£i email.
TÃ¹y cÃ¡ch triá»ƒn khai, káº¿t ná»‘i mÃ£ hÃ³a cÃ³ thá»ƒ dÃ¹ng láº¡i cá»•ng 143 (STARTTLS) hoáº·c chuyá»ƒn sang cá»•ng 993 (IMAPS â€” IMAP Secure).

Default Configuration 

  ğŸ“¨ IMAP Commands (Lá»‡nh IMAP)
  | Lá»‡nh                          | MÃ´ táº£                                                      |
  | ----------------------------- | ---------------------------------------------------------- |
  | `LOGIN username password`     | ÄÄƒng nháº­p ngÆ°á»i dÃ¹ng.                                      |
  | `LIST "" *`                   | Liá»‡t kÃª táº¥t cáº£ cÃ¡c thÆ° má»¥c (mailbox).                      |
  | `CREATE "INBOX"`              | Táº¡o má»™t há»™p thÆ° má»›i vá»›i tÃªn Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh.                 |
  | `DELETE "INBOX"`              | XÃ³a há»™p thÆ°.                                               |
  | `RENAME "ToRead" "Important"` | Äá»•i tÃªn há»™p thÆ°.                                           |
  | `LSUB "" *`                   | Liá»‡t kÃª cÃ¡c há»™p thÆ° mÃ  ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng kÃ½ (subscribed). |
  | `SELECT INBOX`                | Chá»n há»™p thÆ° Ä‘á»ƒ truy cáº­p cÃ¡c email bÃªn trong.              |
  | `UNSELECT INBOX`              | ThoÃ¡t khá»i há»™p thÆ° Ä‘ang chá»n.                              |
  | `FETCH <ID> all`              | Truy xuáº¥t dá»¯ liá»‡u cá»§a email theo ID.                       |
  | `CLOSE`                       | XÃ³a táº¥t cáº£ email Ä‘Ã£ Ä‘Æ°á»£c gáº¯n cá» â€œDeletedâ€.                 |
  | `LOGOUT`                      | ÄÃ³ng káº¿t ná»‘i vá»›i mÃ¡y chá»§ IMAP.                             |
  
  ğŸ“¬ POP3 Commands (Lá»‡nh POP3)
  | Lá»‡nh            | MÃ´ táº£                                            |
  | --------------- | ------------------------------------------------ |
  | `USER username` | XÃ¡c Ä‘á»‹nh tÃªn ngÆ°á»i dÃ¹ng.                         |
  | `PASS password` | XÃ¡c thá»±c máº­t kháº©u cá»§a ngÆ°á»i dÃ¹ng.                |
  | `STAT`          | YÃªu cáº§u sá»‘ lÆ°á»£ng email hiá»‡n cÃ³ trÃªn server.      |
  | `LIST`          | Liá»‡t kÃª sá»‘ lÆ°á»£ng vÃ  kÃ­ch thÆ°á»›c cá»§a táº¥t cáº£ email. |
  | `RETR id`       | Táº£i email cÃ³ ID Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh.                   |
  | `DELE id`       | XÃ³a email cÃ³ ID Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh.                   |
  | `CAPA`          | Hiá»ƒn thá»‹ cÃ¡c tÃ­nh nÄƒng mÃ  server há»— trá»£.         |
  | `RSET`          | Äáº·t láº¡i tráº¡ng thÃ¡i email (há»§y thao tÃ¡c xÃ³a).     |
  | `QUIT`          | ÄÃ³ng káº¿t ná»‘i vá»›i mÃ¡y chá»§ POP3.                   |


Dangerous Settings
  
  Lá»—i cáº¥u hÃ¬nh sai cÃ³ thá»ƒ khiáº¿n lá»™ thÃ´ng tin nhÆ°: báº­t cháº¿ Ä‘á»™ debug hiá»ƒn thá»‹ lá»‡nh, hoáº·c cho phÃ©p Ä‘Äƒng nháº­p áº©n danh giá»‘ng FTP.
  Pháº§n lá»›n doanh nghiá»‡p hiá»‡n nay dÃ¹ng dá»‹ch vá»¥ email cá»§a bÃªn thá»© ba (Google, Microsoft, v.v.), nhÆ°ng má»™t sá»‘ váº«n duy trÃ¬ mÃ¡y chá»§ riÃªng Ä‘á»ƒ giá»¯ quyá»n kiá»ƒm soÃ¡t dá»¯ liá»‡u vÃ  báº£o máº­t riÃªng tÆ°.
  Quáº£n trá»‹ viÃªn dá»… máº¯c lá»—i cáº¥u hÃ¬nh, cÃ³ thá»ƒ khiáº¿n tin nháº¯n email bá»‹ truy cáº­p trÃ¡i phÃ©p, bao gá»“m thÃ´ng tin nháº¡y cáº£m hoáº·c bÃ­ máº­t.
  Má»™t sá»‘ tÃ¹y chá»n cáº¥u hÃ¬nh nguy hiá»ƒm cáº§n chÃº Ã½:
  | CÃ i Ä‘áº·t                     | MÃ´ táº£                                                                     |
  | --------------------------- | ------------------------------------------------------------------------- |
  | **auth_debug**              | Báº­t ghi log debug cho toÃ n bá»™ tiáº¿n trÃ¬nh xÃ¡c thá»±c.                        |
  | **auth_debug_passwords**    | Ghi chi tiáº¿t máº­t kháº©u Ä‘Ã£ nháº­p vÃ  phÆ°Æ¡ng thá»©c xÃ¡c thá»±c vÃ o log.            |
  | **auth_verbose**            | Ghi láº¡i cÃ¡c láº§n xÃ¡c thá»±c tháº¥t báº¡i cÃ¹ng lÃ½ do.                             |
  | **auth_verbose_passwords**  | Ghi láº¡i máº­t kháº©u trong log (cÃ³ thá»ƒ cáº¯t ngáº¯n).                             |
  | **auth_anonymous_username** | Äáº·t tÃªn ngÆ°á»i dÃ¹ng máº·c Ä‘á»‹nh khi Ä‘Äƒng nháº­p báº±ng cÆ¡ cháº¿ **ANONYMOUS SASL**. |

  â¡ï¸ TÃ³m láº¡i: náº¿u cÃ¡c tÃ¹y chá»n nÃ y bá»‹ báº­t trÃªn mÃ´i trÆ°á»ng tháº­t, attacker cÃ³ thá»ƒ:
  Xem Ä‘Æ°á»£c máº­t kháº©u hoáº·c thÃ´ng tin Ä‘Äƒng nháº­p trong log.
  ÄÄƒng nháº­p áº©n danh mÃ  khÃ´ng cáº§n tÃ i khoáº£n tháº­t.
  Theo dÃµi cÃ¡c lá»‡nh thá»±c thi trÃªn server.
  âœ… Khuyáº¿n nghá»‹: táº¯t toÃ n bá»™ cháº¿ Ä‘á»™ debug vÃ  anonymous trong mÃ´i trÆ°á»ng production; chá»‰ dÃ¹ng khi test cá»¥c bá»™.

Footprinting the Service
By default, ports 110 and 995 are used for POP3, and ports 143 and 993 are used for IMAP. The higher ports (993 and 995) use TLS/SSL to encrypt the communication between the client and server. Using Nmap, we can scan the server for these ports. The scan will return the corresponding information (as seen below) if the server uses an embedded certificate.

Nmap
  naruto3co@htb[/htb]$ sudo nmap 10.129.14.128 -sV -p110,143,993,995 -sC

cURL
  naruto3co@htb[/htb]$ curl -k 'imaps://10.129.14.128' --user user:p4ssw0rd

If we also use the verbose (-v) option, we will see how the connection is made. From this, we can see the version of TLS used for encryption, further details of the SSL certificate, and even the banner, which will often contain the version of the mail server.
  naruto3co@htb[/htb]$ curl -k 'imaps://10.129.14.128' --user cry0l1t3:1234 -v

OpenSSL - TLS Encrypted Interaction POP3
  naruto3co@htb[/htb]$ openssl s_client -connect 10.129.14.128:pop3s

OpenSSL - TLS Encrypted Interaction IMAP
  naruto3co@htb[/htb]$ openssl s_client -connect 10.129.14.128:imaps














