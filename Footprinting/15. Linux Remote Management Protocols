M·ª•c ƒë√≠ch: qu·∫£n l√Ω m√°y ch·ªß Linux t·ª´ xa khi nh√¢n vi√™n ·ªü v·ªã tr√≠ kh√°c c·∫ßn h·ªó tr·ª£.
T√¨nh hu·ªëng ƒëi·ªÉn h√¨nh: nh√¢n vi√™n ƒë·∫øn kh√°ch h√†ng g·∫∑p l·ªói kh√¥ng gi·∫£i quy·∫øt ƒë∆∞·ª£c qua ƒëi·ªán tho·∫°i.
L·ª£i √≠ch: ti·∫øt ki·ªám th·ªùi gian v√¨ kh√¥ng ph·∫£i c√≥ m·∫∑t tr·ª±c ti·∫øp t·∫°i m√°y ch·ªß.
M√¥i tr∆∞·ªùng l√†m vi·ªác gi·ªØ nguy√™n: giao di·ªán v√† m√¥i tr∆∞·ªùng tr√™n server v·∫´n gi·ªëng nh∆∞ khi tr·ª±c ti·∫øp thao t√°c.
C√°c ·ª©ng d·ª•ng/giao th·ª©c qu·∫£n l√Ω t·ª´ xa r·∫•t ph·ªï bi·∫øn tr√™n h·∫ßu h·∫øt server public.
Nh·ªØng giao th·ª©c/·ª©ng d·ª•ng n√†y l√† m·ª•c ti√™u h·∫•p d·∫´n ƒë·ªÉ t·∫•n c√¥ng (pentest) do t√≠nh ti·ªán d·ª•ng v√† s·ª± ph·ªï bi·∫øn.
R·ªßi ro b·∫£o m·∫≠t: c·∫•u h√¨nh sai c√≥ th·ªÉ cho ph√©p k·∫ª t·∫•n c√¥ng nhanh ch√≥ng chi·∫øm quy·ªÅn truy c·∫≠p v√†o h·ªá th·ªëng.
Vai tr√≤ c·ªßa pentester: c·∫ßn n·∫Øm r√µ c√°c giao th·ª©c, d·ªãch v·ª• v√† ·ª©ng d·ª•ng qu·∫£n l√Ω t·ª´ xa ƒë·ªÉ ƒë√°nh gi√° an to√†n.
H√†nh ƒë·ªông ƒë·ªÅ xu·∫•t: l√†m quen v√† ki·ªÉm tra c·∫•u h√¨nh c√°c giao th·ª©c/·ª©ng d·ª•ng qu·∫£n tr·ªã t·ª´ xa quan tr·ªçng.
K·∫øt lu·∫≠n: hi·ªÉu bi·∫øt v·ªÅ qu·∫£n l√Ω t·ª´ xa v·ª´a gi√∫p kh·∫Øc ph·ª•c s·ª± c·ªë hi·ªáu qu·∫£ v·ª´a l√† y·∫øu t·ªë then ch·ªët trong ki·ªÉm th·ª≠ b·∫£o m·∫≠t.

SSH (Secure Shell): giao th·ª©c cho ph√©p hai m√°y t√≠nh thi·∫øt l·∫≠p k·∫øt n·ªëi tr·ª±c ti·∫øp v√† m√£ h√≥a qua m·∫°ng kh√¥ng an to√†n (th∆∞·ªùng d√πng TCP port 22).
M·ª•c ƒë√≠ch b·∫£o m·∫≠t: ngƒÉn ch·∫∑n b√™n th·ª© ba nghe l√©n ho·∫∑c ƒë√°nh c·∫Øp d·ªØ li·ªáu nh·∫°y c·∫£m trong lu·ªìng truy·ªÅn.
T√πy ch·ªânh truy c·∫≠p: m√°y ch·ªß SSH c√≥ th·ªÉ ƒë∆∞·ª£c c·∫•u h√¨nh ch·ªâ cho ph√©p k·∫øt n·ªëi t·ª´ c√°c m√°y kh√°ch nh·∫•t ƒë·ªãnh.
T√≠nh t∆∞∆°ng th√≠ch:
  Ho·∫°t ƒë·ªông tr√™n h·∫ßu h·∫øt c√°c h·ªá ƒëi·ªÅu h√†nh ph·ªï bi·∫øn.
  L√† ·ª©ng d·ª•ng g·ªëc c·ªßa Unix ‚Üí c√≥ s·∫µn tr√™n Linux v√† macOS.
  C√≥ th·ªÉ d√πng tr√™n Windows n·∫øu c√†i ƒë·∫∑t ph·∫ßn m·ªÅm h·ªó tr·ª£.
OpenSSH: phi√™n b·∫£n m√£ ngu·ªìn m·ªü c·ªßa SSH, ƒë∆∞·ª£c ph√°t tri·ªÉn t·ª´ b·∫£n th∆∞∆°ng m·∫°i c·ªßa c√¥ng ty SSH Communication Security.
Hai phi√™n b·∫£n giao th·ª©c c·∫°nh tranh:
  SSH-1 (phi√™n b·∫£n c≈© h∆°n)
  SSH-2 (phi√™n b·∫£n m·ªõi h∆°n, an to√†n h∆°n).
SSH-2 (SSH version 2):
  C·∫£i thi·ªán v·ªÅ m√£ h√≥a, t·ªëc ƒë·ªô, ƒë·ªô ·ªïn ƒë·ªãnh, v√† b·∫£o m·∫≠t.
  SSH-1 d·ªÖ b·ªã t·∫•n c√¥ng MITM (Man-In-The-Middle), c√≤n SSH-2 kh·∫Øc ph·ª•c ƒë∆∞·ª£c ƒëi·ªÉm y·∫øu n√†y.

M·ª•c ti√™u: Qu·∫£n l√Ω m·ªôt m√°y ch·ªß t·ª´ xa c√≥ th·ªÉ th·ª±c hi·ªán qua d√≤ng l·ªánh (CLI) ho·∫∑c giao di·ªán ƒë·ªì h·ªça (GUI).
SSH s·ª≠ d·ª•ng ƒë·ªÉ:
  G·ª≠i l·ªánh ƒë·∫øn h·ªá th·ªëng mong mu·ªën.
  Truy·ªÅn t·ªáp gi·ªØa m√°y c·ª•c b·ªô v√† m√°y ch·ªß t·ª´ xa.
  Chuy·ªÉn ti·∫øp c·ªïng (port forwarding) ƒë·ªÉ truy c·∫≠p d·ªãch v·ª• qua k√™nh m√£ h√≥a.
Y√™u c·∫ßu: c·∫ßn k·∫øt n·ªëi qua SSH v√† x√°c th·ª±c danh t√≠nh ng∆∞·ªùi d√πng.
OpenSSH h·ªó tr·ª£ 6 ph∆∞∆°ng th·ª©c x√°c th·ª±c kh√°c nhau:
  Password authentication ‚Äì X√°c th·ª±c b·∫±ng m·∫≠t kh·∫©u.
  Public-key authentication ‚Äì X√°c th·ª±c b·∫±ng c·∫∑p kh√≥a c√¥ng khai/b√≠ m·∫≠t.
  Host-based authentication ‚Äì D·ª±a v√†o kh√≥a v√† danh t√≠nh c·ªßa m√°y ch·ªß tin c·∫≠y.
  Keyboard authentication ‚Äì X√°c th·ª±c b·∫±ng c√°ch nh·∫≠p d·ªØ li·ªáu t·ª´ b√†n ph√≠m (t·ª´ng b∆∞·ªõc).
  Challenge-response authentication ‚Äì X√°c th·ª±c b·∫±ng c√¢u h·ªèi v√† ph·∫£n h·ªìi (m√£ h√≥a).
  GSSAPI authentication ‚Äì X√°c th·ª±c qua giao th·ª©c GSSAPI (v√≠ d·ª•: Kerberos).
Ph∆∞∆°ng th·ª©c ph·ªï bi·∫øn nh·∫•t: Password v√† Public-key authentication (s·∫Ω ƒë∆∞·ª£c ph√¢n t√≠ch k·ªπ h∆°n).
Tham kh·∫£o th√™m chi ti·∫øt c·∫•u h√¨nh v√† c√°c ph∆∞∆°ng th·ª©c kh√°c t·∫°i:
üîó GoLinuxCloud ‚Äì OpenSSH authentication methods


Default Configuration
The sshd_config file, responsible for the OpenSSH server, has only a few of the settings configured by default. However, the default configuration includes X11 forwarding, which contained a command injection vulnerability in version 7.2p1 of OpenSSH in 2016. Nevertheless, we do not need a GUI to manage our servers.
    naruto3co@htb[/htb]$ cat /etc/ssh/sshd_config  | grep -v "#" | sed -r '/^\s*$/d'
      Include /etc/ssh/sshd_config.d/*.conf
      ChallengeResponseAuthentication no
      UsePAM yes
      X11Forwarding yes
      PrintMotd no
      AcceptEnv LANG LC_*
      Subsystem       sftp    /usr/lib/openssh/sftp-server
    
Dangerous Settings
Despite the SSH protocol being one of the most secure protocols available today, some misconfigurations can still make the SSH server vulnerable to easy-to-execute attacks. Let us take a look at the following settings:

  | **Setting**                  | **Description**                                         |
  | ---------------------------- | ------------------------------------------------------- |
  | `PasswordAuthentication yes` | Cho ph√©p x√°c th·ª±c b·∫±ng m·∫≠t kh·∫©u.                        |
  | `PermitEmptyPasswords yes`   | Cho ph√©p s·ª≠ d·ª•ng m·∫≠t kh·∫©u tr·ªëng.                        |
  | `PermitRootLogin yes`        | Cho ph√©p ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n **root**.              |
  | `Protocol 1`                 | S·ª≠ d·ª•ng phi√™n b·∫£n m√£ h√≥a **c≈©, kh√¥ng an to√†n**.         |
  | `X11Forwarding yes`          | Cho ph√©p **chuy·ªÉn ti·∫øp X11** ƒë·ªÉ ch·∫°y ·ª©ng d·ª•ng GUI.      |
  | `AllowTcpForwarding yes`     | Cho ph√©p **chuy·ªÉn ti·∫øp c·ªïng TCP**.                      |
  | `PermitTunnel`               | Cho ph√©p **t·∫°o ƒë∆∞·ªùng h·∫ßm (tunneling)**.                 |
  | `DebianBanner yes`           | Hi·ªÉn th·ªã **banner ƒë·∫∑c tr∆∞ng c·ªßa Debian** khi ƒëƒÉng nh·∫≠p. |

Allowing password authentication allows us to brute-force a known username for possible passwords. Many different methods can be used to guess the passwords of users. For this purpose, specific patterns are usually used to mutate the most commonly used passwords and, frighteningly, correct them. This is because we humans are lazy and do not want to remember complex and complicated passwords. Therefore, we create passwords that we can easily remember, and this leads to the fact that, for example, numbers or characters are added only at the end of the password. Believing that the password is secure, the mentioned patterns are used to guess precisely such "adjustments" of these passwords. However, some instructions and hardening guides can be used to harden our SSH servers.

Footprinting the Service

One of the tools we can use to fingerprint the SSH server is ssh-audit. It checks the client-side and server-side configuration and shows some general information and which encryption algorithms are still used by the client and server. Of course, this could be exploited by attacking the server or client at the cryptic level later.

SSH-Audit
  naruto3co@htb[/htb]$ git clone https://github.com/jtesta/ssh-audit.git && cd ssh-audit
  naruto3co@htb[/htb]$ ./ssh-audit.py 10.129.14.132
  
The first thing we can see in the first few lines of the output is the banner that reveals the version of the OpenSSH server. The previous versions had some vulnerabilities, such as CVE-2020-14145, which allowed the attacker the capability to Man-In-The-Middle and attack the initial connection attempt. The detailed output of the connection setup with the OpenSSH server can also often provide important information, such as which authentication methods the server can use.

Change Authentication Method
  naruto3co@htb[/htb]$ ssh -v cry0l1t3@10.129.14.132

For potential brute-force attacks, we can specify the authentication method with the SSH client option PreferredAuthentications.
  naruto3co@htb[/htb]$ ssh -v cry0l1t3@10.129.14.132 -o PreferredAuthentications=password

Rsync l√† c√¥ng c·ª• sao ch√©p t·ªáp nhanh v√† hi·ªáu qu·∫£, d√πng ƒë∆∞·ª£c cho c·∫£ local v√† remote host.
C√≥ th·ªÉ sao ch√©p:
  T·ªáp tr√™n c√πng m·ªôt m√°y (local).
  T·ªáp gi·ªØa m√°y c·ª•c b·ªô v√† m√°y ch·ªß t·ª´ xa.
ƒê·∫∑c ƒëi·ªÉm n·ªïi b·∫≠t: s·ª≠ d·ª•ng thu·∫≠t to√°n truy·ªÅn delta (delta-transfer algorithm).
  Gi√∫p gi·∫£m l∆∞·ª£ng d·ªØ li·ªáu truy·ªÅn qua m·∫°ng khi ƒë√≠ch ƒë√£ c√≥ phi√™n b·∫£n c≈© c·ªßa file.
  Ch·ªâ g·ª≠i ph·∫ßn kh√°c bi·ªát gi·ªØa file ngu·ªìn v√† file ƒë√≠ch.
·ª®ng d·ª•ng ph·ªï bi·∫øn: d√πng cho backup v√† mirror d·ªØ li·ªáu.
C√°ch x√°c ƒë·ªãnh file c·∫ßn truy·ªÅn: d·ª±a tr√™n thay ƒë·ªïi k√≠ch th∆∞·ªõc ho·∫∑c th·ªùi gian ch·ªânh s·ª≠a g·∫ßn nh·∫•t.
C·ªïng m·∫∑c ƒë·ªãnh: TCP 873.
B·∫£o m·∫≠t truy·ªÅn t·∫£i: c√≥ th·ªÉ c·∫•u h√¨nh ch·∫°y qua SSH (piggyback tr√™n k·∫øt n·ªëi SSH hi·ªán c√≥).
∆Øu ƒëi·ªÉm: nhanh, linh ho·∫°t, v√† ti·∫øt ki·ªám bƒÉng th√¥ng, ƒë·∫∑c bi·ªát h·ªØu √≠ch trong m√¥i tr∆∞·ªùng qu·∫£n tr·ªã h·ªá th·ªëng v√† sao l∆∞u t·ª´ xa.

Scanning for Rsync
  naruto3co@htb[/htb]$ sudo nmap -sV -p 873 127.0.0.1

Probing for Accessible Shares
  naruto3co@htb[/htb]$ nc -nv 127.0.0.1 873

Enumerating an Open Share
Here we can see a share called dev, and we can enumerate it further.
  naruto3co@htb[/htb]$ rsync -av --list-only rsync://127.0.0.1/dev

T·ª´ k·∫øt qu·∫£ ƒë·∫ßu ra ·ªü tr√™n, ch√∫ng ta c√≥ th·ªÉ th·∫•y m·ªôt v√†i t·ªáp th√∫ v·ªã c√≥ th·ªÉ ƒë√°ng ƒë·ªÉ t√¨m hi·ªÉu th√™m. Ch√∫ng ta c≈©ng c√≥ th·ªÉ th·∫•y m·ªôt th∆∞ m·ª•c c√≥ kh·∫£ nƒÉng ch·ª©a kh√≥a SSH c√≥ th·ªÉ truy c·∫≠p ƒë∆∞·ª£c. T·ª´ ƒë√¢y, ch√∫ng ta c√≥ th·ªÉ ƒë·ªìng b·ªô h√≥a t·∫•t c·∫£ c√°c t·ªáp v·ªõi m√°y ch·ªß t·∫•n c√¥ng b·∫±ng l·ªánh rsync -av rsync://127.0.0.1/dev. N·∫øu Rsync ƒë∆∞·ª£c c·∫•u h√¨nh ƒë·ªÉ s·ª≠ d·ª•ng SSH ƒë·ªÉ truy·ªÅn t·ªáp, ch√∫ng ta c√≥ th·ªÉ s·ª≠a ƒë·ªïi c√°c l·ªánh ƒë·ªÉ bao g·ªìm c·ªù -e ssh, ho·∫∑c -e "ssh -p2222" n·∫øu c·ªïng kh√¥ng chu·∫©n ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng cho SSH. H∆∞·ªõng d·∫´n n√†y h·ªØu √≠ch ƒë·ªÉ hi·ªÉu c√∫ ph√°p s·ª≠ d·ª•ng Rsync qua SSH.


R-Services

R-Services: t·∫≠p h·ª£p c√°c d·ªãch v·ª• cho ph√©p truy c·∫≠p t·ª´ xa v√† th·ª±c thi l·ªánh gi·ªØa c√°c h·ªá Unix qua TCP/IP.
Ngu·ªìn g·ªëc: ph√°t tri·ªÉn b·ªüi Computer Systems Research Group (CSRG) ‚Äî UC Berkeley.
C√°ch ho·∫°t ƒë·ªông: gi·ªëng telnet ‚Äî truy·ªÅn d·ªØ li·ªáu kh√¥ng m√£ h√≥a gi·ªØa client v√† server.
R·ªßi ro b·∫£o m·∫≠t: d·ªÖ b·ªã MITM (man-in-the-middle) ‚Äî k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ ch·∫∑n m·∫≠t kh·∫©u v√† th√¥ng tin ƒëƒÉng nh·∫≠p.
C·ªïng s·ª≠ d·ª•ng: TCP 512, 513, 514.
Giao di·ªán/ ch∆∞∆°ng tr√¨nh: truy c·∫≠p th√¥ng qua b·ªô l·ªánh g·ªçi l√† r-commands (v√≠ d·ª•: rlogin, rsh, rcp).
H·ªá ƒëi·ªÅu h√†nh th∆∞·ªùng g·∫∑p: t·ª´ng ph·ªï bi·∫øn tr√™n Unix th∆∞∆°ng m·∫°i nh∆∞ Solaris, HP-UX, AIX.
Hi·ªán tr·∫°ng: ng√†y nay ƒë√£ b·ªã thay th·∫ø b·ªüi SSH do c√°c l·ªó h·ªïng b·∫£o m·∫≠t c·ªßa r-services.
√ù nghƒ©a trong pentest: v·∫´n c√≥ th·ªÉ g·∫∑p trong m√¥i tr∆∞·ªùng c≈©/legacy ‚Äî c·∫ßn nh·∫≠n di·ªán, ph√° s√≥ng (exploit) ho·∫∑c b√°o c√°o c·∫•u h√¨nh kh√¥ng an to√†n.
H√†nh ƒë·ªông khuy·∫øn ngh·ªã: t·∫Øt r-services tr√™n host, thay b·∫±ng SSH v·ªõi c·∫•u h√¨nh b·∫£o m·∫≠t ch·∫∑t ch·∫Ω; n·∫øu b·∫Øt bu·ªôc ph·∫£i gi·ªØ, c√°ch ly m·∫°ng v√† gi√°m s√°t l∆∞u l∆∞·ª£ng.

The R-commands suite consists of the following programs:
  rcp (remote copy)
  rexec (remote execution)
  rlogin (remote login)
  rsh (remote shell)
  rstat
  ruptime
  rwho (remote who)


M·ªói l·ªánh ƒë·ªÅu c√≥ ch·ª©c nƒÉng ri√™ng; tuy nhi√™n, ch√∫ng t√¥i s·∫Ω ch·ªâ ƒë·ªÅ c·∫≠p ƒë·∫øn nh·ªØng l·ªánh r-command th∆∞·ªùng b·ªã l·∫°m d·ª•ng nh·∫•t. B·∫£ng d∆∞·ªõi ƒë√¢y s·∫Ω cung c·∫•p t·ªïng quan nhanh v·ªÅ c√°c l·ªánh b·ªã l·∫°m d·ª•ng th∆∞·ªùng xuy√™n nh·∫•t, bao g·ªìm d·ªãch v·ª• daemon m√† ch√∫ng t∆∞∆°ng t√°c, c·ªïng v√† ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn m√† ch√∫ng c√≥ th·ªÉ ƒë∆∞·ª£c truy c·∫≠p, v√† m√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ t·ª´ng l·ªánh.
| **Command** | **Service daemon** | **Port** | **Transport protocol** | **Description**                                                                                                                                                      |
| ----------- | ------------------ | -------: | ---------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `rcp`       | `rshd`             |      514 | TCP                    | Sao ch√©p t·ªáp ho·∫∑c th∆∞ m·ª•c hai chi·ªÅu gi·ªØa m√°y local v√† m√°y remote (ho·∫∑c gi·ªØa hai m√°y remote). Ho·∫°t ƒë·ªông gi·ªëng `cp` nh∆∞ng **kh√¥ng c·∫£nh b√°o khi ghi ƒë√®**.               |
| `rsh`       | `rshd`             |      514 | TCP                    | M·ªü m·ªôt shell tr√™n m√°y t·ª´ xa **kh√¥ng qua qu√° tr√¨nh ƒëƒÉng nh·∫≠p**. D·ª±a v√†o c√°c m·ª•c tin c·∫≠y trong ` /etc/hosts.equiv` v√† `~/.rhosts` ƒë·ªÉ x√°c th·ª±c.                         |
| `rexec`     | `rexecd`           |      512 | TCP                    | Cho ph√©p ch·∫°y l·ªánh shell tr√™n m√°y t·ª´ xa b·∫±ng username v√† password g·ª≠i **kh√¥ng m√£ h√≥a** qua socket. X√°c th·ª±c c√≥ th·ªÉ b·ªã ghi ƒë√® b·ªüi ` /etc/hosts.equiv` v√† `~/.rhosts`. |
| `rlogin`    | `rlogind`          |      513 | TCP                    | Cho ph√©p ƒëƒÉng nh·∫≠p v√†o host t·ª´ xa (t∆∞∆°ng t·ª± `telnet`, ch·ªâ cho Unix-like). X√°c th·ª±c c√≥ th·ªÉ b·ªã ghi ƒë√® b·ªüi ` /etc/hosts.equiv` v√† `~/.rhosts`.                          |


The /etc/hosts.equiv file contains a list of trusted hosts and is used to grant access to other systems on the network. When users on one of these hosts attempt to access the system, they are automatically granted access without further authentication.

/etc/hosts.equiv
  naruto3co@htb[/htb]$ cat /etc/hosts.equiv
  
  # <hostname> <local username>
  pwnbox cry0l1t3


Scanning for R-Services
    naruto3co@htb[/htb]$ sudo nmap -sV -p 512,513,514 10.0.17.2
      Starting Nmap 7.80 ( https://nmap.org ) at 2022-12-02 15:02 EST
      Nmap scan report for 10.0.17.2
      Host is up (0.11s latency).
      PORT    STATE SERVICE    VERSION
      512/tcp open  exec?
      513/tcp open  login?
      514/tcp open  tcpwrapped

Th√¥i ph·∫ßn n·∫øu g·∫∑p case n√†y t·ª± chatgpt ƒëi , nh√¨n mu·ªën l√†m bi·∫øng qu√° 




