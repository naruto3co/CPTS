# Access Control List (ACL) Abuse Primer – Notes

## 1. Tổng quan

* **ACL (Access Control List)**: danh sách quy định *ai* được làm *gì* với object trong Active Directory (user, group, computer, OU…).
* **ACE (Access Control Entry)**: từng dòng quyền cụ thể trong ACL, gán cho user/group (security principal).
* ACL cấu hình sai → **lỗ hổng bảo mật nghiêm trọng**, khó phát hiện, tồn tại lâu dài.

## 2. Các loại ACL

### DACL (Discretionary Access Control List)

* Quyết định **cho phép / từ chối** truy cập.
* Không có DACL → mọi user có full quyền.
* Có DACL nhưng không có ACE hợp lệ → từ chối toàn bộ.

### SACL (System Access Control List)

* Dùng để **audit / log** truy cập.
* Không cấp quyền, chỉ ghi nhận hành vi.

## 3. Các loại ACE

* **Access Allowed ACE**: cho phép quyền.
* **Access Denied ACE**: từ chối quyền.
* **System Audit ACE**: ghi log truy cập (SACL).

### Cấu trúc một ACE

1. Security Principal (SID / user / group)
2. ACE type (Allow / Deny / Audit)
3. Inheritance (kế thừa xuống object con hay không)
4. Access Mask (quyền cụ thể)

> ACL được check từ **trên xuống**, gặp Deny trước là dừng.

## 4. Vì sao ACE nguy hiểm

* Attacker có thể abuse ACE để:

  * Leo thang đặc quyền
  * Di chuyển ngang (lateral movement)
  * Duy trì quyền truy cập (persistence)
* Không bị phát hiện bởi vulnerability scanner.
* Rất hay gặp trong môi trường AD lớn / legacy.

## 5. Các ACE thường bị lạm dụng

### ForceChangePassword

* Reset password user khác **không cần biết mật khẩu cũ**.
* Nguy hiểm, mang tính destructive.

### GenericWrite

* Ghi thuộc tính object.
* Abuse:

  * Gán SPN cho user → **Kerberoasting**
  * Thêm user vào group (tùy object)

### GenericAll

* **Toàn quyền object**.
* Abuse:

  * Reset password
  * Thêm group member
  * Kerberoasting
  * Nếu trên computer + LAPS → đọc local admin password

### WriteOwner

* Thay đổi owner object → từ đó chiếm thêm quyền.

### WriteDACL

* Sửa ACL → **tự cấp quyền cho chính mình**.

### AddSelf

* Cho phép user **tự add mình vào group**.

### AllExtendedRights

* Tập quyền mở rộng (reset password, add group…).

## 6. Công cụ thường dùng

* **BloodHound**: visualize quan hệ quyền, tìm đường attack.
* **PowerView**:

  * Enumerate ACL
  * Abuse ACE (Set-DomainUserPassword, Add-DomainGroupMember, Add-DomainObjectACL…)

## 7. ACL Attacks dùng để làm gì

* Privilege Escalation
* Lateral Movement
* Persistence

## 8. Các kịch bản phổ biến ngoài thực tế

* Helpdesk có quyền reset password → chiếm account privileged.
* User có quyền quản lý group → add mình vào nhóm mạnh.
* Quyền dư thừa do:

  * Cài Exchange
  * Legacy config
  * Cấu hình “cho tiện”

## 9. Lưu ý khi pentest

* Nhiều ACL attack mang tính **destructive**.
* Cần:

  * Xin phép khách hàng
  * Ghi chép đầy đủ
  * Revert lại toàn bộ thay đổi

---

## Key takeaway

> **ACL / ACE misconfiguration = “An ACE in the Hole”**
> → Con bài tẩy giúp attacker chiếm domain mà không cần exploit truyền thống.






# SharpHound & BloodHound – Ghi chú thực hành (thực tế)

## 1. Tổng quan vai trò
- **SharpHound.exe**: tool *thu thập dữ liệu* từ Active Directory (collector)
- **BloodHound.exe**: tool *phân tích & vẽ attack graph* từ dữ liệu SharpHound

> SharpHound đọc AD thay bạn. BloodHound vẽ đường tấn công thay bạn.

---

## 2. Chạy SharpHound.exe (thu thập dữ liệu)

### Vị trí file
Ví dụ:
```
C:\Tools\SharpHound.exe
```

### Cách chạy đúng (PowerShell)
```
cd C:\Tools
.\SharpHound.exe -c All
```




# ACL Abuse – Quick Map (Cheat Sheet)

<img width="1734" height="821" alt="image" src="https://github.com/user-attachments/assets/0444423e-328e-4251-a574-dc5cbcc139f4" />



> Bảng dịch nhanh từ **ACL → Kỹ thuật tấn công → Mức độ nguy hiểm**

---

## 1. WriteDACL
**Ý nghĩa**
- Sửa ACL của object
- Tự cấp quyền cho chính mình

**Hậu quả**
- Có thể biến thành **GenericAll / DCSync / bất kỳ quyền nào**

**Nhớ nhanh**
> WriteDACL = toàn quyền gián tiếp

---

## 2. GenericAll
**Ý nghĩa**
- Toàn quyền object

**Có thể làm**
- Reset password
- Add group member
- Read LAPS / gMSA
- DCSync (nếu áp lên domain)

**Nhớ nhanh**
> GenericAll = object này là của mình

---

## 3. GenericWrite
**Ý nghĩa**
- Ghi thuộc tính object

**Có thể abuse**
- SPN-Jacking → Kerberoasting
- Shadow Credentials
- Kerberos RBCD
- Evil GPO / Logon Script
- AddSelf (tự add group)

**Nhớ nhanh**
> GenericWrite = ghi sai 1 thuộc tính là leo thang

---

## 4. AllExtendedRights
**Ý nghĩa**
- Quyền đặc biệt mở rộng

**Có thể làm**
- ForceChangePassword
- Read LAPS password
- Read gMSA password
- DCSync

**Nhớ nhanh**
> AllExtendedRights = nhiều quyền nguy hiểm gộp lại

---

## 5. WriteOwner
**Ý nghĩa**
- Chiếm ownership object

**Hậu quả**
- Sau khi là owner → sửa ACL → quay về WriteDACL

**Nhớ nhanh**
> WriteOwner → WriteDACL → GenericAll

---

## 6. Thứ tự mức độ nguy hiểm (dễ nhớ)
```
WriteDACL
  > GenericAll
    > GenericWrite
      > AllExtendedRights
        > WriteOwner
```

---

## 7. Khi dùng với BloodHound
1. BloodHound báo **quyền gì**
2. Tra bảng này → biết **đánh kiểu nào**
3. Chọn kỹ thuật **ít ồn nhất**

---

## Key takeaway
> ACL không phải quyền tĩnh  
> mà là **cửa dẫn tới kỹ thuật tấn công**

