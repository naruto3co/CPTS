# Introduction to Active Directory Enumeration & Attacks

## 1. Active Directory (AD) l√† g√¨?
- **Active Directory (AD)** l√† h·ªá th·ªëng **qu·∫£n l√Ω t·∫≠p trung** cho m√¥i tr∆∞·ªùng doanh nghi·ªáp Windows.
- Ra ƒë·ªùi t·ª´ **Windows Server 2000**.
- D·ª±a tr√™n c√°c giao th·ª©c:
  - LDAP
  - x.500
- C√≥ c·∫•u tr√∫c:
  - Ph√¢n t√°n (Distributed)
  - Ph√¢n c·∫•p (Hierarchical)

### AD qu·∫£n l√Ω:
- Users
- Computers
- Groups
- Network devices
- File shares
- Group Policies (GPO)
- Trusts gi·ªØa c√°c domain

### Ch·ª©c nƒÉng ch√≠nh:
- Authentication (x√°c th·ª±c)
- Authorization (ph√¢n quy·ªÅn)
- Accounting / Auditing (ghi log, theo d√µi)

---

## 2. V√¨ sao Active Directory quan tr·ªçng v·ªõi b·∫£o m·∫≠t?
- ~**43% doanh nghi·ªáp** s·ª≠ d·ª•ng Active Directory.
- AD ng√†y c√†ng **k·∫øt h·ª£p v·ªõi Azure AD** ‚Üí h·ªá th·ªëng ph·ª©c t·∫°p h∆°n.
- Trong 2 nƒÉm g·∫ßn ƒë√¢y:
  - **>2000 CVE** li√™n quan ƒë·∫øn Microsoft.
- AD ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ:
  - D·ªÖ truy c·∫≠p
  - D·ªÖ chia s·∫ª th√¥ng tin

üëâ ƒêi·ªÅu n√†y khi·∫øn AD:
- Kh√≥ harden ho√†n to√†n
- D·ªÖ d√≠nh l·ªói c·∫•u h√¨nh (misconfiguration)

---

## 3. R·ªßi ro b·∫£o m·∫≠t trong Active Directory
- Ph√¢n quy·ªÅn sai
- Service c·∫•u h√¨nh y·∫øu
- Trust kh√¥ng c·∫ßn thi·∫øt
- User s·ª≠ d·ª•ng m·∫≠t kh·∫©u y·∫øu
- OS ho·∫∑c d·ªãch v·ª• ch∆∞a v√° l·ªói

üëâ K·∫øt h·ª£p c√°c y·∫øu t·ªë tr√™n:
- Attacker c√≥ th·ªÉ **leo thang quy·ªÅn nhanh ch√≥ng**
- D·∫´n ƒë·∫øn **Domain Compromise**

---

## 4. M·ª•c ti√™u khi t·∫•n c√¥ng Active Directory
- Kh√¥ng c·∫ßn exploit remote (web/app).
- Ch·ªâ c·∫ßn ƒë√£ ·ªü **b√™n trong domain**.

### M·ª•c ti√™u c√≥ th·ªÉ l√†:
- Truy c·∫≠p m√°y c·ª• th·ªÉ
- Truy c·∫≠p email ng∆∞·ªùi d√πng
- Truy c·∫≠p database
- Ho·∫∑c:
  - Domain Admin
  - Full Domain Compromise

### Ph∆∞∆°ng ph√°p:
- Lateral Movement (di chuy·ªÉn ngang)
- Privilege Escalation (leo thang quy·ªÅn)

---

## 5. Active Directory Enumeration & Attacks
### Enumeration (Thu th·∫≠p th√¥ng tin):
- Users
- Groups
- Permissions / ACL
- Service Accounts
- SPN


### Scenario 1 - Waiting On An Admin

During this engagement, I compromised a single host and gained SYSTEM level access. Because this was a domain-joined host, I was able to use this access to enumerate the domain. I went through all of the standard enumeration, but did not find much. There were Service Principal Names (SPNs) present within the environment, and I was able to perform a Kerberoasting attack and retrieve TGS tickets for a few accounts. I attempted to crack these with Hashcat and some of my standard wordlists and rules, but was unsuccessful at first. I ended up leaving a cracking job running overnight with a very large wordlist combined with the d3ad0ne rule that ships with Hashcat. The next morning I had a hit on one ticket and retrieved the cleartext password for a user account. This account did not give me significant access, but it did give me write access on certain file shares. I used this access to drop SCF files around the shares and left Responder going. After a while, I got a single hit, the NetNTLMv2 hash of a user. I checked through the BloodHound output and noticed that this user was actually a domain admin! Easy day from here.
https://github.com/hashcat/hashcat/blob/master/rules/d3ad0ne.rule


### Scenario 2 - Spraying The Night Away

Password spraying can be an extremely effective way to gain a foothold in a domain, but we must exercise great care not to lock out user accounts in the process. On one engagement, I found an SMB NULL session using the enum4linux tool and retrieved both a listing of all users from the domain, and the domain password policy. Knowing the password policy was crucial because I could ensure that I was staying within the parameters to not lock out any accounts and also knew that the policy was a minimum eight-character password and password complexity was enforced (meaning that a user's password required 3/4 of special character, number, uppercase, or lower case number, i.e., Welcome1). I tried several common weak passwords such as Welcome1, Password1, Password123, Spring2018, etc. but did not get any hits. Finally, I made an attempt with Spring@18 and got a hit! Using this account, I ran BloodHound and found several hosts where this user had local admin access. I noticed that a domain admin account had an active session on one of these hosts. I was able to use the Rubeus tool and extract the Kerberos TGT ticket for this domain user. From there, I was able to perform a pass-the-ticket attack and authenticate as this domain admin user. As a bonus, I was able to take over the trusting domain as well because the Domain Administrators group for the domain that I took over was a part of the Administrators group in the trusting domain via nested group membership, meaning I could use the same set of credentials to authenticate to the other domain with full administrative level access.
https://github.com/CiscoCXSecurity/enum4linux


### Scenario 3 - Fighting In The Dark

I had tried all of my standard ways to obtain a foothold on this third engagement, and nothing had worked. I decided that I would use the Kerbrute tool to attempt to enumerate valid usernames and then, if I found any, attempt a targeted password spraying attack since I did not know the password policy and didn't want to lock any accounts out. I used the linkedin2username tool to first mashup potential usernames from the company's LinkedIn page. I combined this list with several username lists from the statistically-likely-usernames GitHub repo and, after using the userenum feature of Kerbrute, ended up with 516 valid users. I knew I had to tread carefully with password spraying, so I tried with the password Welcome2021 and got a single hit! Using this account, I ran the Python version of BloodHound from my attack host and found that all domain users had RDP access to a single box. I logged into this host and used the PowerShell tool DomainPasswordSpray to spray again. I was more confident this time around because I could a) view the password policy and b) the DomainPasswordSpray tool will remove accounts close to lockout from the target list. Being that I was authenticated within the domain, I could now spray with all domain users, which gave me significantly more targets. I tried again with the common password Fall2021 and got several hits, all for users not in my initial wordlist. I checked the rights for each of these accounts and found that one was in the Help Desk group, which had GenericAll rights over the Enterprise Key Admins group. The Enterprise Key Admins group had GenericAll privileges over a domain controller, so I added the account I controlled to this group, authenticated again, and inherited these privileges. Using these rights, I performed the Shadow Credentials attack and retrieved the NT hash for the domain controller machine account. With this NT hash, I was then able to perform a DCSync attack and retrieve the NTLM password hashes for all users in the domain because a domain controller can perform replication, which is required for DCSync.
https://github.com/ropnop/kerbrute
https://github.com/initstring/linkedin2username
https://github.com/insidetrust/statistically-likely-usernames
https://github.com/dafthack/DomainPasswordSpray
https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#genericall
https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups#enterprise-key-admins
https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab

### This Is The Way
These scenarios may seem overwhelming with many foreign concepts right now, but after completing this module, you will be familiar with most of them (some concepts described in these scenarios are outside the scope of this module). These show the importance of iterative enumeration, understanding our target, and adapting and thinking outside the box as we work our way through an environment. We will perform many of the parts of the attack chains described above in these module sections, and then you'll get to put your skills to the test by attacking two different AD environments at the end of this module and discovering your own attack chains. Strap in because this will be a fun, but bumpy, ride through the wild world that is enumerating and attacking Active Directory.

### Practical Examples
Throughout the module, we will cover examples with accompanying command output. Most of which can be reproduced on the target VMs that can be spawned within the relevant sections. You will be provided RDP credentials to interact with some of the target VMs to learn how to enumerate and attack from a Windows host (MS01) and SSH access to a preconfigured Parrot Linux host (ATTACK01) to perform enumeration and attack examples from Linux. You can connect from the Pwnbox or your own VM (after downloading a VPN key once a machine spawns) via RDP using FreeRDP, Remmina, or the RDP client of your choice where applicable or the SSH client built into the Pwnbox or your own VM.


### Connecting via FreeRDP
We can connect via command line using the command:
```
naruto3co@htb[/htb]$ xfreerdp /v:<MS01 target IP> /u:htb-student /p:Academy_student_AD!
```

Connecting via SSH
We can connect to the provided Parrot Linux attack host using the command, then enter the provided password when prompted.
```
naruto3co@htb[/htb]$ ssh htb-student@<ATTACK01 target IP>
```

### Xfreerdp to the ATTACK01 Parrot Host
We also installed an XRDP server on the ATTACK01 host to provide GUI access to the Parrot attack host. This can be used to interact with the BloodHound GUI tool which we will cover later in this section. In sections where this host spawns (where you are given SSH access) you can also connect to it using xfreerdp using the same command as you would with the Windows attack host above:
```
naruto3co@htb[/htb]$ xfreerdp /v:<ATTACK01 target IP> /u:htb-student /p:HTB_@cademy_stdnt!
```

Most sections will provide credentials for the htb-student user on either MS01 or ATTACK01. Depending on the material and challenges, some sections will have you authenticate to a target with a different user, and alternate credentials will be provided.

### Toolkit
We provide a Windows and Parrot Linux attack host in the accompanying lab for this module. All tools needed to perform all examples and solve all questions throughout the module sections are present on the hosts. The tools necessary for the Windows attack host, MS01 are located in the C:\Tools directory. Others, such as the Active Directory PowerShell module, will load upon opening a PowerShell console window. Tools on the Linux attack host, ATTACK01, are either installed and added to the htb-student users' PATH or present in the /opt directory. You can, of course, (and it is encouraged) compile (where needed) and upload your own tools and scripts to the attack hosts to get in the habit of doing so or hosting them on an SMB share from the Pwnbox working with the tools that way. Keep in mind that when performing an actual penetration test in a client's network, it is always best to compile the tools yourself to examine the code beforehand and ensure there is nothing malicious hiding in the compiled executable. We don't want to bring infected tools into a client's network and expose them to an outside attack.

Have fun, and don't forget to think outside of the box! AD is immense. You will not master it overnight, but keep working at it, and soon the content in this module will be second nature.














